NEWMAP_JS_LIB={VERSION:"4.2.1.4",VERSIONTIME:"2014-5-13",NEWMAP_LIB_URL:function(){var a=document.getElementsByTagName("script"),b=/\/?NewMap.js\??/,c,d,e,f;for(c=0,d=a.length;c<d;c++){e=a[c].src,f=e.match(b);if(f)return path=e.split(b)[0],path?path+"/":""}return""}()},NEWMAP_JS_LIB.NEWMAP_LIB_IMAGE_URL=NEWMAP_JS_LIB.NEWMAP_LIB_URL+"NewMapJSRes/",NUtil={extend:function(a){var b=Array.prototype.slice.call(arguments,1);for(var c=0,d=b.length,e;c<d;c++){e=b[c]||{};for(var f in e)e.hasOwnProperty&&e.hasOwnProperty(f)&&(a[f]=e[f])}return a},applyDefaults:function(a,b){a=a||{};var c=typeof window.Event=="function"&&b instanceof window.Event;for(var d in b)if(a[d]===undefined||!c&&b.hasOwnProperty&&b.hasOwnProperty(d)&&!a.hasOwnProperty(d))a[d]=b[d];return!c&&b&&b.hasOwnProperty&&b.hasOwnProperty("toString")&&!a.hasOwnProperty("toString")&&(a.toString=b.toString),a},bind:function(a,b){var c=arguments.length>2?Array.prototype.slice.call(arguments,2):null;return function(){return a.apply(b,c||arguments)}},tryFuncs:function(){var a=null;for(var b=0,c=arguments.length;b<c;b++){var d=arguments[b];try{a=d();break}catch(e){}}return a},getParameterString:function(a){var b=[];for(var c in a){var d=a[c];if(d!=null&&typeof d!="function"){var e;if(typeof d=="object"&&d.constructor==Array){var f=[],g;for(var h=0,i=d.length;h<i;h++)g=d[h],f.push(encodeURIComponent(g===null||g===undefined?"":g));e=f.join(",")}else e=encodeURIComponent(d);b.push(encodeURIComponent(c)+"="+e)}}return b.join("&")},containsStr:function(a,b){return a.indexOf(b)!=-1},getParameters:function(a){a=a===null||a===undefined?window.location.href:a;var b="";if(NUtil.containsStr(a,"?")){var c=a.indexOf("?")+1,d=NUtil.containsStr(a,"#")?a.indexOf("#"):a.length;b=a.substring(c,d)}var e={},f=b.split(/[&;]/);for(var g=0,h=f.length;g<h;++g){var i=f[g].split("=");if(i[0]){var j=i[0];try{j=decodeURIComponent(j)}catch(k){j=unescape(j)}var l=(i[1]||"").replace(/\+/g," ");try{l=decodeURIComponent(l)}catch(k){l=unescape(l)}l=l.split(","),l.length==1&&(l=l[0]),e[j]=l}}return e},urlAppend:function(a,b){var c=a;if(b){var d=(a+" ").split(/[?&]/);c+=d.pop()===" "?b:d.length?"&"+b:"?"+b}return c},upperCaseObject:function(a){var b={};for(var c in a)b[c.toUpperCase()]=a[c];return b},createUrlObject:function(a,b){b=b||{};if(!/^\w+:\/\//.test(a)){var c=window.location,d=c.port?":"+c.port:"",e=c.protocol+"//"+c.host.split(":").shift()+d;if(a.indexOf("/")===0)a=e+a;else{var f=c.pathname.split("/");f.pop(),a=e+f.join("/")+"/"+a}}b.ignoreCase&&(a=a.toLowerCase());var g=document.createElement("a");g.href=a;var h={};h.host=g.host.split(":").shift(),h.protocol=g.protocol,b.ignorePort80?h.port=g.port=="80"||g.port=="0"?"":g.port:h.port=g.port==""||g.port=="0"?"80":g.port,h.hash=b.ignoreHash||g.hash==="#"?"":g.hash;var i=g.search;if(!i){var j=a.indexOf("?");i=j!=-1?a.substr(j):""}return h.args=NUtil.getParameters(i),h.pathname=g.pathname.charAt(0)=="/"?g.pathname:"/"+g.pathname,h},stamp:function(){var a=0,b="_newmap_id";return function(c){return c[b]=c[b]||"_newmap_id_"+ ++a,c[b]}}(),limitExecByInterval:function(a,b,c){function g(){d=!1,e&&(f.callee.apply(c,f),e=!1)}var d,e,f;return function(){f=arguments,d?e=!0:(d=!0,setTimeout(g,b),a.apply(c,f))}},normalizeScale:function(a){var b=a>1?1/a:a;return b},getSuiteIndex:function(a,b,c){if(!b||!b.length)return-1;c&&b.sort(function(a,b){return b-a});var d,e,f,g=0,h=b.length,i=null;for(d=0;d<h;d++){e=b[d],f=Math.abs(e-a);if(d==0){i=f,g=d;continue}if(f>i)break;i=f,g=d}return g},formatNum:function(a,b){var c=Math.pow(10,b||5);return Math.round(a*c)/c},getParamString:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c+"="+a[c]);return"?"+b.join("&")},template:function(a,b){return a.replace(/\{ *([\w_]+) *\}/g,function(a,c){var d=b[c];if(!b.hasOwnProperty(c))throw new Error("No value provided for variable "+a);return d})},setOptions:function(a,b,c){return a.options=NUtil.extend({},a.options,b),c&&NUtil.extend(a,a.options),a.options},falseFn:function(){return!1},getTime:Date.now||function(){return+(new Date)},checkInArray:function(a,b){if(!b)return!1;var c,d=b.length;for(c=0;c<d;c++)if(b[c]==a)return!0;return!1},Browser:function(){var a=navigator.userAgent.toLowerCase(),b=!!window.ActiveXObject,c=b&&!window.XMLHttpRequest,d=b&&!document.querySelector,e=a.indexOf("webkit")!==-1,f=a.indexOf("safari")!==-1,g=a.indexOf("firefox")!==-1,h=typeof orientation!=undefined+"",i=a.indexOf("chrome")!==-1,j=a.indexOf("android")!==-1,k=a.search("android [23]")!==-1,l=window.navigator&&window.navigator.msPointerEnabled&&window.navigator.msMaxTouchPoints,m="devicePixelRatio"in window&&window.devicePixelRatio>1||"matchMedia"in window&&window.matchMedia("(min-resolution:144dpi)")&&window.matchMedia("(min-resolution:144dpi)").matches,n=document.documentElement,o=b&&"transition"in n.style,p="WebKitCSSMatrix"in window&&"m11"in new window.WebKitCSSMatrix,q="MozPerspective"in n.style,r="OTransition"in n.style,s=window.opera,t=!window.L_DISABLE_3D&&(o||p||q||r),u=!window.L_NO_TOUCH&&function(){var a="ontouchstart";if(l||a in n)return!0;var b=document.createElement("div"),c=!1;return b.setAttribute?(b.setAttribute(a,"return;"),typeof b[a]=="function"&&(c=!0),b.removeAttribute(a),b=null,c):!1}(),v=!!document.createElementNS&&!!document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect,w=!v&&function(){try{var a=document.createElement("div");a.innerHTML='<v:shape adj="1"/>';var b=a.firstChild;return b.style.behavior="url(#default#VML)",b&&typeof b.adj=="object"}catch(c){return!1}}();return{ie:b,ie6:c,ie7:d,webkit:e,android:j,android23:k,chrome:i,opera:s,safari:f,firefox:g,ie3d:o,webkit3d:p,gecko3d:q,opera3d:r,any3d:t,mobile:h,mobileWebkit:h&&e,mobileWebkit3d:h&&p,mobileOpera:h&&!!window.opera,touch:u,msTouch:l,canvas:function(){return!!document.createElement("canvas").getContext}(),svg:v,vml:w}}(),INCHES_PER_UNIT:{inches:1,"in":1,ft:12,mi:63360,m:39.3701,km:39370.1,dd:4382659,degrees:4382659,yd:36,nmi:72913.4252},DOTS_PER_INCH:96,MaxBgTileCount:30,getFitDist:function(a,b,c){return b=b.toLowerCase(),c=c.toLowerCase(),NUtil.INCHES_PER_UNIT[b]&&NUtil.INCHES_PER_UNIT[c]?a*NUtil.INCHES_PER_UNIT[b]/NUtil.INCHES_PER_UNIT[c]:a},get:function(a){return typeof a=="string"?document.getElementById(a):a},getDistByUnits:function(a,b,c,d){var e=0;return c=c||"m",d=d||"m",!!a&&!!b&&a instanceof NXY&&b instanceof NXY?(c=c.toLowerCase(),c=="dd"||c=="degrees"?(e=NUtil._distanceByLnglat(a.x,a.y,b.x,b.y),e=NUtil.getFitDist(e,"m",d)):(e=a.distanceTo(b),e=NUtil.getFitDist(e,c,d))):e=0,e},_distanceByLnglat:function(a,b,c,d){var e=NUtil._Rad(b),f=NUtil._Rad(d),g=e-f,h=NUtil._Rad(a)-NUtil._Rad(c),i=2*Math.asin(Math.sqrt(Math.pow(Math.sin(g/2),2)+Math.cos(e)*Math.cos(f)*Math.pow(Math.sin(h/2),2)));return i*=6378137,i=Math.round(i*1e4)/1e4,i},_Rad:function(a){return a*Math.PI/180},getAreaByUnits:function(a,b,c){if(!a)return 0;c=c||"km";var d=0;b&&(b=b.toLowerCase());var e=a.length;if(e<3)return d;var f=[],g=[];for(var h=0;h<e;h++){var i=a[h];i&&(f.push(i.x),g.push(i.y))}for(var h=0;h<e-1;){if(f[h]==f[h+1]&&g[h]==g[h+1]){f.splice(h,1),g.splice(h,1),e--;continue}h++}if(b=="degrees"||b=="dd"){var j=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0,B=0,C=0,D=0,E=0,F=0,G=0,H=0,I=0,J=0,K=0,L=0,M=0,N=0,O=0,P=0,Q=6378137;for(var h=0;h<e;h++)h==0?(j=f[e-1]*Math.PI/180,k=g[e-1]*Math.PI/180,l=f[0]*Math.PI/180,m=g[0]*Math.PI/180,n=f[1]*Math.PI/180,o=g[1]*Math.PI/180):h==e-1?(j=f[e-2]*Math.PI/180,k=g[e-2]*Math.PI/180,l=f[e-1]*Math.PI/180,m=g[e-1]*Math.PI/180,n=f[0]*Math.PI/180,o=g[0]*Math.PI/180):(j=f[h-1]*Math.PI/180,k=g[h-1]*Math.PI/180,l=f[h]*Math.PI/180,m=g[h]*Math.PI/180,n=f[h+1]*Math.PI/180,o=g[h+1]*Math.PI/180),p=Math.cos(m)*Math.cos(l),q=Math.cos(m)*Math.sin(l),r=Math.sin(m),s=Math.cos(k)*Math.cos(j),t=Math.cos(k)*Math.sin(j),u=Math.sin(k),v=Math.cos(o)*Math.cos(n),w=Math.cos(o)*Math.sin(n),x=Math.sin(o),y=(p*p+q*q+r*r)/(p*s+q*t+r*u),z=(p*p+q*q+r*r)/(p*v+q*w+r*x),A=y*s-p,B=y*t-q,C=y*u-r,D=z*v-p,E=z*w-q,F=z*x-r,K=(D*A+E*B+F*C)/(Math.sqrt(D*D+E*E+F*F)*Math.sqrt(A*A+B*B+C*C)),K=Math.acos(K),G=E*C-F*B,H=0-(D*C-F*A),I=D*B-E*A,p!=0?J=G/p:q!=0?J=H/q:J=I/r,J>0?(L+=K,O++):(M+=K,N++);L>M?P=L+(2*Math.PI*N-M):P=2*Math.PI*O-L+M,d=(P-(e-2)*Math.PI)*Q*Q,b="m"}else{var R,S,T=0,U=f[0],V=g[0],W=f[1],X=g[1],Y=U;W-=Y;for(var h=1;h<e;h++)S=V,U=W,V=X,W=f[h],X=g[h],W-=Y,T+=U*(X-S);d=-T/2}var Z=NUtil.INCHES_PER_UNIT[b];return d*=Math.pow(Z/NUtil.INCHES_PER_UNIT[c],2),d},getStyle:function(a,b){var c=a.style[b];!c&&a.currentStyle&&(c=a.currentStyle[b]);if(!c||c==="auto"){var d=document.defaultView.getComputedStyle(a,null);c=d?d[b]:null}return c==="auto"?null:c},getViewportOffset:function(a){var b=0,c=0,d=a,e=document.body;do{b+=d.offsetTop||0,c+=d.offsetLeft||0;if(d.offsetParent===e&&NUtil.getStyle(d,"position")==="absolute")break;d=d.offsetParent}while(d);d=a;do{if(d===e)break;b-=d.scrollTop||0,c-=d.scrollLeft||0,d=d.parentNode}while(d);return new NXY(c,b)},create:function(a,b,c){var d=document.createElement(a);return b&&(d.className=b),c&&c.appendChild(d),d},disableTextSelection:function(){document.selection&&document.selection.empty&&document.selection.empty(),this._onselectstart||(this._onselectstart=document.onselectstart,document.onselectstart=NUtil.falseFn)},enableTextSelection:function(){document.onselectstart=this._onselectstart,this._onselectstart=null},hasClass:function(a,b){return a&&a.className&&a.className.length>0&&(new RegExp("(^|\\s)"+b+"(\\s|$)")).test(a.className)},setClass:function(a,b){a&&b&&(a.className=b)},addClass:function(a,b){NUtil.hasClass(a,b)||(a.className+=(a.className?" ":"")+b)},removeClass:function(a,b){if(!a||!a.className)return;var c=a.className.replace(/(\S+)\s*/g,function(a,c){return c===b?"":a}).replace(/^\s+/,"");c=c.replace(b,""),c=c.replace(/^\s+|\s+$/g,""),a.className=c},setOpacity:function(a,b){NUtil.Browser.ie?a.style.filter="alpha(opacity="+Math.round(b*100)+")":a.style.opacity=b},testProp:function(a){var b=document.documentElement.style;for(var c=0;c<a.length;c++)if(a[c]in b)return a[c];return!1},getTranslateString:function(a){var b=NUtil.Browser.webkit3d,c="translate"+(b?"3d":"")+"(",d=(b?",0":"")+")";return c+a.x+"px,"+a.y+"px"+d},getScaleString:function(a,b){var c=NUtil.getTranslateString(b.add(b.multiplyBy(-1*a))),d=" scale("+a+") ";return c+d},setPosition:function(a,b,c,d){if(!a)return;d||(a._newmap_pos=b);if(!c&&NUtil.Browser.any3d)a.style[NUtil.TRANSFORM]=NUtil.getTranslateString(b),NUtil.Browser.mobileWebkit3d&&(a.style["-webkit-backface-visibility"]="hidden");else{if(isNaN(b.x)||isNaN(b.y))return;a.style.left=b.x+"px",a.style.top=b.y+"px"}},getPosition:function(a,b){if(!a)return null;var c=a._newmap_pos||null;if(b)if(a.style[NUtil.TRANSFORM]){var d=a.style[NUtil.TRANSFORM];if(d){var e=NUtil.TRANSLATE_OPEN.length,f=d.length-NUtil.TRANSLATE_CLOSE.length-e,g=d.substr(e,f),h=g.indexOf(",");if(h!==-1){var i=g.substr(0,h),j=g.substr(h+1,g.length-h-1);c=c||new NXY,c.x=parseInt(i),c.y=parseInt(j)}}}else c=c||new NXY,c.x=parseInt(a.style.left),c.y=parseInt(a.style.top);return c},getBezierPos:function(a,b){var c={ease:[.25,.1,.25,1],linear:[0,0,1,1],"ease-in":[.42,0,1,1],"ease-out":[0,0,.58,1],"ease-in-out":[.42,0,.58,1],"ease-t":[0,0,.58,1]},d=c[b]||c.ease;this._p1=new NXY(0,0),this._p2=new NXY(d[0],d[1]),this._p3=new NXY(d[2],d[3]),this._p4=new NXY(1,1);var e=Math.pow(1-a,3),f=3*Math.pow(1-a,2)*a,g=3*(1-a)*Math.pow(a,2),h=Math.pow(a,3),i=this._p1.multiplyBy(e),j=this._p2.multiplyBy(f),k=this._p3.multiplyBy(g),l=this._p4.multiplyBy(h);return i.add(j).add(k).add(l).y},clearAllNode:function(a){if(a){while(a.firstChild){var b=a.removeChild(a.firstChild);b=null}a.empty=!0,a.innerHTML=""}},defaultImageUrl:"data:image/gif;base64,R0lGODlhAQABAPcAAP//////zP//mf//Zv//M///AP/M///MzP/Mmf/MZv/MM//MAP+Z//+ZzP+Zmf+ZZv+ZM/+ZAP9m//9mzP9mmf9mZv9mM/9mAP8z//8zzP8zmf8zZv8zM/8zAP8A//8AzP8Amf8AZv8AM/8AAMz//8z/zMz/mcz/Zsz/M8z/AMzM/8zMzMzMmczMZszMM8zMAMyZ/8yZzMyZmcyZZsyZM8yZAMxm/8xmzMxmmcxmZsxmM8xmAMwz/8wzzMwzmcwzZswzM8wzAMwA/8wAzMwAmcwAZswAM8wAAJn//5n/zJn/mZn/Zpn/M5n/AJnM/5nMzJnMmZnMZpnMM5nMAJmZ/5mZzJmZmZmZZpmZM5mZAJlm/5lmzJlmmZlmZplmM5lmAJkz/5kzzJkzmZkzZpkzM5kzAJkA/5kAzJkAmZkAZpkAM5kAAGb//2b/zGb/mWb/Zmb/M2b/AGbM/2bMzGbMmWbMZmbMM2bMAGaZ/2aZzGaZmWaZZmaZM2aZAGZm/2ZmzGZmmWZmZmZmM2ZmAGYz/2YzzGYzmWYzZmYzM2YzAGYA/2YAzGYAmWYAZmYAM2YAADP//zP/zDP/mTP/ZjP/MzP/ADPM/zPMzDPMmTPMZjPMMzPMADOZ/zOZzDOZmTOZZjOZMzOZADNm/zNmzDNmmTNmZjNmMzNmADMz/zMzzDMzmTMzZjMzMzMzADMA/zMAzDMAmTMAZjMAMzMAAAD//wD/zAD/mQD/ZgD/MwD/AADM/wDMzADMmQDMZgDMMwDMAACZ/wCZzACZmQCZZgCZMwCZAABm/wBmzABmmQBmZgBmMwBmAAAz/wAzzAAzmQAzZgAzMwAzAAAA/wAAzAAAmQAAZgAAMwAAAP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAANgALAAAAAABAAEAAAgEALEFBAA7"},NUtil.TRANSITION=NUtil.testProp(["transition","webkitTransition","OTransition","MozTransition","msTransition"]),NUtil.ISTRANSITIONVALID=!!NUtil.TRANSITION,NUtil.TRANSFORM=NUtil.testProp(["WebkitTransform","OTransform","MozTransform","msTransform","transform"]),NUtil.TRANSITION_END=NUtil.TRANSITION==="webkitTransition"||NUtil.TRANSITION==="MozTransform"||NUtil.TRANSITION==="OTransition"?NUtil.TRANSITION+"End":"transitionend",NUtil.TRANSLATE_OPEN="translate"+(NUtil.Browser.webkit3d?"3d(":"("),NUtil.TRANSLATE_CLOSE=NUtil.Browser.webkit3d?",0)":")",NUtil.LineUtil={simplify:function(a,b){if(!b||!a.length)return a.slice();var c=b*b;return a=this._reducePoints(a,c),a=this._simplifyDP(a,c),a},pointToSegmentDistance:function(a,b,c){return Math.sqrt(this._sqClosestPointOnSegment(a,b,c,!0))},closestPointOnSegment:function(a,b,c){return this._sqClosestPointOnSegment(a,b,c)},_simplifyDP:function(a,b){var c=a.length,d=typeof Uint8Array!==undefined?Uint8Array:Array,e=new d(c);e[0]=e[c-1]=1,this._simplifyDPStep(a,e,b,0,c-1);var f,g=[];for(f=0;f<c;f++)e[f]&&g.push(a[f]);return g},_simplifyDPStep:function(a,b,c,d,e){var f=0,g,h,i;for(h=d+1;h<=e-1;h++)i=this._sqClosestPointOnSegment(a[h],a[d],a[e],!0),i>f&&(g=h,f=i);f>c&&(b[g]=1,this._simplifyDPStep(a,b,c,d,g),this._simplifyDPStep(a,b,c,g,e))},_reducePoints:function(a,b){var c=[a[0]];for(var d=1,e=0,f=a.length;d<f;d++)this._sqDist(a[d],a[e])>b&&(c.push(a[d]),e=d);return e<f-1&&c.push(a[f-1]),c},clipSegment:function(a,b,c,d){var e=c.getLowerPoint(),f=c.getUpperPoint(),g=d?this._lastCode:this._getBitCode(a,c),h=this._getBitCode(b,c);this._lastCode=h;for(;;){if(!(g|h))return[a,b];if(g&h)return!1;var i=g||h,j=this._getEdgeIntersection(a,b,i,c),k=this._getBitCode(j,c);i===g?(a=j,g=k):(b=j,h=k)}},_getEdgeIntersection:function(a,b,c,d){var e=b.x-a.x,f=b.y-a.y,g=d.getLowerPoint(),h=d.getUpperPoint();if(c&8)return new NXY(a.x+e*(h.y-a.y)/f,h.y);if(c&4)return new NXY(a.x+e*(g.y-a.y)/f,g.y);if(c&2)return new NXY(h.x,a.y+f*(h.x-a.x)/e);if(c&1)return new NXY(g.x,a.y+f*(g.x-a.x)/e)},_getBitCode:function(a,b){var c=0;return a.x<b.minX?c|=1:a.x>b.maxX&&(c|=2),a.y<b.minY?c|=4:a.y>b.maxY&&(c|=8),c},_sqDist:function(a,b){var c=b.x-a.x,d=b.y-a.y;return c*c+d*d},_sqClosestPointOnSegment:function(a,b,c,d){var e=b.x,f=b.y,g=c.x-e,h=c.y-f,i=g*g+h*h,j;return i>0&&(j=((a.x-e)*g+(a.y-f)*h)/i,j>1?(e=c.x,f=c.y):j>0&&(e+=g*j,f+=h*j)),g=a.x-e,h=a.y-f,d?g*g+h*h:new NXY(e,f)}},NUtil.PolyUtil={},NUtil.PolyUtil.clipPolygon=function(a,b){var c=b.getLowerPoint(),d=b.getUpperPoint(),e,f=[1,4,2,8],g,h,i,j,k,l,m,n,o=NUtil.LineUtil;for(g=0,l=a.length;g<l;g++)a[g]._code=o._getBitCode(a[g],b);for(i=0;i<4;i++){m=f[i],e=[];for(g=0,l=a.length,h=l-1;g<l;h=g++)j=a[g],k=a[h],j._code&m?k._code&m||(n=o._getEdgeIntersection(k,j,m,b),n._code=o._getBitCode(n,b),e.push(n)):(k._code&m&&(n=o._getEdgeIntersection(k,j,m,b),n._code=o._getBitCode(n,b),e.push(n)),e.push(j));a=e}return a},NUtil.DDPrjs=["EPSG:4326","EPSG:4610","EPSG:4490"],NUtil.MaxZIndex=999999,NClass=function(){},NClass.extend=function(a){var b=function(){this.initialize&&(this.initialize.apply(this,arguments),NUtil.stamp(this)),this._initHooks&&this.callInitHooks()},c=function(){};c.prototype=this.prototype;var d=new c;d.constructor=b,b.prototype=d,b.superclass=this.prototype;for(var e in this)this.hasOwnProperty(e)&&e!=="prototype"&&e!=="superclass"&&(b[e]=this[e]);a.statics&&(NUtil.extend(b,a.statics),delete a.statics),a.includes&&(NUtil.extend.apply(null,[d].concat(a.includes)),delete a.includes),a.options&&d.options&&(a.options=NUtil.extend({},d.options,a.options)),NUtil.extend(d,a),NUtil.extend(d,a.options),b.extend=NClass.extend,d._initHooks=[];var f=this;return d.callInitHooks=function(){if(this._initHooksCalled)return;f.prototype.callInitHooks&&f.prototype.callInitHooks.call(this),this._initHooksCalled=!0;for(var a=0,b=d._initHooks.length;a<b;a++)d._initHooks[a].call(this)},b},NClass.include=function(a){NUtil.extend(this.prototype,a)},NClass.mergeOptions=function(a){NUtil.extend(this.prototype.options,a)},NClass.addInitHook=function(a){var b=Array.prototype.slice.call(arguments,1),c=typeof a=="function"?a:function(){this[a].apply(this,b)};this.prototype._initHooks=this.prototype._initHooks||[],this.prototype._initHooks.push(c)},NEvent={_touchstart:NUtil.Browser.msTouch?"MSPointerDown":"touchstart",_touchend:NUtil.Browser.msTouch?"MSPointerUp":"touchend",_touchmove:NUtil.Browser.msTouch?"MSPointerMove":"touchmove",addDoubleTapListener:function(a,b,c){function l(a){var b;NUtil.Browser.msTouch?(k.push(a.pointerId),b=k.length):b=a.touches.length;if(b>1)return;var c=Date.now(),h=c-(d||c);g=a.touches?a.touches[0]:a,e=h>0&&h<=f,d=c}function m(a){if(NUtil.Browser.msTouch){var c=k.indexOf(a.pointerId);if(c===-1)return;k.splice(c,1)}if(e){if(NUtil.Browser.msTouch){var f={},h;for(var i in g)h=g[i],typeof h=="function"?f[i]=h.bind(g):f[i]=h;g=f}g.type="dblclick",b(g),d=null}}var d,e=!1,f=250,g,h="_newmap_",i=this._touchstart,j=this._touchend,k=[];a[h+i+c]=l,a[h+j+c]=m;var n=NUtil.Browser.msTouch?document.documentElement:a;return a.addEventListener(i,l,!1),n.addEventListener(j,m,!1),NUtil.Browser.msTouch&&n.addEventListener("MSPointerCancel",m,!1),this},addListener:function(a,b,c,d){var e=NUtil.stamp(c),f="_newmap_"+b+e;if(a[f])return this;var g=function(b){return c.call(d||a,b||NEvent._getEvent())};if(NUtil.Browser.touch&&b==="dblclick"&&this.addDoubleTapListener&&!1)this.addDoubleTapListener(a,g,e);else if("addEventListener"in a){if(!(!NUtil.Browser.android||b!="click"&&b!="mousedown"&&b!="mouseup"&&b!="mousemove"&&b!="mouseenter"&&b!="mouseleave"&&b!="mouseout"&&b!="mouseover")){var h=g,i=b;if(b=="click"||b=="mousedown")i=this._touchstart;else if(b=="mouseup")i=this._touchend;else{if(b=="mousemove")return this;if(b=="mouseover"||b=="mouseenter"||b=="mouseleave"||b=="mouseout")return this}return g=function(b){return function(c){if(!NEvent._checkMouse(a,c))return;var d=c.touches&&c.touches[0]?c.touches[0]:c;return d.type=b,h(d)}}(b),a.addEventListener(i,g,!1),a[f]=g,this}if(b==="mousewheel")a.addEventListener("DOMMouseScroll",g,!1),a.addEventListener(b,g,!1);else if(b==="mouseenter"||b==="mouseleave"){var h=g,i=b==="mouseenter"?"mouseover":"mouseout";g=function(b){if(!NEvent._checkMouse(a,b))return;return h(b)},a.addEventListener(i,g,!1)}else a.addEventListener(b,g,!1)}else"attachEvent"in a&&a.attachEvent("on"+b,g);return a[f]=g,this},removeListener:function(a,b,c){var d=NUtil.stamp(c),e="_newmap_"+b+d,f=a[e];if(!f)return this;if(NUtil.Browser.touch&&b==="dblclick"&&this.removeDoubleTapListener&&!1)this.removeDoubleTapListener(a,d);else if("removeEventListener"in a){if(!(!NUtil.Browser.android||b!="click"&&b!="mousedown"&&b!="mouseup"&&b!="mousemove"&&b!="mouseenter"&&b!="mouseleave"&&b!="mouseout"&&b!="mouseover")){var g=b;if(b=="mousedown")g=this._touchstart;else if(b=="click"||b=="mouseup")g=this._touchend;else if(b=="mousemove")g=this._touchmove;else if(b=="mouseover"||b=="mouseenter"||b=="mouseleave"||b=="mouseout")return a[e]=null,this;return a.removeEventListener(g,f,!1),a[e]=null,this}b==="mousewheel"?(a.removeEventListener("DOMMouseScroll",f,!1),a.removeEventListener(b,f,!1)):b==="mouseenter"||b==="mouseleave"?a.removeEventListener(b==="mouseenter"?"mouseover":"mouseout",f,!1):a.removeEventListener(b,f,!1)}else"detachEvent"in a&&a.detachEvent("on"+b,f);return a[e]=null,this},_checkMouse:function(a,b){var c=b.relatedTarget;if(!c)return!0;try{while(c&&c!==a)c=c.parentNode}catch(d){return!1}return c!==a},_getEvent:function(){var a=window.event;if(!a){var b=arguments.callee.caller;while(b){a=b.arguments[0];if(a&&window.Event===a.constructor)break;b=b.caller}}return a},stopPropagation:function(a){return a.stopPropagation?a.stopPropagation():a.cancelBubble=!0,this},disableClickPropagation:function(a){NEvent.addListener(a,NUtil.Browser.touch?"touchstart":"mousedown",NEvent.stopPropagation),NEvent.addListener(a,"click",NEvent.stopPropagation),NEvent.addListener(a,"dblclick",NEvent.stopPropagation)},preventDefault:function(a){return a.preventDefault?a.preventDefault():a.returnValue=!1,this},stop:function(a){NEvent.preventDefault(a).stopPropagation(a)},getMousePosition:function(a,b){var c=a.pageX?a.pageX:a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,d=a.pageY?a.pageY:a.clientY+document.body.scrollTop+document.documentElement.scrollTop,e=new NXY(c,d);return b?e.subtract(NUtil.getViewportOffset(b)):e},getWheelDelta:function(a){var b=0;return a.wheelDelta&&(b=a.wheelDelta/120),a.detail&&(b=-a.detail/3),b}},NEWMAP_JS_LIB.PublicParts={},NEWMAP_JS_LIB.PublicParts.Events={on:function(a,b,c){var d=this._newmap_events=this._newmap_events||{};d[a]=d[a]||[];var e={action:b,context:c||this},f=!1;for(var g in d[a])d[a].hasOwnProperty(g)&&d[a][g]&&d[a][g].action==e.action&&d[a][g].context==e.context&&(f=!0);return f||d[a].push({action:b,context:c||this}),this},has:function(a){var b="_newmap_events";return b in this&&a in this[b]&&this[b][a].length>0},off:function(a,b,c){if(!this.has(a))return this;for(var d=0,e=this._newmap_events,f=e[a].length;d<f;d++)if(e[a][d].action===b&&(!c||e[a][d].context===c))return e[a].splice(d,1),this;return this},fire:function(a,b){if(!this.has(a))return this;var c=NUtil.extend({type:a,target:this},b),d=this._newmap_events[a].slice();for(var e=0,f=d.length;e<f;e++)d[e].action.call(d[e].context||this,c);return this}},NClass=NClass.extend({getId:function(){return NUtil.stamp(this)}}),NXY=NClass.extend({x:null,y:null,initialize:function(a,b){this.x=a,this.y=b,this.x=this.x!==undefined&&this.x!==null?parseFloat(this.x):0,this.y=this.y!==undefined&&this.y!==null?parseFloat(this.y):0},add:function(a){return this.clone()._add(a)},_add:function(a){return this.x+=a.x,this.y+=a.y,this},subtract:function(a){return this.clone()._subtract(a)},equals:function(a){return a?this.x===a.x&&this.y===a.y:!1},_subtract:function(a){return this.x-=a.x,this.y-=a.y,this},divideBy:function(a,b){return new NXY(this.x/a,this.y/a,b)},multiplyBy:function(a){return new NXY(this.x*a,this.y*a)},distanceTo:function(a){var b=a.x-this.x,c=a.y-this.y;return Math.sqrt(b*b+c*c)},round:function(){return this.clone()._round()},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},clone:function(){return new NXY(this.x,this.y)},toString:function(){return"Point("+NUtil.formatNum(this.x)+", "+NUtil.formatNum(this.y)+")"}}),NBounds=NClass.extend({initialize:function(a,b,c,d){a&&a instanceof NXY&&b&&b instanceof NXY?(this.minX=a.x>b.x?b.x:a.x,this.minY=a.y>b.y?b.y:a.y,this.maxX=a.x<b.x?b.x:a.x,this.maxY=a.y<b.y?b.y:a.y):(this.minX=a>c?c:a,this.minY=b<d?b:d,this.maxX=a>c?a:c,this.maxY=b>d?b:d),this.minX=parseFloat(this.minX),this.maxY=parseFloat(this.maxY),this.minY=parseFloat(this.minY),this.maxX=parseFloat(this.maxX)},extend:function(a){if(!a)return;var b=null;a instanceof NXY?b=new NBounds(a.x,a.y,a.x,a.y):a instanceof NBounds&&(b=a),this.minX=this.minX==undefined?b.minX:Math.min(b.minX,this.minX),this.maxX=this.maxX==undefined?b.maxX:Math.max(b.maxX,this.maxX),this.minY=this.minY==undefined?b.minY:Math.min(b.minY,this.minY),this.maxY=this.maxY==undefined?b.maxY:Math.max(b.maxY,this.maxY)},exportToString:function(a){var b;return a?b=this.minY+","+this.minX+","+this.maxY+","+this.maxX:b=this.minX+","+this.minY+","+this.maxX+","+this.maxY,b},extendByBounds:function(a){if(!a||!(a instanceof NBounds))return;this.extend(new NXY(a.minX,a.minY)),this.extend(new NXY(a.maxX,a.maxY))},getCenter:function(a){var b=new NXY((this.minX+this.maxX)/2,(this.minY+this.maxY)/2);return a&&(b.x=Math.round(b.x),b.y=Math.round(b.y)),b},contains:function(a){var b,c,d,e;return a instanceof NBounds?(b=a.minX,c=a.maxX,d=a.minY,e=a.maxY):a instanceof NXY&&(b=c=a.x,d=e=a.y),b>=this.minX&&c<=this.maxX&&d>=this.minY&&e<=this.maxY},getLowerPoint:function(){return new NXY(this.minX,this.minY)},getUpperPoint:function(){return new NXY(this.maxX,this.maxY)},getWidth:function(){return this.maxX-this.minX},getHeight:function(){return this.maxY-this.minY},intersects:function(a){if(!!a&&a instanceof NBounds){var b=a.maxX>=this.minX&&a.minX<=this.maxX,c=a.maxY>=this.minY&&a.minY<=this.maxY;return b&&c}return!1}}),NProjection=NClass.extend({initialize:function(a,b){this.srsCode=a,NUtil.setOptions(this,b)},getSrsCode:function(){return this.srsCode},getAxisOrder:function(){var a={"EPSG:900913":!0,"EPSG:3857":!0,"CRS:84":!0,'GEOGCS["WGS_2000",DATUM["WGS_2000",SPHEROID["WGS_2000",6378137,298.257221101]],PRIMEM["GREENWICH",0],UNIT["DEGREE",0.0174532925199433]]':!0,'GEOGCS["CGCS2000",DATUM["D_CGCS2000",SPHEROID["CGCS2000",6378137,298.257221101]],PRIMEM["GREENWICH",0],UNIT["DEGREE",0.0174532925199433]]':!0},b=this.getSrsCode().toUpperCase();return!a.hasOwnProperty(b)},getUnits:function(){var a="m";for(var b=0;b<NUtil.DDPrjs.length;b++)NUtil.DDPrjs[b]&&NUtil.DDPrjs[b].toLowerCase()==this.srsCode.toLowerCase()&&(a="dd");return a}}),NRequest={DEFAULT_CONFIG:{method:"GET",url:window.location.href,async:!0,user:undefined,password:undefined,params:null,proxy:undefined,headers:{},data:null,callback:function(){},success:null,failure:null,scope:null},URL_SPLIT_REGEX:/([^:]*:)\/\/([^:]*:?[^@]*@)?([^:\/\?]*):?([^\/\?]*)/,issue:function(a){var b=this.DEFAULT_CONFIG;a=NUtil.applyDefaults(a,b);var c=new NRequest.XMLHttpRequest,d=NUtil.urlAppend(a.url,NUtil.getParameterString(a.params||{})),e=d.indexOf("http")!=0,f=!e&&d.match(this.URL_SPLIT_REGEX);if(f){var g=window.location;e=f[1]==g.protocol&&f[3]==g.hostname;var h=f[4],i=g.port;if(h!=80&&h!=""||i!="80"&&i!="")e=e&&h==i}e||a.proxy&&(typeof a.proxy=="function"?d=a.proxy(d):d=a.proxy+encodeURIComponent(d)),c.open(a.method,d,a.async,a.user,a.password);for(var j in a.headers)c.setRequestHeader(j,a.headers[j]);var k=this;return c.onreadystatechange=function(){c.readyState==NRequest.XMLHttpRequest.DONE&&k.runCallbacks({request:c,config:a,requestUrl:d})},a.async===!1?c.send(a.data):window.setTimeout(function(){c.readyState!==0&&c.send(a.data)},0),c},runCallbacks:function(a){var b=a.request,c=a.config,d=c.scope?NUtil.bind(c.callback,c.scope):c.callback,e;c.success&&(e=c.scope?NUtil.bind(c.success,c.scope):c.success);var f;c.failure&&(f=c.scope?NUtil.bind(c.failure,c.scope):c.failure),NUtil.createUrlObject(c.url).protocol=="file:"&&b.responseText&&(b.status=200),d(b),(!b.status||b.status>=200&&b.status<300)&&e&&e(b),b.status&&(b.status<200||b.status>=300)&&f&&f(b)},GET:function(a){if(typeof a.callback!="string")return a=NUtil.extend(a,{method:"GET"}),NRequest.issue(a);var b=document.createElement("script");b.charset="utf-8",b.type="text/javascript";var c=a.url;a.callback?b.src=c+"&callback="+a.callback:b.src=c,document.body.appendChild(b)},POST:function(a){return a=NUtil.extend(a,{method:"POST"}),a.headers=a.headers?a.headers:{},"CONTENT-TYPE"in NUtil.upperCaseObject(a.headers)||(a.headers["Content-Type"]="application/xml"),NRequest.issue(a)},PUT:function(a){return a=NUtil.extend(a,{method:"PUT"}),a.headers=a.headers?a.headers:{},"CONTENT-TYPE"in NUtil.upperCaseObject(a.headers)||(a.headers["Content-Type"]="application/xml"),NRequest.issue(a)},DELETE:function(a){return a=NUtil.extend(a,{method:"DELETE"}),NRequest.issue(a)},HEAD:function(a){return a=NUtil.extend(a,{method:"HEAD"}),NRequest.issue(a)},OPTIONS:function(a){return a=NUtil.extend(a,{method:"OPTIONS"}),NRequest.issue(a)}},NRequestOptions={url:null,async:!0,user:null,password:null,params:null,headers:null,data:null,callback:null,success:null,failure:null,scope:null},NTransition=NClass.extend({includes:NEWMAP_JS_LIB.PublicParts.Events,statics:{CUSTOM_PROPS_SETTERS:{position:NUtil.setPosition}},options:{easing:"ease",duration:.5},_setProperty:function(a,b){var c=NTransition.CUSTOM_PROPS_SETTERS;a in c?c[a](this._el,b):this._el.style[a]=b}}),NTransition=NTransition.extend({statics:function(){var a=NUtil.TRANSITION,b=NUtil.TRANSITION_END;return{TRANSITION:a,PROPERTY:a+"Property",DURATION:a+"Duration",EASING:a+"TimingFunction",END:b,CUSTOM_PROPS_PROPERTIES:{position:NUtil.TRANSFORM?NUtil.TRANSFORM:"top, left"}}}(),options:{fakeStepInterval:100},initialize:function(a,b){this._el=a,NUtil.setOptions(this,b),NEvent.addListener(a,NTransition.END,this._onTransitionEnd,this),this._onFakeStep=NUtil.bind(this._onFakeStep,this)},run:function(a){var b,c=[],d=NTransition.CUSTOM_PROPS_PROPERTIES;for(b in a)a.hasOwnProperty(b)&&(b=d[b]?d[b]:b,b=this._dasherize(b),c.push(b));this._el.style[NTransition.DURATION]=this.options.duration+"s",this._el.style[NTransition.EASING]=this.options.easing,this._el.style[NTransition.PROPERTY]=c.join(", ");for(b in a)a.hasOwnProperty(b)&&this._setProperty(b,a[b]);this._inProgress=!0,this.fire("start"),NUtil.ISTRANSITIONVALID?(clearInterval(this._timer),this._timer=setInterval(this._onFakeStep,this.options.fakeStepInterval)):this._onTransitionEnd()},_dasherize:function(){function a(a){return"-"+a.toLowerCase()}return function(b){return b.replace(/([A-Z])/g,a)}}(),_onFakeStep:function(){this.fire("step")},_onTransitionEnd:function(a){this._inProgress&&(this._inProgress=!1,clearInterval(this._timer),this._el.style[NTransition.PROPERTY]="none",this.fire("step"),a&&a.type&&this.fire("end"))}}),NTransition=NUtil.ISTRANSITIONVALID?NTransition:NTransition.extend({statics:{TIMER:!0,EASINGS:{ease:[.25,.1,.25,1],linear:[0,0,1,1],"ease-in":[.42,0,1,1],"ease-out":[0,0,.58,1],"ease-in-out":[.42,0,.58,1],"ease-t":[0,.3,.68,1]},CUSTOM_PROPS_GETTERS:{position:NUtil.getPosition}},options:{fps:50},initialize:function(a,b){this._el=a,NUtil.extend(this.options,b);var c=NTransition.EASINGS[this.options.easing]||NTransition.EASINGS.ease;this._p1=new NXY(0,0),this._p2=new NXY(c[0],c[1]),this._p3=new NXY(c[2],c[3]),this._p4=new NXY(1,1),this._step=NUtil.bind(this._step,this),this._interval=Math.round(1e3/this.options.fps)},run:function(a){this._props={};var b=NTransition.CUSTOM_PROPS_GETTERS;this._inProgress=!0,this.fire("start");for(var c in a)if(a.hasOwnProperty(c)){var d={};if(c in b)d.from=b[c](this._el);else{var e=this._el.style[c].match(/^[\d\.]+(\D*)$/);d.from=parseFloat(e[0]),d.unit=e[1]}d.to=a[c],this._props[c]=d}clearInterval(this._timer),this._timer=setInterval(this._step,this._interval),this._startTime=NUtil.getTime()},_step:function(){var a=NUtil.getTime(),b=a-this._startTime,c=this.options.duration*1e3;b<c?this._runFrame(this._cubicBezier(b/c)):(this._runFrame(1),this._complete())},_runFrame:function(a){var b=NTransition.CUSTOM_PROPS_SETTERS,c,d,e;for(c in this._props)this._props.hasOwnProperty(c)&&(d=this._props[c],c in b?(e=d.to.subtract(d.from).multiplyBy(a).add(d.from),b[c](this._el,e)):this._el.style[c]=(d.to-d.from)*a+d.from+d.unit);this.fire("step")},_complete:function(){clearInterval(this._timer),this.fire("end")},_onTransitionEnd:function(a){this._inProgress&&(this._inProgress=!1,this._complete())},_cubicBezier:function(a){var b=Math.pow(1-a,3),c=3*Math.pow(1-a,2)*a,d=3*(1-a)*Math.pow(a,2),e=Math.pow(a,3),f=this._p1.multiplyBy(b),g=this._p2.multiplyBy(c),h=this._p3.multiplyBy(d),i=this._p4.multiplyBy(e);return f.add(g).add(h).add(i).y}}),function(){function e(){this._object=a&&!d?new a:new window.ActiveXObject("Microsoft.XMLHTTP"),this._listeners=[]}function f(){return new e}function g(a){a._object.send(a._data);if(b&&!a._async){a.readyState=f.OPENED,j(a);while(a.readyState<f.DONE){a.readyState++,h(a);if(a._aborted)return}}}function h(a){f.onreadystatechange&&f.onreadystatechange.apply(a),a.dispatchEvent({type:"readystatechange",bubbles:!1,cancelable:!1,timeStamp:new Date+0})}function i(a){var b=a.responseXML,d=a.responseText;c&&d&&b&&!b.documentElement&&a.getResponseHeader("Content-Type").match(/[^\/]+\/[^\+]+\+xml/)&&(b=new window.ActiveXObject("Microsoft.XMLDOM"),b.async=!1,b.validateOnParse=!1,b.loadXML(d));if(b)if(c&&b.parseError!=0||!b.documentElement||b.documentElement&&b.documentElement.tagName=="parsererror")return null;return b}function j(a){try{a.responseText=a._object.responseText}catch(b){}try{a.responseXML=i(a._object)}catch(b){}try{a.status=a._object.status}catch(b){}try{
a.statusText=a._object.statusText}catch(b){}}function k(a){a._object.onreadystatechange=new window.Function}var a=window.XMLHttpRequest,b=!!window.controllers,c=window.document.all&&!window.opera,d=c&&window.navigator.userAgent.match(/MSIE 7.0/);f.prototype=e.prototype,b&&a.wrapped&&(f.wrapped=a.wrapped),f.UNSENT=0,f.OPENED=1,f.HEADERS_RECEIVED=2,f.LOADING=3,f.DONE=4,f.prototype.readyState=f.UNSENT,f.prototype.responseText="",f.prototype.responseXML=null,f.prototype.status=0,f.prototype.statusText="",f.prototype.priority="NORMAL",f.prototype.onreadystatechange=null,f.onreadystatechange=null,f.onopen=null,f.onsend=null,f.onabort=null,f.prototype.open=function(a,d,e,g,i){delete this._headers,arguments.length<3&&(e=!0),this._async=e;var l=this,m=this.readyState,n;c&&e&&(n=function(){m!=f.DONE&&(k(l),l.abort())},window.attachEvent("onunload",n)),f.onopen&&f.onopen.apply(this,arguments),arguments.length>4?this._object.open(a,d,e,g,i):arguments.length>3?this._object.open(a,d,e,g):this._object.open(a,d,e),this.readyState=f.OPENED,h(this),this._object.onreadystatechange=function(){if(b&&!e)return;l.readyState=l._object.readyState,j(l);if(l._aborted){l.readyState=f.UNSENT;return}l.readyState==f.DONE&&(delete l._data,k(l),c&&e&&window.detachEvent("onunload",n)),m!=l.readyState&&h(l),m=l.readyState}},f.prototype.send=function(a){f.onsend&&f.onsend.apply(this,arguments),arguments.length||(a=null),a&&a.nodeType&&(a=window.XMLSerializer?(new window.XMLSerializer).serializeToString(a):a.xml,oRequest._headers["Content-Type"]||oRequest._object.setRequestHeader("Content-Type","application/xml")),this._data=a,g(this)},f.prototype.abort=function(){f.onabort&&f.onabort.apply(this,arguments),this.readyState>f.UNSENT&&(this._aborted=!0),this._object.abort(),k(this),this.readyState=f.UNSENT,delete this._data},f.prototype.getAllResponseHeaders=function(){return this._object.getAllResponseHeaders()},f.prototype.getResponseHeader=function(a){return this._object.getResponseHeader(a)},f.prototype.setRequestHeader=function(a,b){return this._headers||(this._headers={}),this._headers[a]=b,this._object.setRequestHeader(a,b)},f.prototype.addEventListener=function(a,b,c){for(var d=0,e;e=this._listeners[d];d++)if(e[0]==a&&e[1]==b&&e[2]==c)return;this._listeners.push([a,b,c])},f.prototype.removeEventListener=function(a,b,c){for(var d=0,e;e=this._listeners[d];d++)if(e[0]==a&&e[1]==b&&e[2]==c)break;e&&this._listeners.splice(d,1)},f.prototype.dispatchEvent=function(a){var b={type:a.type,target:this,currentTarget:this,eventPhase:2,bubbles:a.bubbles,cancelable:a.cancelable,timeStamp:a.timeStamp,stopPropagation:function(){},preventDefault:function(){},initEvent:function(){}};b.type=="readystatechange"&&this.onreadystatechange&&(this.onreadystatechange.handleEvent||this.onreadystatechange).apply(this,[b]);for(var c=0,d;d=this._listeners[c];c++)d[0]==b.type&&!d[2]&&(d[1].handleEvent||d[1]).apply(this,[b])},f.prototype.toString=function(){return"[object XMLHttpRequest]"},f.toString=function(){return"[XMLHttpRequest]"},window.Function.prototype.apply||(window.Function.prototype.apply=function(a,b){b||(b=[]),a.__func=this,a.__func(b[0],b[1],b[2],b[3],b[4]),delete a.__func}),NRequest.XMLHttpRequest=f}(),NParser=NClass.extend({options:null,externalProjection:null,internalProjection:null,data:null,keepData:!1,initialize:function(a){NUtil.setOptions(this,a)},destroy:function(){},read:function(a){return null},write:function(a){return null},CLASS_NAME:"NParser"}),NParser.XML=NParser.extend({namespaces:null,namespaceAlias:null,defaultPrefix:null,readers:{},writers:{},xmldom:null,initialize:function(a){window.ActiveXObject&&(this.xmldom=new ActiveXObject("Microsoft.XMLDOM")),NParser.prototype.initialize.call(a),this.namespaces=NUtil.extend({},this.namespaces),this.namespaceAlias={};for(var b in this.namespaces)this.namespaceAlias[this.namespaces[b]]=b},destroy:function(){this.xmldom=null,NParser.prototype.destroy.apply(this,arguments)},setNamespace:function(a,b){this.namespaces[a]=b,this.namespaceAlias[b]=a},read:function(a){var b=a.indexOf("<");b>0&&(a=a.substring(b));var c=NUtil.tryFuncs(NUtil.bind(function(){var b;return window.ActiveXObject&&!this.xmldom?b=new ActiveXObject("Microsoft.XMLDOM"):b=this.xmldom,b.loadXML(a),b},this),function(){return(new DOMParser).parseFromString(a,"text/xml")},function(){var b=new XMLHttpRequest;return b.open("GET","data:text/xml;charset=utf-8,"+encodeURIComponent(a),!1),b.overrideMimeType&&b.overrideMimeType("text/xml"),b.send(null),b.responseXML});return this.keepData&&(this.data=c),c},write:function(a){var b;if(this.xmldom)b=a.xml;else{var c=new XMLSerializer;if(a.nodeType==1){var d=document.implementation.createDocument("","",null);d.importNode&&(a=d.importNode(a,!0)),d.appendChild(a),b=c.serializeToString(d)}else b=c.serializeToString(a)}return b},createElementNS:function(a,b){var c;return this.xmldom?typeof a=="string"?c=this.xmldom.createNode(1,b,a):c=this.xmldom.createNode(1,b,""):c=document.createElementNS(a,b),c},createTextNode:function(a){var b;return typeof a!="string"&&(a=String(a)),this.xmldom?b=this.xmldom.createTextNode(a):b=document.createTextNode(a),b},getElementsByTagNameNS:function(a,b,c){var d=[];if(a.getElementsByTagNameNS)d=a.getElementsByTagNameNS(b,c);else{var e=a.getElementsByTagName("*"),f,g;for(var h=0,i=e.length;h<i;++h)f=e[h],g=f.prefix?f.prefix+":"+c:c,(c=="*"||g==f.nodeName)&&(b=="*"||b==f.namespaceURI)&&d.push(f)}return d},getAttributeNodeNS:function(a,b,c){var d=null;if(a.getAttributeNodeNS)d=a.getAttributeNodeNS(b,c);else{var e=a.attributes,f,g;for(var h=0,i=e.length;h<i;++h){f=e[h];if(f.namespaceURI==b){g=f.prefix?f.prefix+":"+c:c;if(g==f.nodeName){d=f;break}}}}return d},getAttributeNS:function(a,b,c){var d="";if(a.getAttributeNS)d=a.getAttributeNS(b,c)||"";else{var e=this.getAttributeNodeNS(a,b,c);e&&(d=e.nodeValue)}return d},getChildValue:function(a,b){var c=b||"";if(a)for(var d=a.firstChild;d;d=d.nextSibling)switch(d.nodeType){case 3:case 4:c+=d.nodeValue}return c},concatChildValues:function(a,b){var c="",d=a.firstChild,e;while(d)e=d.nodeValue,e&&(c+=e),d=d.nextSibling;return c==""&&b!=undefined&&(c=b),c},isSimpleContent:function(a){var b=!0;for(var c=a.firstChild;c;c=c.nextSibling)if(c.nodeType===1){b=!1;break}return b},contentType:function(a){var b=!1,c=!1,d=NParser.XML.CONTENT_TYPE.EMPTY;for(var e=a.firstChild;e;e=e.nextSibling){switch(e.nodeType){case 1:c=!0;break;case 8:break;default:b=!0}if(c&&b)break}if(c&&b)d=NParser.XML.CONTENT_TYPE.MIXED;else{if(c)return NParser.XML.CONTENT_TYPE.COMPLEX;if(b)return NParser.XML.CONTENT_TYPE.SIMPLE}return d},hasAttributeNS:function(a,b,c){var d=!1;return a.hasAttributeNS?d=a.hasAttributeNS(b,c):d=!!this.getAttributeNodeNS(a,b,c),d},setAttributeNS:function(a,b,c,d){if(a.setAttributeNS)a.setAttributeNS(b,c,d);else{if(!this.xmldom)throw"setAttributeNS not implemented";if(b){var e=a.ownerDocument.createNode(2,c,b);e.nodeValue=d,a.setAttributeNode(e)}else a.setAttribute(c,d)}},createElementNSPlus:function(a,b){b=b||{};var c=b.uri||this.namespaces[b.prefix];if(!c){var d=a.indexOf(":");c=this.namespaces[a.substring(0,d)]}c||(c=this.namespaces[this.defaultPrefix]);var e=this.createElementNS(c,a);b.attributes&&this.setAttributes(e,b.attributes);var f=b.value;return f!=null&&e.appendChild(this.createTextNode(f)),e},setAttributes:function(a,b){var c,d;for(var e in b)b[e]!=null&&b[e].toString&&(c=b[e].toString(),d=this.namespaces[e.substring(0,e.indexOf(":"))]||null,this.setAttributeNS(a,d,e,c))},readNode:function(a,b){b||(b={});var c=this.readers[a.namespaceURI?this.namespaceAlias[a.namespaceURI]:this.defaultPrefix];if(c){var d=a.localName||a.nodeName.split(":").pop(),e=c[d]||c["*"];e&&e.apply(this,[a,b])}return b},readChildNodes:function(a,b){b||(b={});var c=a.childNodes,d;for(var e=0,f=c.length;e<f;++e)d=c[e],d.nodeType==1&&this.readNode(d,b);return b},writeNode:function(a,b,c){var d,e,f=a.indexOf(":");f>0?(d=a.substring(0,f),e=a.substring(f+1)):(c?d=this.namespaceAlias[c.namespaceURI]:d=this.defaultPrefix,e=a);var g=this.writers[d][e].apply(this,[b]);return c&&c.appendChild(g),g},getChildEl:function(a,b,c){return a&&this.getThisOrNextEl(a.firstChild,b,c)},getNextEl:function(a,b,c){return a&&this.getThisOrNextEl(a.nextSibling,b,c)},getThisOrNextEl:function(a,b,c){a:for(var d=a;d;d=d.nextSibling)switch(d.nodeType){case 1:if((!b||b===(d.localName||d.nodeName.split(":").pop()))&&(!c||c===d.namespaceURI))break a;d=null;break a;case 3:if(/^\s*$/.test(d.nodeValue))break;case 4:case 6:case 12:case 10:case 11:d=null;break a}return d||null},lookupNamespaceURI:function(a,b){var c=null;if(a)if(a.lookupNamespaceURI)c=a.lookupNamespaceURI(b);else a:switch(a.nodeType){case 1:if(a.namespaceURI!==null&&a.prefix===b){c=a.namespaceURI;break a}var d=a.attributes.length;if(d){var e;for(var f=0;f<d;++f){e=a.attributes[f];if(e.prefix==="xmlns"&&e.name==="xmlns:"+b){c=e.value||null;break a}if(e.name==="xmlns"&&b===null){c=e.value||null;break a}}}c=this.lookupNamespaceURI(a.parentNode,b);break a;case 2:c=this.lookupNamespaceURI(a.ownerElement,b);break a;case 9:c=this.lookupNamespaceURI(a.documentElement,b);break a;case 6:case 12:case 10:case 11:break a;default:c=this.lookupNamespaceURI(a.parentNode,b);break a}return c},getXMLDoc:function(){return!NParser.XML.document&&!this.xmldom&&(document.implementation&&document.implementation.createDocument?NParser.XML.document=document.implementation.createDocument("","",null):!this.xmldom&&window.ActiveXObject&&(this.xmldom=new ActiveXObject("Microsoft.XMLDOM"))),NParser.XML.document||this.xmldom},CLASS_NAME:"NParser.XML"}),NParser.XML.CONTENT_TYPE={EMPTY:0,SIMPLE:1,COMPLEX:2,MIXED:3},NParser.XML.lookupNamespaceURI=NUtil.bind(NParser.XML.prototype.lookupNamespaceURI,NParser.XML.prototype),NParser.XML.document=null,NMap=NClass.extend({includes:NEWMAP_JS_LIB.PublicParts.Events,options:{center:null,zoom:null,layers:[],drag:!0,touchZoom:NUtil.Browser.touch&&!NUtil.Browser.android,scrollWheelZoom:!NUtil.Browser.touch,doubleClickZoom:!0,boxZoom:!0,zoomControl:!0,attributionControl:!1,zoomAnimation:NUtil.TRANSITION&&!NUtil.Browser.android23&&!NUtil.Browser.mobileOpera,markerZoomAnimation:NUtil.TRANSITION&&NUtil.Browser.any3d,closeDialogOnClick:!1,dragging:!0,inertia:!NUtil.Browser.android23,inertiaDeceleration:3400,inertiaMaxSpeed:1300,inertiaThreshold:NUtil.Browser.touch?32:18,easeLinearity:.25,longPress:!0,worldCopyJump:!1},initialize:function(a,b){NUtil.setOptions(this,b),b=NUtil.extend({},b),this._container=NUtil.get(a);if(this._container._newmap_used_tag)throw new Error("Map container is already initialized.");this._container._newmap_used_tag=!0,this._initLayout(),this._initEvents(),this._initInteraction(),this._layers={},this._layerIds=new Array;if(b){b&&b.maxExtent&&this.setMaxBounds(b.maxExtent);var c=this.options.layers||[];c=c instanceof Array?c:[c],this._initLayers(c);var d=this.options.center,e=this.options.zoom;d!==null&&e!==null&&this.basicLayer&&this.setView(d,e)}this._initOverlays()},getSize:function(){if(!this._size||this._sizeChanged)this._size=new NXY(this._container.clientWidth,this._container.clientHeight),this._sizeChanged=!1;return this._size},getCenter:function(){return this._getCenter()},getZoom:function(){return this.zoom},getZoomCount:function(){var a=0;return this.basicLayer&&(a=this.basicLayer.resolutions.length),a},getScale:function(){var a=null;if(this.basicLayer!=null){var b=this.getUnits(),c=this.getResolution();b===null&&(b="degrees"),a=c*NUtil.INCHES_PER_UNIT[b]*96}return a},getResolution:function(){var a=null;return this.basicLayer!=null&&(a=this.basicLayer._getResolution()),a},getResolutions:function(){return this.basicLayer?this.basicLayer._getResolutions():null},getExtent:function(){var a=null;return this.basicLayer!=null&&(a=this.basicLayer._getExtent()),a},getMaxExtent:function(){var a=null;return this.basicLayer?a=this.maxExtent||this.basicLayer.maxExtent||this._getDefaultMaxExtent():a=this.maxExtent||this._getDefaultMaxExtent(),a},getUnits:function(){return this.basicLayer?this.basicLayer.getUnits():this.units||"dd"},getProjection:function(){return this.basicLayer?this.basicLayer.getProjection():null},zoomIn:function(){return this._setZoom(this.zoom+1)},zoomOut:function(){return this._setZoom(this.zoom-1)},moveTo:function(a,b){return this.setView(a,b)},panBy:function(a,b){return!a.x&&!a.y?this:(this._panTransition||(this._panTransition=new NTransition(this._mapPane,b),this._panTransition.on("step",this._onPanTransitionStep,this),this._panTransition.on("end",this._onPanTransitionEnd,this)),this.fire("movestart"),NUtil.addClass(this._mapPane,"newmap-pan-anim"),this._panTransition.run({position:NUtil.getPosition(this._mapPane).subtract(a)}),this.on("zoomstart",this._endPanBy,this),this)},_endPanBy:function(){this._panTransition._onTransitionEnd();var a=this.basicLayer._container,b=this._tileBg;if(b){this._stopLoadingImages(a);return}},_onPanTransitionStep:function(){this.fire("move")},_onPanTransitionEnd:function(){NUtil.removeClass(this._mapPane,"newmap-pan-anim"),this.fire("moveend")},_getLoadedTilesPercentage:function(a){var b=a.getElementsByTagName("img"),c,d,e=0;for(c=0,d=b.length;c<d;c++)b[c].complete&&e++;return d==0?1:e/d},_stopLoadingImages:function(a){var b=a.getElementsByTagName("img"),c,d,e;for(c=0,d=b.length;c<d;c++)e=b[c],e&&!e.complete&&(e.onload=NUtil.falseFn,e.onerror=NUtil.falseFn,e.src="",e.parentNode.removeChild(e))},_stopLoadingBgTiles:function(){var a=[].slice.call(this._tileBg.getElementsByTagName("img"));for(var b=0,c=a.length;b<c;b++)a[b].complete||(a[b].parentNode.removeChild(a[b]),a[b]=null)},_loadTileBg:function(){if(this._bTileBgTag&&this.basicLayer){var a=this.basicLayer._container,b=this._tileBg;a&&b&&this._getLoadedTilesPercentage(a)>.9&&this._clearTileBg()}},zoomToMaxExtent:function(){var a=this.getMaxExtent();a&&this.zoomToExtent(a)},zoomToExtent:function(a){if(a&&a instanceof NBounds){var b=a.getCenter(),c=this.getZoomForBounds(a);this.setView(b,c)}},zoomToScale:function(a,b){if(a&&!isNaN(a)){var c=this.getUnits(),d=a/(NUtil.INCHES_PER_UNIT[c]*96),b=b||this.getCenter(),e=this.basicLayer._getZoomByRes(d);this.setView(b,e)}else this.zoomToMaxExtent()},_zoomWithAnimation:function(a,b,c){if(this._getAnimatingZoom())return!0;if(!this.basicLayer instanceof NGridLayer)return!1;this._animateToCenter=a,this._animateToZoom=b,this._clearTileBgTimer&&clearTimeout(this._clearTileBgTimer),this.fire("zoomstart"),this._prepareTileBg();if(!this._tileBg||this._tileBg.children.length==0)return!1;var d=this._tileBg.getElementsByTagName("img");if(!d||d.length<=0)return!1;NUtil.addClass(this._mapPane,"newmap-zoom-anim2");var e=this.getResolution(),f=this.getResByZoom(b);this._scale=f/e,this._zoomCenter=a.subtract(this._getCenter().multiplyBy(this._scale)).divideBy(1-this._scale),this._zoomCenterPixel=this._pointToAbsPixel(this._zoomCenter),this._interval=Math.round(1e3/60),this._startTime=NUtil.getTime(),clearInterval(this._zoomAnimationTimer);var g=this;return this._zoomAnimationTimer=setInterval(g._zoomAnimationStep(g),this._interval),!0},_zoomAnimationStep:function(a){var b=a;return function(){var a=NUtil.getTime(),c=a-b._startTime,d=400;c<d?b._runTimerAnimation(NUtil.getBezierPos(c/d)):(b._runTimerAnimation(1),b._completeZoomAnim())}},_getAnimatingZoom:function(){return this._animatingZoom||this._tmpAnimatingZoom},_runTimerAnimation:function(a){var b=this._tileBg.getElementsByTagName("img"),c,d,e=1+(this._scale-1)*a,f,g;this._tmpAnimatingZoom=!0;for(var h=0,i=b.length;h<i;h++){d=b[h];if(!d)continue;this._animatingZoom||(d._aiw=parseInt(d.style.width),d._aiy=parseInt(d.style.height),c=NUtil.getPosition(d,!0),c&&NUtil.setPosition(d,new NXY(parseInt(c.x),parseInt(c.y)))),c=NUtil.getPosition(d),f=Math.ceil(d._aiw/e),g=Math.ceil(d._aiy/e),d.style.width=f+"px",d.style.height=g+"px";var j=1+(this._scale-1)*a,k=c.subtract(this._zoomCenterPixel).divideBy(j).add(this._zoomCenterPixel);NUtil.setPosition(d,k,!1,!0)}this._tmpAnimatingZoom=!1,this._animatingZoom=!0,this.fire("step")},_completeZoomAnim:function(){clearInterval(this._zoomAnimationTimer),this._onZoomTransitionEnd()},_onZoomTransitionEnd:function(){NUtil.falseFn(this._tileBg.offsetWidth),this._resetView(this._animateToCenter,this._animateToZoom,!0,!0),NUtil.removeClass(this._mapPane,"newmap-zoom-anim2"),this._tmpAnimatingZoom=!1,this._animatingZoom=!1},_prepareTileBg:function(){var a=this.basicLayer._container,b=this._tileBg;if(b&&this._getLoadedTilesPercentage(b)>.5&&this._getLoadedTilesPercentage(a)<.5){this._stopLoadingImages(a);return}this._tileBg&&this._tileBg.childNodes&&this._tileBg.childNodes.length>NUtil.MaxBgTileCount&&this._clearTileBg(),this._tileBg||(this._tileBg=NUtil.create("div","newmap-tile-pane",this._mapPane),this._tileBg.style.zIndex=1);var c=this.basicLayer._tiles;this._initialTileSize=this.basicLayer.getTileSize?this.basicLayer.getTileSize():this.getSize();var d=[],e;for(e in c)c.hasOwnProperty(e)&&c[e].complete&&d.push(c[e]);c=null;if(d.length>0){var f,g;for(f=0,g=d.length;f<g;f++)this._tileBg.appendChild(d[f])}d.length=0,d=null,this._bTileBgTag=!0,this.basicLayer&&(this.basicLayer.on("loaded",this._clearTileBg,this),this.basicLayer.on("tileload",this._loadTileBg,this),this._ieBgClearTimer&&clearInterval(this._ieBgClearTimer),this._ieBgClearTimer=setInterval(this._clearIeTileBg(this),2e3))},_clearIeTileBg:function(a){var b=a;return function(){b._loadTileBg()}},setMode:function(a,b){a=a.toLowerCase();if(this._curMode&&this._curMode==a)return this;(this._curMode=="measurelength"||this._curMode=="measurearea")&&this._handlers[this._curMode]&&this._handlers[this._curMode].disable();var c=[];a=="dragzoom"?(this._hegemonTag=!1,c=["drag","doubleclickzoom","scrollwheelzoom","touchzoom"]):a=="drag"?(this._hegemonTag=!1,c=["drag"]):a=="zoom"?(this._hegemonTag=!1,c=["doubleclickzoom","scrollwheelzoom","touchzoom"]):a=="measurelength"?(this._hegemonTag=!0,this.on("measureend",this._onMeasureEnd,this),c=["doubleclickzoom","drag","scrollwheelzoom","measurelength"]):a=="measurearea"?(this._hegemonTag=!0,this.on("measureend",this._onMeasureEnd,this),c=["doubleclickzoom","drag","scrollwheelzoom","measurearea"]):a=="drawpoint"?(this._hegemonTag=!0,c=["doubleclickzoom","drag","drawpoint"]):a=="drawline"?(this._hegemonTag=!0,c=["doubleclickzoom","drawline"]):a=="drawpolygon"?(this._hegemonTag=!0,c=["doubleclickzoom","doubleclickzoom","drawpolygon"]):a=="drawrect"?(this._hegemonTag=!0,c=["doubleclickzoom","drawrect"]):a=="zoomboxin"?(this._hegemonTag=!0,b=b||{},b._zoomInTag=!0,c=["zoomboxin","doubleclickzoom","scrollwheelzoom"]):a=="zoomboxout"?(b=b||{},b._zoomInTag=!1,this._hegemonTag=!0,c=["zoomboxout","doubleclickzoom","scrollwheelzoom"]):a=="drawcircle"?(this._hegemonTag=!0,c=["drawcircle"]):a=="drawsector"?(this._hegemonTag=!0,c=["drawsector"]):a=="drawmarker"&&(this._hegemonTag=!0,c=["drag","drawmarker"]);var d=0,e=c.length;if(e<=0)return this;this._handlers=this._handlers||{};var f;for(d=0;d<e;d++)f=c[d],this._handlers.hasOwnProperty(f)&&this._handlers[f]?this._handlers[f].enable():NHandlerHash[f]&&(this._handlers[f]=new NHandlerHash[f](this),this._handlers[f].enable());for(f in this._handlers)this._handlers.hasOwnProperty(f)&&this._handlers[f]&&!NUtil.checkInArray(f,c)&&this._handlers[f]&&this._handlers[f].disable();return this._handlers[a]&&this._handlers[a].setHandlerOptions&&this._handlers[a]&&this._handlers[a].setHandlerOptions(b),this._curMode=a,this},_checkDragEnable:function(){if(!this._handlers||!this._handlers.drag)return!1;var a=!0;if(this._curMode=="measurelength"||this._curMode=="measurearea"||this._curMode=="drawcircle"||this._curMode=="drawpolygon"||this._curMode=="drawrect"||this._curMode=="drawline"||this._curMode=="drawsector"||this._curMode=="zoom")a=!1;return a},getBasicLayer:function(){return this.basicLayer||null},setBasicLayer:function(a){if(!a||!a.isBasicLayer)return this;this.hasLayer(a)||this.addLayer(a);var b=null,c=null;this.basicLayer&&(b=this.getExtent(),c=this.getResolution());if(!this.basicLayer||NUtil.stamp(this.basicLayer)!=NUtil.stamp(a)){this.basicLayer!=null&&(this._clearTileBg(),this.basicLayer.off("loaded",this._clearTileBg,this),this.basicLayer.off("tileload",this._loadTileBg,this),this.basicLayer.setVisible(!1)),this.basicLayer=a,this.basicLayer.on("loaded",this._clearTileBg,this),this.basicLayer.setVisible(!0);var d=this.getCenter();if(d!=null){var e=b?b.getCenter():d;if(this.basicLayer.maxExtent!=null&&!this.basicLayer.maxExtent.contains(e))this.zoomToMaxExtent();else{d=this.options.center,zoom=this.options.zoom;if(d!==null||zoom!==null)this.setView(d,zoom,!0);else{var f=this.basicLayer._getZoomByRes(c);this.setView(e,f,!0)}}}this.fire("changebasiclayer",{layer:this.basicLayer})}return this},_checkAllLayersFilledTag:function(){return this.basicLayer._filledTag},addLayer:function(a,b){if(!a)return this;var c=NUtil.stamp(a);return this._layers[c]?this:(this.fire("preaddlayer",{layer:a}),this._layers[c]=a,a.isBasicLayer?this._layerIds.splice(0,0,c):this._layerIds.push(c),a._setMap(this),this.attributionControl&&a.getAttribution&&this.attributionControl.addAttribution(a.getAttribution()),a.isBasicLayer?this.basicLayer?a.setVisible(!1):this.setBasicLayer(a):a.redraw(),this.fire("layeradded",{layer:a}),a._afterAdd&&a._afterAdd(),this)},whenReady:function(a,b){return this._loaded?a.call(b||this,this):this.on("load",a,b),this},hasLayer:function(a){var b=NUtil.stamp(a);return this._layers.hasOwnProperty(b)},removeLayer:function(a){var b=NUtil.stamp(a);if(!this._layers[b])return this;var c=this.getLayersCount(),d,e;for(e=0;e<c;e++)if(this._layerIds[e]==b){d=e;break}var f=null,g;if(a.isBasicLayer){for(e=0;e<c;e++){g=this._layerIds[e];if(g==b)continue;if(this._layers[g]&&this._layers[g].isBasicLayer){f=g;break}}if(!f)return this;this.setBasicLayer(this._layers[f])}return a._unsetMap(),delete this._layerIds[d],delete this._layers[b],this.fire("layerremoved",{layer:a}),this},getLayersCount:function(){return this._layerIds?this._layerIds.length:0},getLayers:function(){var a=null;if(!this._layers)return null;var b;for(b in this._layers)this._layers.hasOwnProperty(b)&&this._layers[b]&&(a||(a=new Array),a.push(this._layers[b]));return a},getLayersByName:function(a,b){var c=null;if(!this._layers)return null;var d,e;a=b?a.toLowerCase():a;for(d in this._layers)this._layers.hasOwnProperty(d)&&this._layers[d]&&(e=this._layers[d].getName(),e=b?e.toLowerCase():e,e==a&&(c||(c=new Array),c.push(this._layers[d])));return c},getLayerById:function(a){if(!this._layers)return null;var b,c;a=a.toLowerCase();for(b in this._layers)if(this._layers.hasOwnProperty(b)&&this._layers[b]){c=this._layers[b].getId(),c=c.toLowerCase();if(c==a)return this._layers[b]}return null},addHotspots:function(a,b){if(!a)return;var c=a instanceof Array?a:[a],d=0,e,f,g,h,i=0,j=c.length;while(i<j){f=c[i];if(f&&f.getPosition()){e=NUtil.stamp(f);if(!this.hasHotspot(e)){h=this.getHotspotsCount();if(!b)for(d=0;d<h;d++){g=this._hotspots[d];if(g&&g.getPosition().y>f.getPosition().y)break}this._hotspots.splice(d,0,f),this.fire("hotspotadded",{hotspot:f})}}i++}this.getHotspotsCount()>0?this.on("mousemove",this._checkHotspot,this):this.off("mousemove",this._checkHotspot)},setHotspotInfoOffset:function(a){a&&a instanceof NXY&&this.setHotspotLabelOptions({offset:a})},getHotspotsCount:function(){return this._hotspots?this._hotspots.length:0},hasHotspot:function(a){var b=NUtil.stamp(a),c,d,e=this._hotspots.length-1;while(e>=0){d=this._hotspots[e];if(d){c=NUtil.stamp(d);if(c==b)return!0}e--}return!1},removeHotspots:function(a){var b=this.getHotspotsCount();if(!a||b<=0)return;var c=a instanceof Array?a:[a],d=0,e,f,g,h,i,j=0,k=c.length-1;while(k>=0){g=c[j];if(g&&g instanceof NHotspot){e=NUtil.stamp(g),f=this._hotspots.length-1;while(f>=0){h=this._hotspots[f];if(h){hsId=NUtil.stamp(h);if(e==hsId){this._hotspots.splice(f,1),this.fire("hotspotremoved",{hotspot:h});break}}f--}}k--}return this},clearHotspots:function(){return this._hotspots&&this.removeHotspots(this._hotspots),this},_checkHotspot:function(a){var b=a.point,c,d=null,e=this.getResolution();for(var f=this.getHotspotsCount()-1;f>=0;f--){c=this._hotspots[f];if(c){var g=c.checkValid(b,e);if(g){d=c;break}}}d?(this._showHotspotInfo(d),this.fire("hotspotvalid",{hotspot:d})):(this._hideHotspotInfo(),this.fire("hotspotinvalid"))},_hotSpotLabelOptions:{offset:new NXY(10,10),popable:!1,zIndexOffset:65535,clickable:!1,draggable:!1},_showHotspotInfo:function(a){var b=this._hotSpotLabelOptions;this._hsLabel?(this._hsLabel.setPosition(a.getPosition()),this._hsLabel.setContent(a.getText())):(this._hsLabel=new NLabel(a.getPosition(),b),this._hsLabel.setContent(a.getText()),b.style&&this._hsLabel.setStyle(b.style),this.addOverlays(this._hsLabel)),this._hsLabel.setVisible(!0)},_hideHotspotInfo:function(){return this._hsLabel&&this._hsLabel.setVisible(!1),this},setHotspotLabelOptions:function(a){NUtil.extend(this._hotSpotLabelOptions,a);if(this._hsLabel){var b=this._hotSpotLabelOptions;b.style&&this._hsLabel.setStyle(b.style)}},addContextMenu:function(a){a&&a instanceof NContextMenu&&(this._contextMenu=a,NEvent.addListener(this._container,"contextmenu",this._showContextmenu,this),this._contextMenu._setMap(this))},removeContextMenu:function(){NEvent.removeListener(this._container,"contextmenu",this._showContextmenu),this._contextMenu=null},_showContextmenu:function(a){a=a||window.e,NEvent.preventDefault(a),this._contextMenu&&this._contextMenu.show({point:this.pixelToPoint(NEvent.getMousePosition(a,this._container)),pixel:NEvent.getMousePosition(a,this._container),absPixel:this._pixelToAbsPixel(NEvent.getMousePosition(a,this._container))})},addOverlays:function(a){var b=a instanceof Array?a:[a],c,d,e=0,f=b.length;while(e<f)d=b[e],d&&(c=NUtil.stamp(d),!this.hasOverlay(c)&&d._setMap&&(d._setMap(this),d._markerTarget&&d._markerTarget.id!=""?c=d._markerTarget.id:c=NUtil.stamp(d),this._overlays[c]=d,this.fire("overlayadded",{overlay:d}))),e++},hasOverlay:function(a){var b=typeof a=="string"?a:NUtil.stamp(a);return this._overlays?this._overlays.hasOwnProperty(b):!1},getOverlay:function(a){return this._overlays&&this._overlays.hasOwnProperty(a)?this._overlays[a]:NULL},removeOverlays:function(a){var b=a instanceof Array?a:[a],c,d;for(var e in b)b.hasOwnProperty(e)&&(c=b[e],c&&(!c.hasOwnProperty("_layerFlag")||!c._layerFlag)&&(c._markerTarget&&c._markerTarget.id!=""?d=c._markerTarget.id:d=NUtil.stamp(c),this.hasOverlay(d)&&(delete this._overlays[d],c._unsetMap(this),this.fire("overlayremoved",{overlay:c}))))},clearOverlays:function(){this.setMode("dragzoom");var a;if(this._layers)for(var b in this._layers)if(this._layers.hasOwnProperty(b)){a=this._layers[b];if(a&&a instanceof NOverlayLayer){if(a instanceof NWFSLayer)continue;a.clear()}}this._overlays&&this.removeOverlays(this._overlays)},setSingleDialog:function(a){this._singleDialog&&this.removeSingleDialog(),a._singleDlgTag=!0,this._addDialog(a),this._singleDialog=a},removeSingleDialog:function(){this._singleDialog&&this._removeDialog(this._singleDialog),this._singleDialog=null},openSingleDialog:function(){if(!this._singleDialog)return;this._singleDialog.show(),this.fire("dialogopened",{dialog:this._dialog})},closeSingleDialog:function(){if(!this._singleDialog)return;this._singleDialog.hide(),this.fire("dialogclosed",{dialog:this._dialog})},getSingleDialog:function(){return this._singleDialog?this._singleDialog:null},openDialog:function(a){return this.closeDialog(),this._dialog=a,this._addDialog(a),this.fire("dialogopened",{dialog:this._dialog}),this},closeDialog:function(a){return a&&(this._removeDialog(a),this.fire("dialogclosed",{dialog:a}),this._dialog=null),this},_addDialog:function(a){var b=NUtil.stamp(a),c=function(){a._setMap(this),this.fire("dialogadded",{dialog:a})};return this._loaded?c.call(this):this.on("load",c,this),this},_removeDialog:function(a){return a?(a._unsetMap(this),this.fire("dialogremoved",{dialog:a}),this):this},addControl:function(a){if(a&&a instanceof NControl){var b=a.getType();if(!this.hasControlByType(b)||!a.singleAlive){var c=NUtil.stamp(a);this._controls=this._controls||[],a._setMap(this),this._controls[c]=a,this.fire("controladded",{control:a})}}return this},hasControlByType:function(a){if(this._controls)for(var b in this._controls)if(this._controls.hasOwnProperty(b)&&this._controls[b]&&this._controls[b].getType&&this._controls[b].getType().toLowerCase()==a.toLowerCase())return!0;return!1},removeControl:function(a){if(this._controls&&a&&a instanceof NControl){var b=NUtil.stamp(a);this._controls[b]&&delete this._controls[b],a._unsetMap(this),this.fire("controlremoved",{control:a})}return this},removeControlByType:function(a){if(this._controls&&a&&this._controls)for(var b in this._controls)this._controls.hasOwnProperty(b)&&this._controls[b]&&this._controls[b].getType().toLowerCase()==a.toLowerCase()&&this.removeControl(this._controls[b]);return this},_initControlDivs:function(){function d(d,e){var f=b+d+" "+b+e;a[d+e]=NUtil.create("div",f,c)}var a=this._subControlDivs={},b="newmap-",c=this._controlDiv=NUtil.create("div",b+"control-div",this._container);d("top","left"),d("top","right"),d("bottom","left"),d("bottom","right")},getResByZoom:function(a){return this.basicLayer._getResByZoom(a)},getZoomByRes:function(a){return this.basicLayer._getZoomByRes(a)},getBounds:function(a,b){var c=null;a==null&&(a=this._getCenter()),b==null&&(b=this.getResolution());if(a!=null&&b!=null){var d=this.getSize(),e=d.x*b,f=d.y*b;c=new NBounds(a.x-e/2,a.y-f/2,a.x+e/2,a.y+f/2)}return c},getZoomForBounds:function(a){return this.basicLayer?this.basicLayer.getZoomForBounds(a):0},pixelToPoint:function(a){var b=null;return this.basicLayer!=null&&(b=this.basicLayer._pixelToPoint(a)),b},pointToPixel:function(a){var b=null;return this.basicLayer!=null&&(b=this.basicLayer._pointToPixel(a)),b},setView:function(a,b,c){a=a||this.getCenter(),b===undefined&&(b=this.getZoom()),a instanceof NXY||(a=this.getCenter());var d=this._resetMoveToParams(a,b);a=d.lonlat,b=d.zoom;var e=this.zoom!==b;if(this._loaded&&!c&&this._layers){var f=new NXY(0,0);a.equals(this.getCenter())||(f=this.pointToPixel(a).subtract(this.pointToPixel(this.getCenter())));var g=e?!!this._zoomWithAnimation&&this._zoomWithAnimation(a,b,f):this.panBy(f);if(g)return this}return this._resetView(a,b,!1,!1,c),this},_resetView:function(a,b,c,d,e){if(!this.basicLayer)return;b!=undefined&&(b=parseFloat(b),b=Math.round(b)),a=a||this._getCenter(),b=b==undefined?this.getZoom():b;var f=this._resetMoveToParams(a,b);a=f.lonlat,b=f.zoom;var g=this.zoom!==b,h=!this._getCenter()||a.x==this._getCenter().x&&a.y==this._getCenter().y;if(!g&&!h&&!e)return;d||(this.fire("movestart"),g&&this.fire("zoomstart")),this.zoom=b;if(!c)NUtil.setPosition(this._mapPane,new NXY(0,0)),this.centerOffset=new NXY(0,0);else{var i=NUtil.getPosition(this._mapPane);this.centerOffset=i}this._setCenter(a);var j=!this._loaded;this._loaded=!0,this.fire("viewreset",{hard:!c}),(g||d)&&this.fire("zoomend"),this.fire("moveend",{hard:!c}),j&&this.fire("load")},_setView2:function(a,b,c){a=a||this.getCenter(),b===undefined&&(b=this.getZoom()),a instanceof NXY||(a=this.getCenter());var d=this.zoom!==b;if(this._loaded&&!c&&this._layers){var e=new NXY(0,0);a.equals(this.getCenter())||(e=this.pointToPixel(a).subtract(this.pointToPixel(this.getCenter())));var f=d?!!this._zoomWithAnimation&&this._zoomWithAnimation(a,b,e):this.panBy(e);if(f)return this}return this._resetView2(a,b,!1,!1,c),this},_resetView2:function(a,b,c,d,e){if(!this.basicLayer)return;b!=undefined&&(b=parseFloat(b),b=Math.round(b)),a=a||this._getCenter(),b=b==undefined?this.getZoom():b;var f=this.zoom!==b,g=!this._getCenter()||a.x==this._getCenter().x&&a.y==this._getCenter().y;if(!f&&!g&&!e)return;d||(this.fire("movestart"),f&&this.fire("zoomstart")),this.zoom=b;if(!c)NUtil.setPosition(this._mapPane,new NXY(0,0)),this.centerOffset=new NXY(0,0);else{var h=NUtil.getPosition(this._mapPane);this.centerOffset=h}this._setCenter(a);var i=!this._loaded;this._loaded=!0,this.fire("viewreset",{hard:!c}),(f||d)&&this.fire("zoomend"),this.fire("moveend",{hard:!c}),i&&this.fire("load")},panTo:function(a){return this.setView(a,this._zoom)},setMaxExtent:function(a){a=a||null,this.options.maxExtent=this.maxExtent=a;if(!a)return this;this._loaded&&this.panInsideBounds(a)},_panInsideBounds:function(a){var b=this.getBounds(),c=this.pointToPixel(new NXY(b.minX,b.minY)),d=this.pointToPixel(new NXY(b.maxX,b.maxY)),e=this.pointToPixel(new NXY(a.minX,a.minY)),f=this.pointToPixel(new NXY(a.maxX,a.maxY)),g=f.x-e.x,h=f.y-e.y,i=d.x-c.x,j=d.y-c.y,k=0,l=0;return j<h?d.y>f.y?l=f.y-d.y:c.y<e.y&&(l=e.y-c.y):(d.y<f.y&&(l=f.y-d.y),c.y>e.y&&(l=e.y-c.y)),i>g?d.x<f.x?k=f.x-d.x:c.x>e.x&&(k=e.x-c.x):(d.x>f.x&&(k=f.x-d.x),c.x<e.x&&(k=e.x-c.x)),this.panBy(new NXY(k,l))},invalidateSize
:function(){var a=this.getSize();return this._sizeChanged=!0,this.options.maxBounds&&this.setMaxExtent(this.options.maxBounds),this._loaded?(this.fire("move"),clearTimeout(this._sizeTimer),this._sizeTimer=setTimeout(NUtil.bind(function(){this._resetView(this._center,this.getZoom())},this),200),this):this},_pointToAbsPixel:function(a){return this.pointToPixel(a).subtract(NUtil.getPosition(this._mapPane))},_absPixelToPoint:function(a){return this.pixelToPoint(a.add(NUtil.getPosition(this._mapPane)))},_absPixelToPixel:function(a){if(!a)return new NXY(0,0);var b=NUtil.getPosition(this._mapPane);return b?a.add(b):a},_pixelToAbsPixel:function(a){if(!a)return new NXY(0,0);var b=NUtil.getPosition(this._mapPane);return b?a.subtract(b):a},_initLayers:function(a){a=a?a instanceof Array?a:[a]:[],this._layers={},this._layerIds=new Array;var b,c;for(b=0,c=a.length;b<c;b++)this.addLayer(a[b])},_initOverlays:function(a){this._overlays=new Array,this._hotspots=new Array;if(!a)return;this.addOverlays(a)},_initLayout:function(){var a=this._container;a.innerHTML="",NUtil.addClass(a,"newmap-container"),NUtil.Browser.touch&&NUtil.addClass(a,"newmap-touch");var b=NUtil.getStyle(a,"position");b!=="absolute"&&b!=="relative"&&b!=="fixed"&&(a.style.position="relative");var c=this._panes={};this._mapPane=c.mapPane=NUtil.create("div","newmap-map-pane",this._container),this._tilePane=c.tilePane=NUtil.create("div","newmap-tile-pane",this._mapPane),this._objectsPane=c.objectsPane=NUtil.create("div","newmap-objects-pane",this._mapPane),c.shadowPane=NUtil.create("div","newmap-shadow-pane",this._objectsPane),c.labelPane=NUtil.create("div","newmap-label-pane",this._objectsPane),c.overlayPane=NUtil.create("div","newmap-overlay-pane",this._objectsPane),c.markerPane=NUtil.create("div","newmap-marker-pane",this._objectsPane),c.tmpPane=NUtil.create("div","newmap-tmp-pane",this._mapPane),c.dialogPane=NUtil.create("div","newmap-dialog-pane",this._objectsPane);var d="newmap-zoom-hide";this.options.markerZoomAnimation||(NUtil.addClass(c.markerPane,d),NUtil.addClass(c.shadowPane,d),NUtil.addClass(c.dialogPane,d)),this._initControlDivs&&this._initControlDivs()},_initEvents:function(){if(!NEvent)return;NEvent.addListener(this._container,"click",this._onMouseClick,this);var a=["dblclick","mousedown","mouseup","mouseenter","mouseleave","mousemove"],b,c;for(b=0,c=a.length;b<c;b++)NEvent.addListener(this._container,a[b],this._fireMouseEvent,this);this.on("move",this._moveCallBack,this),this.on("viewreset",this._viewResetCallBack,this),NEvent.addListener(window,"resize",this._onResize,this),this.on("moveend",this._moveEndCallBack,this)},_clearTileBg:function(){this._tileBg&&this._tileBg.children.length>0&&NUtil.clearAllNode(this._tileBg),this._ieBgClearTimer&&clearInterval(this._ieBgClearTimer)},_loadTileBg:function(){},_viewResetCallBack:function(a){var b=this.getLayersCount(),c,d;for(var e=0;e<b;e++){c=this._layerIds[e],d=this._layers[c];if(!d)continue;d._reset(a.hard)}},_moveCallBack:function(a){this.basicLayer.getVisible()&&this.basicLayer._moveCallBack(a)},_moveEndCallBack:function(a){var b=a&&a.hard,c=a&&a.zoomChanged;this.basicLayer.getVisible()&&this.basicLayer._moveEndCallBack(a);var d=this.getLayersCount(),e,f;for(var g=0;g<d;g++){e=this._layerIds[g],f=this._layers[e];if(!(!!f&&!f.isBasicLayer&&f instanceof NLayer))continue;f._moveEndCallBack(a)}},_rawPanBy:function(a){var b=NUtil.getPosition(this._mapPane);if(isNaN(b.x)||isNaN(b.y)){this._resetView();return}if(!a||isNaN(a.x)||isNaN(a.y))return;NUtil.setPosition(this._mapPane,b.subtract(a))},_stopLoadImg:function(){var a=this.getLayersCount(),b,c;for(var d=0;d<a;d++)b=this._layerIds[d],c=this._layers[b],(!c||!(c instanceof NGridLayer))&&c.stopLoadImg()},_resetMoveToParams:function(a,b){if(this.basicLayer){b=this._limitZoom(b);var c=this.basicLayer._getResByZoom(b),d=this.getBounds(a,c),e=this.getMaxExtent();if(!e.contains(a)){var f=this.getSize(),g=c*f.x/2,h=c*f.y/2,i=e.getCenter();d.getWidth()>e.getWidth()?a=new NXY(i.x,a.y):a.x<e.minX?a.x=e.minX+g:a.x>e.maxX&&(a.x=e.maxX-g),d.getHeight()>e.getHeight()?a=new NXY(a.x,i.y):a.y<e.minY?a.y=e.minY+h:a.y>e.maxY&&(a.y=e.maxY-h)}}return{lonlat:a,zoom:b}},_getDefaultMaxExtent:function(){var a=null;return this.getUnits()=="dd"&&(a=new NBounds(-180,-90,180,90)),a},_setZoom:function(a){return this.setView(this.getCenter(),a)},_getBoundsByRes:function(a,b){var c=this.getSize(),d=b*c.x/2,e=b*c.y/2;return new NBounds(a.x-d,a.y-e,a.x+d,a.y+e)},_setCenter:function(a){var b=NUtil.getPosition(this._mapPane);if(!b||b.x==0&&b.y==0)return this.center=a,this;var c=this.getResolution();return this.center||(this.center=a),this.center.x=a.x+b.x*c,this.center.y=a.y-b.y*c,this},_getAbsCenter:function(a){var b=NUtil.getPosition(this._mapPane);if(!b||b.x==0&&b.y==0)return this.center=a,this;var c=this.getResolution(),d=a;return d.x=a.x+b.x*c,d.y=a.y-b.y*c,d},_getRealCenter:function(){var a=NUtil.getPosition(this._mapPane),b=this.center,c=this.getResolution();return new NXY(b.x-a.x*c,b.y+a.y*c)},_getCenternew:function(){this.center||this._setCenter(this.getMaxExtent().getCenter());var a=NUtil.getPosition(this._mapPane);if(!this.centerOffset||this.centerOffset&&this.centerOffset.equals(a))return this.center;var b=this.getResolution(),c=this.center.x-(this.centerOffset.x-a.x)*b,d=this.center.y+(this.centerOffset.y-a.y)*b;return new NXY(c,d)},_getCenter:function(){this.center||this._setCenter(this.getMaxExtent().getCenter());var a=NUtil.getPosition(this._mapPane);if(!a||a.x==0&&a.y==0)return this.center;var b=this.getResolution(),c=this.center.x-a.x*b,d=this.center.y+a.y*b;return new NXY(c,d)},_onResize:function(){this._sizeChanged=!0,this.invalidateSize()},_initInteraction:function(){this._handlers={};var a;for(a in NHandlerHash)NHandlerHash.hasOwnProperty(a)&&NHandlerHash[a]&&(this._handlers[a]=new NHandlerHash[a](this),this.options[a]&&this._handlers[a].enable())},getHegemonTag:function(){return this._hegemonTag},_onMeasureEnd:function(a){this.setMode("dragzoom"),this.off("measureend",this._onMeasureEnd)},_limitZoom:function(a){var b=this.getZoomCount(),c=a;return c=c<0?0:c,c=c>b-1?b-1:c,c},_getPanes:function(){return this._panes},_onMouseClick:function(a){if(!this._loaded||this.checkDraging())return;this.fire("pre"+a.type),this._fireMouseEvent(a)},checkDraging:function(){return this._handlers.drag&&this._handlers.drag.moved()},_checkCurBasicLayer:function(a){return this.basicLayer&&NUtil.stamp(this.basicLayer)==NUtil.stamp(a)?!0:!1},_fireMouseEvent:function(a){if(!this._loaded)return;var b=a.type;b=b==="mouseenter"?"mouseover":b==="mouseleave"?"mouseout":b;if(!this.has(b))return;this.fire(b,{point:this.pixelToPoint(NEvent.getMousePosition(a,this._container)),pixel:NEvent.getMousePosition(a,this._container),absPixel:this._pixelToAbsPixel(NEvent.getMousePosition(a,this._container))})},getAPIVersion:function(){return NEWMAP_JS_LIB.VERSION}}),NMapOptions={center:null,zoom:null},NLayer=NClass.extend({includes:NEWMAP_JS_LIB.PublicParts.Events,_map:null,_container:null,_filledTag:!0,isBasicLayer:!1,zoomCount:null,copyright:"",layerType:"NLayer",attribution:"",visible:!0,initialize:function(a,b){this.name=a;var c=NUtil.extend({},NLayerOptions,b);NUtil.setOptions(this,c,!0)},getVisible:function(){return this.visible&&this._checkInRange()},getId:function(){return NUtil.stamp(this)},getName:function(){return this.name},getLayerType:function(){return this.layerType},getAttribution:function(){return this.attribution||""},getUnits:function(){return this.units},getOpacity:function(){return this.opacity},getProjection:function(){return this._map&&this._map.basicLayer&&this._map.basicLayer!=this?this._map.basicLayer.getProjection():this.projection||new NProjection("EPSG:4326")},setProjection:function(a){return a&&(this.projection=typeof a=="string"?new NProjection(a):a),this},setVisible:function(a){a!=this.visible&&(this.visible=a,this._display(a),this._update(),this._map!=null&&this._map.fire("changelayervisible",{layer:this,visible:a,property:"visible"}),this.fire("visibilitychanged"),this.getVisible()&&this._moveEndCallBack())},setOpacity:function(a){a=a===undefined?1:a;if(this.opacity==a)return;this.opacity=a,this.opacity=this.opacity>1?1:this.opacity,this.opacity=this.opacity<0?0:this.opacity,this.opacity<1&&NUtil.setOpacity(this._container,this.opacity);if(NUtil.Browser.webkit)for(var b in this._tiles)this._tiles.hasOwnProperty(b)&&(this._tiles[b].style.webkitTransform+=" translate(0,0)");if(NUtil.Browser.ie)for(var b in this._tiles)this._tiles.hasOwnProperty(b)&&NUtil.setOpacity(this._tiles[b],this.opacity)},redraw:function(){this._map&&this._moveTo()},_moveCallBack:function(a){this._updateMove(a);return},_moveEndCallBack:function(a){this.options&&!this.options.updateWhenIdle&&this._update(a)},_update:function(a){a=a||{};var b=a.bounds||this._map.getBounds();this._moveTo(b)},_updateMove:function(a){if(this._moveingTag)return;a=a||{};var b=a.bounds||this._map.getBounds();this._moveTo(b,!0)},_moveTo:function(a,b){var c=this.getVisible();this._container&&(this._container.style.display=c?"":"none");var d=this.getVisible();d!=this._inRange&&(this._inRange=d,this._display(this._inRange),this._map.fire("changelayervisible",{layer:this,visible:this.visible,property:"visible"}))},_display:function(a){this._container&&a!=(this._container.style.display!="none")&&(a&&this.getVisible()?this._container.style.display="":this._container.style.display="none")},_getPane:function(){if(this._map)return this._map._getPanes().tilePane},_updateZIndex:function(){this._container&&this.options.zIndex!==undefined&&(this._container.style.zIndex=this.options.zIndex)},_initContainer:function(){var a=this._getPane(),b=a.firstChild;if(!this._container||a.empty)this._container=NUtil.create("div","newmap-layer"),this._updateZIndex(),this.isBasicLayer&&b?a.insertBefore(this._container,b):a.appendChild(this._container),this.opacity&&this.setOpacity(this.opacity)},_initEvents:function(){this._map&&this.options.updateWhenIdle&&(this._limitedUpdate=NUtil.limitExecByInterval(this._update,150,this))},_removeEvents:function(){this._map&&(this._map.off("viewreset",this._resetCallback,this),this._map.off("moveend",this._update,this),this.options.updateWhenIdle||this._map.off("move",this._limitedUpdate,this))},_unsetMap:function(){if(this._map){this._removeEvents();var a=this._getPane();a.removeChild(this._container),this._map=null,this.fire("removed",{layer:this})}},_resetCallback:function(a){this._reset(a.hard)},_reset:function(a){if(this._tiles){var b;for(b in this._tiles)this._tiles.hasOwnProperty(b)&&(this.fire("tileunload",{tile:this._tiles[b]}),this._tiles[b]=null,delete this._tiles[b]);this._tiles={}}a&&this._container&&NUtil.clearAllNode(this._container),this._initContainer()},_update2:function(){var a=NUtil.getPosition(this._map._mapPane),b=this._map.getCenter();b.x-=a.x*this._map.getResolution(),b.y+=a.y*this._map.getResolution(),this._moveTo(b)},_setMap:function(a){if(this._map!=null||a==null)return;this._map=a,this._initContainer(),this._initEvents(),this.maxExtent=this.maxExtent||this._map.maxExtent,this.projection=this.projection||this._map.projection,this.projection&&typeof this.projection=="string"&&(this.projection=new NProjection(this.projection)),this.units=(this.projection?this.projection.getUnits():null)||this.units||this._map.getUnits(),this.resolutions||this.isBasicLayer&&this._initResolutions(),this.resolutions&&(this.resolutions.sort(function(a,b){return b-a}),this.zoomCount=this.resolutions.length,this.maxRes=this.maxRes||this.resolutions[0],this.minRes=this.minRes||this.resolutions[this.zoomCount-1]);if(!this.isBasicLayer){var b=this.getVisible();this._container.style.display=b?"":"none"}else this._map.basicLayer&&NUtil.stamp(this)!=NUtil.stamp(this._map.basicLayer)&&this.setVisible(!1);this._setTileSize(),this._reset()},_getFitRes:function(a,b,c){var d=a,e=1;if(c=="dd"){var f=.703125;d=f;for(;e<=22;e+=1,f/=2){if(a<=f&&!!b)break;if(a>=f&&!b){d=f;break}d=f}}return{level:e,res:d}},_afterAdd:function(){},_initResolutions:function(){if(this.resolutions)return;var a=this.getUnits();if(this.maxRes&&!this.zoomCount){if(this.minRes){var b=this.maxRes/this.minRes;this.zoomCount=Math.floor(Math.log(b)/Math.log(2))+1}}else if(!this.maxRes){var c=this._map.getSize(),d=this.maxExtent.getWidth()/c.x,e=this.maxExtent.getHeight()/c.y,f=Math.max(d,e);if(a=="dd"){var g=this._getFitRes(f,!0,"dd");this.maxRes=g.res,this.zoomCount=this.zoomCount||g.level}}this.zoomCount=this.zoomCount||22,this.resolutions=new Array;var h=this.maxRes;for(var i=0;i<this.zoomCount;i++)this.resolutions[i]=h,h/=2},_setTileSize:function(){},_checkInRange:function(){var a=!1;if(this._map){var b=this._map.getResolution();if(this.zoomResFixed)if(!this.isBasicLayer&&!this.resolutions)a=!0;else{a=!1;var c=0,d=this.resolutions.length;for(;c<d;c++)if(parseFloat(this.resolutions[c])==b){a=!0;break}}else a=!0;a&&((this.minRes===undefined||this.minRes===null||b>=this.minRes)&&(this.maxRes===undefined||this.maxRes===null||b<=this.maxRes)?a=!0:a=!1);if(a){var e=this._map.getExtent();this.maxExtent&&e&&!e.intersects(this.maxExtent)&&(a=!1)}}return a},_pixelToPoint:function(a){var b=null;if(a){var c=this._map.getExtent(),d=this._map.getResolution();b=new NXY(c.minX+d*a.x,c.maxY-d*a.y)}return b},_pointToPixel:function(a){var b=null;if(a!=null){var c=this._map.getResolution(),d=this._map.getExtent();b=(new NXY(1/c*(a.x-d.minX),1/c*(d.maxY-a.y))).round()}return b},_getResolution:function(){var a=this._map.getZoom();return this._getResByZoom(a)},_getResolutions:function(){return this.resolutions||this._initResolutions(),this.resolutions},_getZoomByRes:function(a){if(!a)return 0;this.resolutions||this._initResolutions();if(a>this.resolutions[0])return 0;if(a<this.resolutions[this.resolutions.length-1])return this.resolutions.length-1;var b,c;for(b=1,c=this.resolutions.length;b<c;b++)if(this.resolutions[b]<a&&Math.abs(this.resolutions[b]-a)>1e-6)break;return b-1},_getResByZoom:function(a){a=Math.max(0,Math.min(a,this.resolutions.length-1));var b=this.resolutions[Math.round(a)];return b},_getExtent:function(){var a=null;return this._map&&(a=this._map.getBounds()),a},getZoomForBounds:function(a){if(!this._map)return 0;var b=this._map.getSize();if(a.getWidth()===0&&a.getHeight()===0)return this._map.getZoomCount()-1;var c=Math.max(a.getWidth()/b.x,a.getHeight()/b.y);return this._getZoomByRes(c)}}),NLayerOptions={maxRes:null,minRes:null,resolutions:null,units:"dd",projection:null,isBasicLayer:!1,copyright:null,attribution:null,visible:!0,opacity:1,zoomCount:18,maxExtent:new NBounds(-180,-90,180,90),tileSize:null},NOverlayLayer=NLayer.extend({initialize:function(a){this._overlays={};var b,c;if(!a)return;a=a instanceof Array?a:[a];if(a)for(b=0,c=a.length;b<c;b++)this.addOverlay(a[b])},setVisible:function(a){var b=a?!0:!1,c;this.visible=b;if(this._overlays)for(c in this._overlays)this._overlays.hasOwnProperty(c)&&this._overlays[c]&&this._overlays[c].setVisible&&this._overlays[c].setVisible(b)},redraw:function(){if(!this._map)return this},_reset:function(){},addOverlay:function(a){var b=NUtil.stamp(a);return this._overlays=this._overlays||{},this._overlays[b]=a,this._map&&this._map.addOverlays(a),this},removeOverlay:function(a){var b=NUtil.stamp(a);return delete this._overlays[b],this._map&&(this instanceof NWFSLayer?this._removeWFSOverlays(a):this._map.removeOverlays(a)),this},getBounds:function(){var a=null,b,c;for(b in this._overlays)this._overlays.hasOwnProperty(b)&&(c=this._overlays[b],c.getBounds&&(a?a.extendByBounds(c.getBounds()):a=c.getBounds()));return a},clearOverlays:function(){return this._iterateLayers(this.removeOverlay,this),this},clear:function(){this.clearOverlays()},invoke:function(a){var b=Array.prototype.slice.call(arguments,1),c,d;for(c in this._overlays)this._overlays.hasOwnProperty(c)&&(d=this._overlays[c],d[a]&&d[a].apply(d,b));return this},_setMap:function(a){this._map=a,this._iterateLayers(a.addOverlays,a)},_unsetMap:function(){if(!this._map)return this;var a=this._map;this instanceof NWFSLayer?this._iterateLayers(this._removeWFSOverlays,this):this._iterateLayers(a.removeOverlays,a),this._map=null},_iterateLayers:function(a,b){for(var c in this._overlays)this._overlays.hasOwnProperty(c)&&a.call(b,this._overlays[c])}}),NRoutesLayer=NOverlayLayer.extend({options:{isBasicLayer:!1,requestHeaders:null,routesType:"shortest",returnCoords:!0,returnDescription:!0},proxy:null,failFunc:null,successFunc:null,points:"",initialize:function(a,b,c){this.name=a,this.setUrl(b),this.setRoutesLayerOptions(c)},setRoutesLayerOptions:function(a){a=a||{},a.startMarkerOptions=a.startMarkerOptions||{},a.endMarkerOptions=a.endMarkerOptions||{},a.passMarkerOptions=a.passMarkerOptions||{},this.options=NUtil.extend({},NRoutesLayerOptions,a),this.options.startMarkerOptions=NUtil.extend({},NRoutesLayerOptions.startMarkerOptions,a.startMarkerOptions),this.options.endMarkerOptions=NUtil.extend({},NRoutesLayerOptions.endMarkerOptions,a.endMarkerOptions),this.options.passMarkerOptions=NUtil.extend({},NRoutesLayerOptions.passMarkerOptions,a.passMarkerOptions)},setUrl:function(a){this.url=a},setMode:function(a){if(!this._map)return;a=a.toUpperCase(),this._map.setMode("dragzoom"),a==="ADD_START_MARKER"?this._map.on("click",this._addStartMarkerFunc,this):a==="ADD_END_MARKER"?this._map.on("click",this._addEndMarkerFunc,this):a==="ADD_PASS_MARKER"&&this._map.on("click",this._addPassMarkerFunc,this)},addPassPoints:function(a){if(!a)return;a=a instanceof NXY?[a]:a;var b,c,d=a.length;if(d)for(b=0;b<d;b++)c=a[b],c instanceof NXY&&this._addPassPoint(c)},setStartPoint:function(a){a&&a instanceof NXY&&(this._startMarker?this._startMarker.setPosition(a):(this._startMarker=this._createMarker(a,this.options.startMarkerOptions),this.addOverlay(this._startMarker),this._startMarker.setTitle("拖动改变起点位置")))},getStartPoint:function(){return this._startMarker?this._startMarker.getPosition():null},setEndPoint:function(a){a&&a instanceof NXY&&(this._endMarker?this._endMarker.setPosition(a):(this._endMarker=this._createMarker(a,this.options.endMarkerOptions),this.addOverlay(this._endMarker),this._endMarker.setTitle("拖动改变终点位置")))},getEndPoint:function(){return this._endMarker?this._endMarker.getPosition():null},startQuery:function(){this._initParams();var a=this._getServicePoints();if(!this.url||!a||a=="")return;var b=this.routesType;if(this.options.returnCoords){var c="points="+a+"&type="+this.options.routesType+"&format=gpx-track";c=NUtil.urlAppend(this.url,c),this.proxy&&(c=this.proxy+encodeURIComponent(c)),this.loading=!0,NRequest.GET({url:c,headers:this.requestHeaders,success:this._onNaviSuccess,failure:this._onNaviFailure,scope:this})}else if(this.options.returnDescription){var d="points="+a+"&type="+this.options.routesType+"&format=gpx-route";d=NUtil.urlAppend(this.url,d),this.loading=!0,this.proxy&&(d=this.proxy+encodeURIComponent(d)),NRequest.GET({url:d,headers:this.requestHeaders,success:this._onRouteSuccess,failure:this._onRouteFailure,scope:this})}},_initParams:function(){if(this.routeFeatures){var a,b;for(a in this.routeFeatures)this.routeFeatures.hasOwnProperty(a)&&(b=this.routeFeatures[a],b&&this.removeOverlay(this.routeFeatures[a]),delete this.routeFeatures[a])}},_getServicePoints:function(){if(!this._startMarker||!this._endMarker)return"";var a=this._startMarker.getPosition(),b=this._endMarker.getPosition(),c,d,e,f=a.x+","+a.y+";";if(this._passMarkers)for(c in this._passMarkers)this._passMarkers.hasOwnProperty(c)&&(e=this._passMarkers[c],e&&(d=e.getPosition(),f+=d.x+","+d.y+";"));return f+=b.x+","+b.y,f},_addStartMarkerFunc:function(a){this.setStartPoint(a.point),this._map.off("click",this._addStartMarkerFunc),this._reactiveMapMode()},_addEndMarkerFunc:function(a){this.setEndPoint(a.point),this._map.off("click",this._addEndMarkerFunc),this._reactiveMapMode()},_addPassMarkerFunc:function(a){this.addPassPoints(a.point),this._map.off("click",this._addPassMarkerFunc),this._reactiveMapMode()},_reactiveMapMode:function(){this._map.setMode("dragzoom"),this.startQuery()},_routeEdit:function(a){this._routeEditMarker?(this._routeEditMarker.setVisible(!0),this._routeEditMarker.setPosition(a.point)):this._createDivAnchor(a.point)},clear:function(){NOverlayLayer.prototype.clear.call(this),this._routeEditMarker=null,this._startMarker=null,this._endMarker=null,this.routes=null,this._points="",this._passMarkers=null},_endRouteEdit:function(a){if(this._routeEditMarker){this._showHideTimer&&clearTimeout(this._showHideTimer);var b=this;this._showHideInterval=1e3,this._showHideTimer=setTimeout(b._hideRouteEditMarker(b),this._showHideInterval)}},_hideRouteEditMarker:function(a){var b=a;return function(){b._routeEditMarker&&b._routeEditMarker.setVisible(!1)}},_createDivAnchor:function(a){return this._routeEditMarker=new NEditDivAnchor(a,{draggable:!0}),this._routeEditMarker._featurePos=a,this._routeEditMarker.on("drag",this._onDivAnchorDrag,this),this._routeEditMarker.on("dragend",this._onDivAnchorDragEnd,this),this.addOverlay(this._routeEditMarker),this._routeEditMarker.setTitle("拖动设置途经位置"),this._routeEditMarker},_onDivAnchorDrag:function(a){var b=a.target},_createMarker:function(a,b){b=NUtil.extend({draggable:!0},b);var c=new NMarker(a,b);return c.on("dragend",this._changePassMarker,this),NUtil.stamp(c),c},_removePassMarker:function(a){var b=a.target,c=NUtil.stamp(b);this.removeOverlay(b),delete this._passMarkers[c],this.startQuery()},_changePassMarker:function(a){var b=a.target;this.startQuery()},_onDivAnchorDragEnd:function(a){var b=a.target,c=b.getPosition();this._addPassPoint(c),this.startQuery()},_addPassPoint:function(a){var b=this._createMarker(a,this.options.passMarkerOptions);b.on("click",this._removePassMarker,this);var c=NUtil.stamp(b);this._passMarkers=this._passMarkers||{},this._passMarkers[c]=b,this.addOverlay(b),b.setTitle("点击移除 拖动更改")},_onNaviSuccess:function(a){var b=a.responseText,c=new NParser.XML,d=c.read(b);d||this._onNaviFailure(a);var e=d.getElementsByTagName("trk");if(e&&e.length>0){var f=e[0],g=f.getElementsByTagName("trkseg");if(g&&g.length>0)for(var h=0,i=g.length;h<i;h++){var j=g[h];if(j){var k=new Array,l=j.getElementsByTagName("trkpt");if(l&&l.length>0)for(var m=0,n=l.length;m<n;m++){var o=l[m];if(o&&o.attributes&&o.attributes.length>=2){var p=null,q=null;for(var r=0,s=o.attributes.length;r<s;r++)o.attributes[r].nodeName=="lat"?q=o.attributes[r].nodeValue:o.attributes[r].nodeName=="lon"&&(p=o.attributes[r].nodeValue);if(p==null||q==null)continue;k.push(new NXY(p,q))}}if(k.length>1){this.routeFeatures=this.routeFeatures||{};var t=new NPolyline(k,this.options.routesStyleOptions),u=NUtil.stamp(t);t.on("mousemove",this._routeEdit,this),t.on("mouseout",this._endRouteEdit,this),this.addOverlay(t),this.routeFeatures[u]=t}}}}if(this.options.returnDescription){var v=this.url,w=this._getServicePoints();if(!v||!v||v=="")return!1;var x="points="+w+"&type="+this.options.routesType+"&format=gpx-route";x=NUtil.urlAppend(this.url,x),this.proxy&&(x=this.proxy+encodeURIComponent(x)),NRequest.GET({url:x,headers:this.requestHeaders,success:this._onRouteSuccess,failure:this._onRouteFailure,scope:this})}else this.successFunc!=null&&this.successFunc(a)},_onNaviFailure:function(a){this.failFunc!=null&&this.failFunc(a)},_onRouteSuccess:function(a){var b=a.responseText,c=new NParser.XML,d=c.read(b);d||this._onRouteFailure(a);var e=d.getElementsByTagName("rte");if(e&&e.length>0){this.routes=new Array;var f=e[0],g=f.getElementsByTagName("rtept");if(g&&g.length>0)for(var h=0,i=g.length;h<i;h++){var j=g[h];if(j){var k=new Array;if(!j.attributes||j.attributes.length<2)continue;var l=null,m=null;for(var n=0,o=j.attributes.length;n<o;n++)j.attributes[n].nodeName=="lat"?m=j.attributes[n].nodeValue:j.attributes[n].nodeName=="lon"&&(l=j.attributes[n].nodeValue);if(l==null||m==null)continue;k.loc=new NXY(l,m);var p=j.getElementsByTagName("name");if(!p||p.length<1)continue;k.name=p[0].firstChild.nodeValue;var q=j.getElementsByTagName("desc");if(!q||q.length<1)continue;k.desc=q[0].firstChild.nodeValue,this.routes.push(k)}}}else this._onRouteFailure(a);this.successFunc!=null&&this.successFunc(a)},_onRouteFailure:function(a){this.failFunc!=null&&this.failFunc(a)}}),NRoutesLayerOptions={routesType:"shortest",returnCoords:!0,returnDescription:!0,startMarkerOptions:{imgUrl:NEWMAP_JS_LIB.NEWMAP_LIB_IMAGE_URL+"qidian.gif",shadowUrl:"",markerSize:new NXY(19,22),markerAnchor:new NXY(10,22),dialogAnchor:new NXY(0,-21),markerTitle:"拖动改变起点位置",popable:!0,clickable:!0,draggable:!0,zIndexOffset:7e3},endMarkerOptions:{imgUrl:NEWMAP_JS_LIB.NEWMAP_LIB_IMAGE_URL+"zhongdian.gif",shadowUrl:"",markerSize:new NXY(19,22),markerAnchor:new NXY(10,22),dialogAnchor:new NXY(0,-21),markerTitle:"拖动改变终点位置",popable:!0,clickable:!0,draggable:!0,zIndexOffset:7e3},passMarkerOptions:{imgUrl:NEWMAP_JS_LIB.NEWMAP_LIB_IMAGE_URL+"tujingdian.gif",shadowUrl:"",markerSize:new NXY(19,22),markerAnchor:new NXY(10,22),dialogAnchor:new NXY(0,-21),markerTitle:"点击移除 拖动更改途经点位置",popable:!0,clickable:!0,draggable:!0},routesStyleOptions:{}},NWFSLayer=NOverlayLayer.extend({isBasicLayer:!1,layerType:"NWFSLayer",formatOptions:null,formatObject:null,format:null,getAttributes:!1,_DEFAULT_PARAMS:{service:"WFS",REQUEST:"GetFeature",VERSION:"1.0.0",MAXFEATURES:1e3,TYPENAME:null},initialize:function(a,b,c,d){this.name=a,this.url=encodeURI(b),this.layerType="NWFSLayer",d==undefined&&(d={});var e;for(key in c)this._DEFAULT_PARAMS.hasOwnProperty(key.toUpperCase())?this._DEFAULT_PARAMS[key.toUpperCase()]=c[key]:e[key]=c[key];this._params=this._DEFAULT_PARAMS,this._params=NUtil.applyDefaults(e,NUtil.upperCaseObject(this._DEFAULT_PARAMS)),NUtil.extend(d,{reportError:!1}),NUtil.setOptions(this,d,!0)},_setMap:function(a){this._map=a;var b={getAttributes:this.getAttributes};NUtil.extend(b,this.formatOptions),this._map&&!this.projection===this._map.getProjection()&&(b.externalProjection=this.projection,b.internalProjection=this._map.getProjection()),this.formatObject=this.format?new this.format(b):new NParser.GML(b);var c=this._map.getExtent();this._moveTo(c,!0,!1)},_moveTo:function(a,b,c){if(c)return;a==null&&(a=this._map.getExtent()),NLayer.prototype._moveTo.call(this,a),this._params.BBOX=a.minX+","+a.minY+","+a.maxX+","+a.maxY;var d=this.getFullRequestString();this._loadFeatures(encodeURI(d),this._requestSuccess)},_loadFeatures:function(a,b,c){this.request&&this.request.abort(),NRequest.GET({url:a,success:b,failure:c,scope:this})},_requestSuccess:function(a){var b=a.responseXML;if(!b||!b.documentElement)b=a.responseText;if(this._overlays)for(var c in this._overlays)this.removeOverlay(this._overlays[c]);var d=this.formatObject.read(b);for(var e=0;e<d.length;e++)d[e].setVisible(this.visible),this.addOverlay(d[e])},getFullRequestString:function(){var a="",b="";this.getProjection()&&this._map.getProjection()&&(b=this.getProjection().getSrsCode()||this._map.getProjection().getSrsCode());if(this._params){var c;this._params.SRS=b==""?null:b;for(c in this._params)this._params.hasOwnProperty(c)&&(a==""&&c=="REQUEST"?a+=c+"="+this._params[c]:this._params[c]&&(a+="&"+c+"="+this._params[c]))}var d=NUtil.urlAppend(this.url,a);return d},_removeWFSOverlays:function(a){var b=a instanceof Array?a:[a],c,d;for(var e in b)c=b[e],c&&(d=NUtil.stamp(c),this._map.hasOverlay(d)&&(delete this._map._overlays[d],c._unsetMap(this._map),this._map.fire("overlayremoved",{overlay:c})))}}),NGridLayer=NLayer.extend({_nullTag:-1,singleTile:!1,tileSize:new NXY(256,256),tileOrigin:new NXY(-180,90),zoomResFixed:!0,format:"image/png",isBasicLayer:!0,serverResolutions:null,_tiles:{},initialize:function(a,b,c){this.name=a,this.layerType="NGridLayer",this.setUrl(b),NUtil.setOptions(this,c,!0),this._createTileProto()},setUrl:function(a){this.url=a},getTileSize:function(){return this.tileSize},getFormat:function(a,b){a||(a=this.format),a=a.toLowerCase();var c={png:"image/png",jpg:"image/jpeg",gif:"image/gif"},d,e=b?"image/png":"png";for(d in c)c.hasOwnProperty(d)&&(d==a||c[d]==a)&&(e=b?c[d]:d);return e},_getZByRes:function(a){var b,c;if(this.isBasicLayer&&this._map&&this._map.basicLayer&&NUtil.stamp(this)!=NUtil.stamp(this._map.basicLayer))return this._nullTag;if(!this.zoomResFixed&&this._map)return this._map.getResolution();if(this.serverResolutions){for(b in this.serverResolutions)if(this.serverResolutions[b]==a)return b}else if(this.resolutions)for(b=0,c=this.resolutions.length;b<c;b+=1)if(this.resolutions[b]==a)return b;return this._nullTag},stopLoadImg:function(){var a=this._container;if(!a)return;var b=a.getElementsByTagName("img"),c,d,e;for(c=0,d=b.length;c<d;c++)e=b[c],e&&!e.complete&&(e.onload=NUtil.falseFn,e.onerror=NUtil.falseFn,e.src="",e.parentNode.removeChild(e))},_reset:function(a){var b;for(b in this._tiles)this._tiles.hasOwnProperty(b)&&(this.fire("tileunload",{tile:this._tiles[b]}),this._tiles[b]=null,delete this._tiles[b]);this._tiles={},this._tilesToLoad=0,this.options.reuseTiles&&(this._unusedTiles=[]),a&&this._container&&(NUtil.clearAllNode(this._container),this._container.innerHTML=""),this._initContainer()},_moveingTag:!1,_moveTo:function(a,b){if(this._moveingTag&&b)return;this._moveingTag=!0,NLayer.prototype._moveTo.call(this,a);if(!this.getVisible()){this._container&&this._container.children.length>0&&this._reset(!0),this._moveingTag=!1;return}var c=this._map.getResolution();a||(a=this._map.getExtent());if(!a)return this._moveingTag=!1,this;var d=a.getCenter(),e,f,g=this.tileSize.x*c,h=this.tileSize.y==this.tileSize.x?g:this.tileSize.y*c,i=Math.floor((a.minX-this.tileOrigin.x)/g);e=Math.floor((d.x-this.tileOrigin.x)/g);var j=this.tileOrigin.x+i*g,k,l;this._rightAlias?(f=Math.floor((d.y-this.tileOrigin.y)/h),k=Math.floor((a.maxY-this.tileOrigin.y)/h),l=this.tileOrigin.y+(k+1)*h):(f=Math.floor((this.tileOrigin.y-d.y)/h),k=Math.floor((this.tileOrigin.y-a.maxY)/h),l=this.tileOrigin.y-k*h);var m=new NXY(e,f),n=Math.round((j-a.minX)/c),o=Math.round((a.maxY-l)/c),p,q,r,s,t=i,u=k,v,w=NUtil.getPosition(this._map._mapPane),x,y,z=o-w.y,A=n-w.x,B=this._rightAlias?-1:1,C=this._getZByRes(c),D=[],E=null;if(C!=this._nullTag)for(p=j;p<=a.maxX;p+=g,t+=1){u=k;for(q=l;q>=a.minY;q-=h,u+=B)D.push(new NXY(t,u))}D.sort(function(a,b){return a.distanceTo(m)-b.distanceTo(m)}),this._tilesToLoad=D.length,this._filledTag=!1;var F,G;for(F=0,G=this._tilesToLoad;F<G;F++){r=C+":"+D[F].y+":"+D[F].x,x=(D[F].x-i)*this.tileSize.x+A,y=(D[F].y-k)*this.tileSize.y,y<0&&(y=-y),y+=z;if(this._tiles.hasOwnProperty(r)){b||NUtil.setPosition(this._tiles[r],new NXY(x,y)),this._tilesToLoad--;continue}if(this.getTileUrlByExtent){s=this._createTile(),NUtil.setPosition(s,new NXY(x,y)),s._layer=this,s.onload=this._tileOnLoad,s.onerror=this._tileOnError,E=this.getTileUrlByExtent(new NBounds(p,q-h,p+g,q));if(!E){s=null;continue}s.src=E}else s=this._getTile(C,D[F].y,D[F].x,new NXY(x,y));if(!s){this._tilesToLoad--;continue}s._key=r,v=NUtil.getPosition(this._map._mapPane);if(!v.equals(w)){this._filledTag=!0,this._moveingTag=!1;break}NUtil.Browser.ie&&this.opacity!=undefined&&(this.opacity=this.opacity>1?1:this.opacity,this.opacity=this.opacity<0?0:this.opacity,this.opacity<1&&NUtil.setOpacity(s,this.opacity)),this._container.appendChild(s),this._tiles[r]=s,s=null}this._filledTag=!0;if(!b||this._container.children.length>80){var H=new NBounds(i,k,t,u);this._removeOtherTiles(H)}return this._moveingTag=!1,this},_getTile:function(a,b,c,d){var e=this._createTile();NUtil.setPosition(e,d),e._layer=this,e.onload=this._tileOnLoad,e.onerror=this._tileOnError;var f=this._getTileUrl(a,b,c,d);return f?(e.src=f,e):null},_tileBuffer:4,_removeOtherTiles:function(a){var b=this._getZByRes(this._map.getResolution()),c,d,e,f,g,h;if(a)for(g in this._tiles)if(this._tiles.hasOwnProperty(g)){c=g.split(":"),f=parseFloat(c[0]),d=parseInt(c[2],10),e=parseInt(c[1],10);if(b==this._nullTag||f!=b||d<a.minX-this._tileBuffer||d>a.maxX+this._tileBuffer||e<a.minY-this._tileBuffer||e>a.maxY+this._tileBuffer)h=this._tiles[g],this._removeTile(h),this._tiles[g]=null,delete this._tiles[g]}var i=this._container.getElementsByTagName("img");if(i&&i.length)for(var j=i.length-1;j>=0;j--)h=i[j],h&&h._key&&(c=h._key.split(":"),f=parseInt(c[0],10),(b==this._nullTag||f!=b||!this._tiles[h._key])&&this._removeTile(h));return this},_removeTile:function(a){if(!a)return;this.fire("tileunload",{tile:a,url:a.src}),a.parentNode===this._container&&this._container.removeChild(a)},_getTileUrl:function(a,b,c){return null},_createTileProto:function(){this._tileImg=NUtil.create("img","newmap-tile"),this._tileImg.galleryimg="no";var a=this.tileSize;this._tileImg.style.width=a.x+"px",this._tileImg.style.height=a.y+"px"},_createTile:function(){var a;return a=this._tileImg.cloneNode(!1),a.onselectstart=a.onmousemove=NUtil.falseFn,a},_tileOnLoad:function(a){var b=
this._layer;if(!b)return;this.className+=" newmap-tile-loaded",b.fire("tileload",{tile:this,url:this.src}),b._tilesToLoad--,b._tilesToLoad||(b.fire("loaded"),b.isBasicLayer&&b._map&&b._map.fire("basiclayerloaded"))},_tileOnError:function(a){var b=this._layer;b.fire("tileerror",{tile:this,url:this.src}),NUtil.Browser.ie?(b._tilesToLoad--,this.parentNode&&this.parentNode.removeChild(this),b._tilesToLoad||(b.fire("loaded"),b.isBasicLayer&&b._map&&b._map.fire("basiclayerloaded"))):this.src=NUtil.defaultImageUrl}}),NWMSLayer=NGridLayer.extend({singleTile:!0,zoomResFixed:!1,defaultParams:{SERVICE:"WMS",REQUEST:"GetMap",VERSION:"1.3.0",LAYERS:"",STYLES:"",FORMAT:"image/jpeg",TRANSPARENT:!1},initialize:function(a,b,c,d){NGridLayer.prototype.initialize.call(this,a,b,c),this._params=d||{},this._params=NUtil.extend({},this.defaultParams,this._params);if(this.url){var e=NUtil.getParameters(this.url);this._params=NUtil.extend(this._params,e)}},setUrl:function(a){this.url=a;if(this.url&&this._params){var b=NUtil.getParameters(this.url);this._params=NUtil.extend(this._params,b)}},setParams:function(a){this._params=this._params||{},NUtil.extend(this._params,a)},getTileUrlByExtent:function(a){return this._map?this._getUrl(a,this.tileSize):null},getTileSize:function(){return this.singleTile&&this._map?this._map.getSize():this.tileSize},_moveTo:function(a){return this.singleTile?this._moveToSingleTile(a):NGridLayer.prototype._moveTo.call(this,a)},_moveToSingleTile:function(a){NLayer.prototype._moveTo.call(this,a);if(!this.getVisible()){this._container&&this._container.children.length>0&&this._reset(!0);return}var b=this._map.getResolution();a||(a=this._map.getExtent());var c=NUtil.getPosition(this._map._mapPane),d=-c.x,e=-c.y;this._sIdKey=this._sIdKey?this._sIdKey+1:1;var f=this._getSingleTile(a);if(f){NUtil.setPosition(f,new NXY(d,e));var g="id:"+this._sIdKey;f.id=g,this._tilesToLoad=1,this._tiles[g]=f,this._container.appendChild(f)}return this._clearOtherTiles(),this},_clearOtherTiles:function(){if(!this._tiles)return;var a="id:"+this._sIdKey,b;if(this._container)for(var c=this._container.children.length-1;c>=0;c--){var b=this._container.children[c];if(b&&b.id!=a){this._tiles[b.id]=null,delete this._tiles[b.id];var d=this._container.removeChild(b);d=null}b=null}},_removeTileById:function(a){if(!a)return;var b=this._tiles[a];b&&(this.fire("tileunload",{tile:b,url:b.src}),b.parentNode===this._container&&(this._container.removeChild(b),this._tiles[a]=null,delete this._tiles[a]))},_getSingleTile:function(a){if(!this._map)return null;var b=this._map.getSize(),c=this._getUrl(a,b);if(!c)return null;var d=this._createTile();return d._layer=this,d.onload=this._tileOnLoad,d.onerror=this._tileOnError,d.style.width=b.x+"px",d.style.height=b.y+"px",d.src=c,d},_getUrl:function(a,b){return!this._map||!a||!b||!this.url?null:this._getUrlStr(a,b)},_getUrlStr:function(a,b){var c=this._map.getProjection();if(!c)return null;var c=this._map.getProjection();if(!c)return null;var d=c.getSrsCode(),e="";if(this._params){var f;for(f in this._params)this._params.hasOwnProperty(f)&&(e!=""&&(e+="&"),e+=f+"="+this._params[f])}e+="&width="+b.x+"&height="+b.y;var g=!1;parseFloat(this._params.VERSION)>=1.3?(e+="&CRS="+d,g=c.getAxisOrder()):e+="&SRS="+d,e+="&BBOX="+a.exportToString(g);var h=NUtil.urlAppend(this.url,e);return encodeURI(h)},_getFeatureInfoStr:function(a){a=a||{};var b=this._map.getExtent(),c=this._map.getSize();a.VERSION=a.VERSION||this._params.VERSION,a.QUERY_LAYERS=a.QUERY_LAYERS||this._params.LAYERS;var d=this._map.getProjection();if(!d)return null;var d=this._map.getProjection();if(!d)return null;var e=d.getSrsCode(),f="",g=NUtil.extend({},this._params,a,{REQUEST:"GetFeatureInfo",WIDTH:c.x,HEIGHT:c.y});if(g){var h;for(h in g)g.hasOwnProperty(h)&&(f!=""&&(f+="&"),f+=h+"="+g[h])}var i=!1;parseFloat(a.VERSION)>=1.3?(f+="&CRS="+e,i=d.getAxisOrder()):f+="&SRS="+e,f+="&BBOX="+b.exportToString(i);var j=NUtil.urlAppend(this.url,f);return j}}),NDMPLayer=NWMSLayer.extend({defaultParams:{SERVICE:"WPS",REQUEST:"execute",IDENTIFIER:"GetMap",VERSION:"1.0.0",WS:"/NewMapWeb/newmapserver4/sampledata/1.2dv",FORMAT:"image/png"},initialize:function(a,b,c,d){NWMSLayer.prototype.initialize.call(this,a,b,c,d)},_getUrlStr:function(a,b){var c="service="+this._params.SERVICE+"&request="+this._params.REQUEST+"&version="+this._params.VERSION+"&Identifier="+this._params.IDENTIFIER;c+="&DataInputs=HEIGHT="+b.y+";ws="+this._params.WS+";WIDTH="+b.x,c+=";BBOX="+a.exportToString(!1),c+="&RawDataOutput=Map@mimeType="+this._params.FORMAT;var d=NUtil.urlAppend(this.url,c);return encodeURI(d)}}),NMapServerLayer=NWMSLayer.extend({defaultParams:{FORMAT:"image/jpeg",TRANSPARENT:!1},initialize:function(a,b,c,d){NWMSLayer.prototype.initialize.call(this,a,b,c,d),this.layerType="NMapServerLayer"},_getUrlStr:function(a,b){var c=this._map.getProjection();if(!c)return null;var c=this._map.getProjection();if(!c)return null;var d=c.getSrsCode(),e="";if(this._params){var f;for(f in this._params)this._params.hasOwnProperty(f)&&(e!=""&&(e+="&"),e+=f+"="+this._params[f])}e+="&width="+b.x+"&height="+b.y;var g=!1;e+="&format="+this._params.FORMAT,e+="&srsIn="+d+"&srsOut="+d,e+="&BBOX="+a.exportToString(g);var h=NUtil.urlAppend(this.url,e);return encodeURI(h)}}),NTMSLayer=NGridLayer.extend({_rightAlias:!0,initialize:function(a,b,c){NGridLayer.prototype.initialize.call(this,a,b,c),this.layerType="NTMSLayer"},setUrl:function(a){this.url=a,a&&this.url.charAt(this.url.length-1)!=="/"&&(this.url=this.url+"/")},_getTileUrl:function(a,b,c){return this.url?encodeURI(this.url+a+"/"+c+"/"+b+"."+this.getFormat(null,!1)):null}}),NTileLayer=NTMSLayer.extend({initialize:function(a,b,c){NGridLayer.prototype.initialize.call(this,a,b,c),this.layerType="NTileLayer"},setUrl:function(a){this.url=a;if(a){var b=(a+" ").split(/[?&]/);this.url+=b.pop()===" "?"":b.length?"":"?"}},_getTileUrl:function(a,b,c){return this.url?encodeURI(this.url+"z="+a+"&x="+c+"&y="+b):null}}),NWMTSLayer=NGridLayer.extend({_rightAlias:!1,serviceMode:"KVP",version:"1.0.0",tileMatrixSet:null,layer:null,style:null,initialize:function(a,b,c){NGridLayer.prototype.initialize.call(this,a,b,c),this.layerType="NWMTSLayer",this.setUrl(b)},getServiceMode:function(){return this.serviceMode.toUpperCase()},setServiceMode:function(a){a=a||"KVP";var b=a.toUpperCase();if(b==this.serviceMode)return;if(b=="KVP"||b=="RESTFUL")this.serviceMode=b,this.setUrl(this.url)},setUrl:function(a){this.url=a;if(this.serviceMode=="KVP"){var b=this.url.split("?");this._wmtsUrlParams=null;if(b.length==2){var c=b[1],d=c.split("&");if(d.length>0){var e,f,g,h;for(e=0,f=d.length;e<f;e++){g=d[e];if(!g||g.length<3)continue;h=g.split("=");if(h.length!=2)continue;this._wmtsUrlParams||(this._wmtsUrlParams=[]),this._wmtsUrlParams[h[0].toUpperCase()]=h[1]}}}else this.url.charAt(this.url.length-1)!="?"&&(this.url=this.url+"?")}else this.serviceMode=="RESTFUL"&&this.url.charAt(this.url.length-1)!="/"&&(this.url=this.url+"/")},getUrl:function(){return this.url},_getTileUrl:function(a,b,c){if(!this.url)return null;var d=this.url;if(this.getServiceMode()=="KVP"){!this._wmtsUrlParams&&d.charAt(d.length-1)!="?"&&(d+="?");var e,f={SERVICE:"WMTS",REQUEST:"GetTile",VERSION:this.version,LAYER:this.layer,STYLE:this.style,TILEMATRIXSET:this.tileMatrixSet,TILEMATRIX:a,TILEROW:b,TILECOL:c,FORMAT:this.format};for(e in f)if(f.hasOwnProperty(e)){if(this._wmtsUrlParams&&this._wmtsUrlParams.hasOwnProperty(e)||f[e]==null)continue;d.charAt(d.length-1)!="?"&&d.charAt(d.length-1)!="&"&&(d+="&"),d+=e+"="+f[e]}}else d.charAt(d.length-1)!="/"&&(d+="/"),d+=this.layer+"/"+this.style+"/"+this.tileMatrixSet+"/"+a+"/"+b+"/"+c+"."+this.getFormat(null,!1);return encodeURI(d)}}),NWWLayer=NGridLayer.extend({_rightAlias:!0,tileSize:new NXY(512,512),tileOrigin:new NXY(-180,-90),serverResolutions:new Array(.0703125,.03515625,.017578125,.0087890625,.00439453125,.002197265625,.0010986328125,.00054931640625,.000274658203125,.0001373291015625,6866455078125e-17,34332275390625e-18,171661376953125e-19,858306884765625e-20,4291534423828125e-21,21457672119140625e-22,10728836059570312e-22,5.364418029785156e-7,2.682209014892578e-7,1.341104507446289e-7,6.705522537231445e-8),initialize:function(a,b,c){NGridLayer.prototype.initialize.call(this,a,b,c),this.layerType="NWWLayer"},setUrl:function(a){this.url=a,a&&this.url.charAt(this.url.length-1)!=="/"&&(this.url=this.url+"/")},_getTileUrl:function(a,b,c){if(!this.url)return null;var d=[this.url,a,this._zeroPad(b,4),this._zeroPad(b,4)+"_"+this._zeroPad(c,4)+"."+this.getFormat(null,!1)],e=d.join("/");return encodeURI(e)},_zeroPad:function(a,b){var c=a.toString(10),d=[];for(var e=0;e<b;++e)d.push("0");return d.join("").substring(0,b-c.length)+c}}),NEDSLayer=NGridLayer.extend({_rightAlias:!1,tileSize:new NXY(256,256),tileOrigin:new NXY(-20037508.342787,20037508.342787),projection:"EPSG:3857",rangle:Math.PI/180*60,anchorOrigin:new NXY(13263842,4399078),initialize:function(a,b,c){NGridLayer.prototype.initialize.call(this,a,b,c),this.layerType="NWWLayer"},setUrl:function(a){this.url=a},_getTileUrl:function(a,b,c){if(!this.url)return null;var d=17-a,e=this.url+d+"/"+c+","+b+".jpg";return encodeURI(e)},getPointFromEPoint:function(a){var b=this.anchorOrigin.x,c=this.anchorOrigin.y,d=a.x,e=a.y;return d-=b,e-=c,x1=d*Math.cos(this.rangle)-e*Math.sin(this.rangle),y1=d*Math.sin(this.rangle)+e*Math.cos(this.rangle),x1+=b,y1+=c,new NXY(x1,y1)},getEpointFromPoint:function(){var a=this.anchorOrigin.x,b=this.anchorOrigin.y,c=epoi.x,d=epoi.y;c-=a,d-=b,x1=c*Math.cos(-this.rangle)-d*Math.sin(-this.rangle),y1=c*Math.sin(-this.rangle)+d*Math.cos(-this.rangle),x1+=a,y1+=b}}),NCacheLayer36=NTMSLayer.extend({initialize:function(a,b,c){NGridLayer.prototype.initialize.call(this,a,b,c),this.layerType="NCacheLayer36"},setUrl:function(a){this.url=a},_getTileUrl:function(a,b,c){if(!this.url)return null;var d=c*256,e=(b*-1-1)*256,f=1536,g=Math.floor(d/f)*f,h=Math.floor(e/f)*f,i=this._map.getResolution(),j=this._map.getScale();j=parseInt(j);var k="png";this.format=this.format.toLowerCase();if(this.format=="jpg"||this.format=="image/jpeg")k="jpg";var l=this.url;return l+="/"+j+"/"+this.layer+"/def"+"/t"+h+"/l"+g+"/t"+e+"l"+d+"."+k,l}}),NWWLayer36=NCacheLayer36.extend({initialize:function(a,b,c){NGridLayer.prototype.initialize.call(this,a,b,c),this.layerType="NWWLayer"},_getTileUrl:function(a,b,c){if(!this.url)return null;var d=this._zeroPad(c,4),e=this._zeroPad(b,4),f="jpg",g=e+"_"+d+".jpg",h=this.url;return h+="/"+a+"/"+e+"/"+g,h},_zeroPad:function(a,b){var c=a.toString(10),d=[];for(var e=0;e<b;++e)d.push("0");return d.join("").substring(0,b-c.length)+c}}),NControl=NClass.extend({options:{position:"topright",posxy:new NXY(0,0)},_type:"NControl",singleAlive:!0,initialize:function(a){NUtil.setOptions(this,a)},getType:function(){return this._type},getPosition:function(){return this.options.position},setPosition:function(a){if(!a||typeof a!="string")return;var b=this._map;return b&&b.removeControl(this),a=a.toLowerCase(),this.options.position=a,b&&b.addControl(this),this},getPosxy:function(){return this.options.posxy},setPosxy:function(a){if(!!a&&a instanceof NXY){var b=this._map;return b&&b.removeControl(this),this.options.posxy=a,b&&b.addControl(this),this}return},_setMap:function(a){this._map=a;if(!this._container){this._container=this._initContainer();var b=this.getPosxy();b&&this.moveTo(b)}var c=this._container,d=this.getPosition(),e=a._subControlDivs[d];return NUtil.addClass(c,"newmap-control"),d.indexOf("bottom")!==-1?e.insertBefore(c,e.firstChild):e.appendChild(c),this},moveTo:function(a){if(a!=null&&this._container!=null){var b=this.getPosition();if(b=="topleft")this._container.style.top=a.y+"px",this._container.style.left=a.x+"px";else if(b=="topright")this._container.style.top=a.y+"px",this._container.style.right=a.x+"px";else if(b=="bottomleft")this._container.style.bottom=a.y+"px",this._container.style.left=a.x+"px";else{if(b!="bottomright")return;this._container.style.bottom=a.y+"px",this._container.style.right=a.x+"px"}}},_createButton2:function(a,b,c,d,e){var f=NUtil.create("a","newmap-button "+b,c);return f.href="#",f.title=a,NEvent.addListener(f,"click",NEvent.stopPropagation).addListener(f,"click",NEvent.preventDefault).addListener(f,"click",d,e),f},_createButton:function(a,b,c,d,e){var f=NUtil.create("div","newmap-button "+b,c);return a&&(f.title=a),NEvent.addListener(f,"click",NEvent.stopPropagation).addListener(f,"click",NEvent.preventDefault),f},_setButtonClassName:function(a,b){a&&(a.className="newmap-button "+b)},_unsetMap:function(a){var a=a||this._map,b=this.getPosition(),c=a._subControlDivs[b];return c.removeChild(this._container),this._onRemove&&this._onRemove(a),this}}),NPanZoomControl=NControl.extend({_type:"NPanZoomControl",_initContainer:function(){var a=this._map,b="newmap-control-zoom",c=NUtil.create("div",b);return this._createButton2("Zoom in",b+"-in",c,a.zoomIn,a),this._createButton2("Zoom out",b+"-out",c,a.zoomOut,a),c}}),NPanZoomBarControl=NControl.extend({options:{position:"topleft",zoomStep:6,heightWithoutSlider:86,zoomControlTop:45,zoominBtHeight:21,zoominBtShadow:6,sliderHeight:11,levelTagHeight:21,useLevelTag:!0,useZoomBarTag:!0,levelTagResOptions:{1:.17578125,2:.010986328125,3:.0006866455078125,4:4291534423828125e-20}},_type:"NPanZoomBarControl",initialize:function(a){NUtil.setOptions(this,a)},_initContainer:function(){var a=this._map,b="newmap-control-panzoombar",c=NUtil.create("div",b);return this._container=c,NUtil.stamp(this._container),this._pancontrol=NUtil.create("div","pancontrol",c),this._panleftbt=this._createButton("左移","panleftbt",this._pancontrol),this._panrightbt=this._createButton("右移","panrightbt",this._pancontrol),this._pantopbt=this._createButton("上移","pantopbt",this._pancontrol),this._panbottombt=this._createButton("下移","panbottombt",this._pancontrol),this._zoomcontrol=NUtil.create("div","zoomcontrol",c),this._zoominbt=this._createButton("放大","zoominbt",this._zoomcontrol),this._zoomoutbt=this._createButton("缩小","zoomoutbt",this._zoomcontrol),this.options.useZoomBarTag&&(this._zoombardiv=NUtil.create("div","barcontrol",this._zoomcontrol),this._sliderbarbg=NUtil.create("div","sliderbarbg",this._zoombardiv),this._sliderbartop=NUtil.create("div","sliderbartop",this._zoombardiv),this._sliderbt=this._createButton(null,"sliderbt",this._zoombardiv)),this._updateContainer(),this._levelTagResObj=this.options.useZoomBarTag&&this.options.useLevelTag?this._getLevelTagObject():null,this._initLevelTagResDivs(),this._initEvents(),c},_initLevelTagResDivs:function(){if(!this._levelTagResObj||!this._map)return;var a=this._map.getZoomCount(),b=this,c,d,e,f,g,h,i="leveltag-",j=this.options.zoomStep,k=this.options.zoomControlTop,l=this.options.zoominBtHeight,m=this.options.levelTagHeight/2,n=this.options.zoominBtShadow;this._levelTagBts=[];for(c in this._levelTagResObj)if(this._levelTagResObj.hasOwnProperty(c)){g=this._levelTagResObj[c];if(g){f=g.tag,d=g.zoom,e=g.res,h=(a-d)*j-m,this._levelTagBts[f]=this._createButton(null,i+f,this._zoombardiv),this._levelTagBts[f].style.top=h+"px";var o=function(a){return function(c){b._map.setView(null,a)}}(d);NEvent.addListener(this._levelTagBts[f],"click",o)}}this._setLevelTagDivs(!1)},_getLevelTagObject:function(){var a=this._map.getResolutions(),b,c,d=a.length,e,f,g,h=-1,i=this.options.levelTagResOptions;maxRes=a[0],minRes=a[a.length-1];var j={};for(b in i)if(i.hasOwnProperty(b)){e=i[b],h=NUtil.getSuiteIndex(e,a);if(h==-1)continue;f="t"+h;if(!j.hasOwnProperty(f)||i[j[f].tag]<e)j[f]={zoom:h,tag:b,res:a[h]}}return j},_updateContainer:function(){var a=this._map,b=a.getZoomCount(),c=a.getZoom();this.options.useZoomBarTag||(b=0);var d=this.options.zoomStep,e=this.options.zoomControlTop,f=this.options.zoominBtHeight,g=this.options.sliderHeight,h=this.options.zoominBtShadow,i=f+e-h,j=d*b+h,k=j+2*f-h;this._zoomcontrol.style.height=k+"px";var l=i+j;this._zoomoutbt.style.top=l+"px";var m=0,n=0;this.options.useZoomBarTag&&(this._zoombardiv.style.height=j+"px",this._sliderbarbg.style.height=j+"px",m=(c+1)*d,this._sliderbartop.style.height=m+"px",n=j-m,this._sliderbartop.style.top=n+"px",this._sliderbt.style.top=n-g/2+"px");var o=this.options.heightWithoutSlider+j;this._container.style.height=o+"px"},_initEvents:function(){if(!this._map)return;var a=this._map,b=this;NEvent.addListener(this._panleftbt,"mouseenter",function(a){b._pancontrol.className="pancontrol-left"}),NEvent.addListener(this._panleftbt,"mouseout",function(a){b._pancontrol.className="pancontrol"}),NEvent.addListener(this._panrightbt,"mouseenter",function(a){b._pancontrol.className="pancontrol-right"}),NEvent.addListener(this._panrightbt,"mouseout",function(a){b._pancontrol.className="pancontrol"}),NEvent.addListener(this._pantopbt,"mouseenter",function(a){b._pancontrol.className="pancontrol-top"}),NEvent.addListener(this._pantopbt,"mouseout",function(a){b._pancontrol.className="pancontrol"}),NEvent.addListener(this._panbottombt,"mouseenter",function(a){b._pancontrol.className="pancontrol-bottom"}),NEvent.addListener(this._panbottombt,"mouseout",function(a){b._pancontrol.className="pancontrol"});var c=80;NEvent.addListener(this._panleftbt,"click",function(a){b._map.panBy(new NXY(c,0))}),NEvent.addListener(this._panrightbt,"click",function(a){b._map.panBy(new NXY(-c,0))}),NEvent.addListener(this._panbottombt,"click",function(a){b._map.panBy(new NXY(0,-c))}),NEvent.addListener(this._pantopbt,"click",function(a){b._map.panBy(new NXY(0,c))}),NEvent.addListener(this._zoominbt,"mouseenter",function(a){b._setButtonClassName(b._zoominbt,"zoominbt2")}),NEvent.addListener(this._zoominbt,"mouseout",function(a){b._setButtonClassName(b._zoominbt,"zoominbt")}),NEvent.addListener(this._zoomoutbt,"mouseenter",function(a){b._setButtonClassName(b._zoomoutbt,"zoomoutbt2")}),NEvent.addListener(this._zoomoutbt,"mouseout",function(a){b._setButtonClassName(b._zoomoutbt,"zoomoutbt")}),NEvent.addListener(this._zoominbt,"click",function(a){b._map.zoomIn()}),NEvent.addListener(this._zoomoutbt,"click",function(a){b._map.zoomOut()}),this.options.useZoomBarTag&&(NEvent.addListener(this._sliderbarbg,"click",this._onSliderBarClick,this),NEvent.addListener(this._sliderbartop,"click",this._onSliderBarTopClick,this)),NEvent.disableClickPropagation(this._container),NEvent.addListener(this._container,"click",NEvent.preventDefault),NEvent.addListener(this._container,"mouseover",this._showLevelTagDivs,this),NEvent.addListener(this._container,"mouseleave",this._hideLevelTagDivs,this),a.on("zoomend",this._updateContainer,this),a.on("changebasiclayer",this._reset,this)},_onRemove:function(){var a=this._map;a.off("zoomend",this._updateContainer),a.off("changebasiclayer",this._reset),this._container=null},_showLevelTagDivs:function(a){this._showHideTimer&&clearTimeout(this._showHideTimer),this._setLevelTagDivs(!0)},_hideLevelTagDivs:function(a){this._showHideTimer&&clearTimeout(this._showHideTimer);var b=this;this._showHideInterval=1e3,this._showHideTimer=setTimeout(b._hideLevelTagDivsTimerFunc(b),this._showHideInterval)},_hideLevelTagDivsTimerFunc:function(a){var b=a;return function(){b._setLevelTagDivs(!1)}},_setLevelTagDivs:function(a){if(this.options.useZoomBarTag&&this.options.useLevelTag&&this._levelTagBts){var b,c;for(b in this._levelTagBts)this._levelTagBts.hasOwnProperty(b)&&(c=this._levelTagBts[b],c.style.visibility=a?"inherit":"hidden")}},_reset:function(){this._map&&(this._map.removeControl(this),this._map.addControl(this))},_onSliderBarClick:function(a){if(!this._map)return;var b=this._map,c=b.getZoomCount()-1,d=NEvent.getMousePosition(a,this._sliderbarbg),e=Math.round((d.y-this.options.zoominBtShadow)/this.options.zoomStep),f=c-e;f=f>c?c:f,f=f<0?0:f,b.setView(b.getCenter(),f)},_onSliderBarTopClick:function(a){if(!this._map)return;var b=NEvent.getMousePosition(a,this._sliderbartop),c=this._map,d=c.getZoomCount()-1,e=c.getZoom(),f=Math.round(b.y/this.options.zoomStep),g=e-f;g=g>d?d:g,g=g<0?0:g,c.setView(c.getCenter(),g)}}),NScaleControl=NControl.extend({topOutUnits:"km",topInUnits:"m",_type:"NScaleControl",options:{maxWidth:100,position:"bottomleft",headStr:"比例尺："},initialize:function(a){NUtil.setOptions(this,a)},_initContainer:function(){var a=this._map,b="newmap-control-scale";this._container=NUtil.create("div",b),NUtil.stamp(this._container);var c="newmap-control-scale-pic";this._pic=NUtil.create("div",c),NUtil.stamp(this._pic);var d="newmap-control-scale-char";return this._char=NUtil.create("div",d),NUtil.stamp(this._char),this._container.appendChild(this._pic),this._container.appendChild(this._char),this._initEvents(),this._container},_initEvents:function(){var a=this._map;a.on("zoomend",this._updateScale,this)},_updateScale:function(a){var b=this._map.getResolution();if(!b)return;var c=this._map.getUnits(),d=NUtil.INCHES_PER_UNIT,e=this.options.maxWidth*b*d[c],f;e>1e5?f=this.topOutUnits:f=this.topInUnits;var g=e/d[f],h=this._getWidth(g);g=h/d[c]*d[f];var i=g/b;this._pic.style.borderStyle="groove",this._pic.style.borderTopStyle="none",this._pic.style.textAlign="center",this._pic.style.width=Math.round(i)+"px",this._pic.innerHTML=h+" "+f,this._update()},_setMap:function(a){NControl.prototype._setMap.call(this,a),this._updateScale()},_getWidth:function(a){var b=parseInt(Math.log(a)/Math.log(10)),c=Math.pow(10,b),d=parseInt(a/c),e;return d>5?e=5:d>2?e=2:e=1,e*c},_update:function(){var a=this._map.getScale();if(!a)return;a>=9500?a=Math.round(a/1e4)+"万":a=Math.round(a),this._char.style.borderStyle="none",this._char.innerHTML="比例尺 = 1 : "+a},_onRemove:function(){var a=this._map;a.off("zoomend",this._updateScale)}}),NPositionControl=NControl.extend({_type:"NPositionControl",options:{position:"bottomright",headStr:"当前位置: ",separator:" , ",tailStr:"",digitsNum:4},initialize:function(a){NUtil.setOptions(this,a)},_initContainer:function(){var a=this._map,b="newmap-control-position";return this._container=NUtil.create("div",b),NUtil.stamp(this._container),this._initEvents(),this._container},_initEvents:function(){var a=this._map;a.on("mousemove",this._updatePosition,this)},_updatePosition:function(a){if(!a||!a.point)return;var b=a.point,c=this.options.headStr+this._formatNum(b.x)+this.options.separator+this._formatNum(b.y)+this.options.tailStr;this._container.innerHTML=c},_formatNum:function(a){var b=parseInt(this.options.digitsNum);return a.toFixed(b)},_onRemove:function(){var a=this._map;a.off("mousemove",this._updatePosition)}}),NOverviewMapControl=NControl.extend({_type:"NOverviewMapControl",options:{position:"bottomright",backgroundColor:"white"},ovmap:null,size:new NXY(180,90),layer:null,minRectSize:15,minRatio:8,maxRatio:32,mapOptions:null,displayClass:"nmOverviewMapControl",resolutionFactor:3,maximized:!1,initialize:function(a){NControl.prototype.initialize.apply(this,[a])},_initContainer:function(){var a=this._map;this._container=NUtil.create("div",this.displayClass),NUtil.stamp(this._container);if(!this.layer){if(!a.basicLayer)return a.on("changebasiclayer",this.basicLayerDraw,this),this._container;var b=a.basicLayer;this.layer=b}var c=this.displayClass+"Element";this.element=NUtil.create("div",c),this.element.style.display="none",this.element.style.backgroundColor=this.options.backgroundColor,NUtil.stamp(this.element);var d=this.displayClass+"ExtentRectangle";return this.extentRectangle=NUtil.create("div",d),this.extentRectangle.style.position="absolute",this.extentRectangle.style.zIndex=1e3,NUtil.stamp(this.extentRectangle),this.mapDiv=document.createElement("div"),this.mapDiv.style.position="relative",this.mapDiv.style.width=this.size.x+"px",this.mapDiv.style.height=this.size.y+"px",this.mapDiv.style.overflow="hidden",NUtil.stamp(this.mapDiv),this.element.appendChild(this.mapDiv),this._container.appendChild(this.element),this._maximizeDIV=this._createButton("显示","nmOverviewMapControlMaximizeButton",this._container),this._minimizeDIV=this._createButton("隐藏","nmOverviewMapControlMinimizeButton",this._container),this._minimizeClick(),a.getExtent()&&this.update(),this._initEvents(),this.maximized&&this._maximizeClick(),this._container},moveTo:function(a){if(a!=null&&this._container!=null){var b=this.getPosition();if(b=="topright")this._container.style.top=a.y+"px",this._container.style.right=a.x+"px",this._maximizeDIV.style.bottom="auto",this._maximizeDIV.style.top="10px";else if(b=="bottomright")this._container.style.bottom=a.y+"px",this._container.style.right=a.x+"px";else if(b=="topleft")this._container.style.top=a.y+"px",this._container.style.left=a.x+"px",this.element.style.paddingLeft="18px",this.element.style.paddingRight="10px",this._maximizeDIV.style.bottom="auto",this._maximizeDIV.style.right="auto",this._maximizeDIV.style.top="10px",this._maximizeDIV.style.left="0px",this._minimizeDIV.style.bottom="auto",this._minimizeDIV.style.right="auto",this._minimizeDIV.style.top="10px",this._minimizeDIV.style.left="0px";else{if(b!="bottomleft")return;this._container.style.bottom=a.y+"px",this._container.style.left=a.x+"px",this.element.style.paddingLeft="18px",this.element.style.paddingRight="10px",this._maximizeDIV.style.right="auto",this._maximizeDIV.style.left="0px",this._minimizeDIV.style.right="auto",this._minimizeDIV.style.left="0px"}}},_initEvents:function(){if(!this._map)return;var a=this._map;NEvent.addListener(this._maximizeDIV,"click",this._maximizeClick,this),NEvent.addListener(this._minimizeDIV,"click",this._minimizeClick,this),a.on("moveend",this.update,this)},basicLayerDraw:function(){var a=this._map;this._initContainer(),this.map.off("changebasiclayer",this.basicLayerDraw)},_maximizeClick:function(a){this.element.style.display="",this.showToggle(!1),a!=null&&NEvent.stop(a)},_minimizeClick:function(a){this.element.style.display="none",this.showToggle(!0),a!=null&&NEvent.stop(a)},showToggle:function(a){this._maximizeDIV.style.display=a?"":"none",this._minimizeDIV.style.display=a?"none":""},update:function(){this.ovmap==null&&this.createMap(),this.isSuitableOverview()?this.updateRectToMap():this.updateOverview()},createMap:function(){var a=NUtil.extend({controls:[],maxResolution:"auto",persistEvent:!1},this.mapOptions);this.ovmap=new NMap(this.mapDiv,a),this.mapDiv.appendChild(this.extentRectangle),this.ovmap._size=new NXY(this.size.x,this.size.y),this.ovmap.addLayer(this.layer),this.ovmap.zoomToMaxExtent(),this.wComp=parseInt(NUtil.getStyle(this.extentRectangle,"border-left-width"))+parseInt(NUtil.getStyle(this.extentRectangle,"border-right-width")),this.wComp=this.wComp?this.wComp:2,this.hComp=parseInt(NUtil.getStyle(this.extentRectangle,"border-top-width"))+parseInt(NUtil.getStyle(this.extentRectangle,"border-bottom-width")),this.hComp=this.hComp?this.hComp:2,this.ovmap&&this.ovmap.on("click",this.mapDivClick,this)},mapDivClick:function(a){var b=this.rectPxBounds.getCenter(),c=a.pixel.x-b.x,d=a.pixel.y-b.y,e=this.rectPxBounds.maxY,f=this.rectPxBounds.minX,g=Math.abs(this.rectPxBounds.getHeight()),h=this.rectPxBounds.getWidth(),i=Math.max(0,e+d);i=Math.min(i,this.ovmap._size.y-g);var j=Math.max(0,f+c);j=Math.min(j,this.ovmap._size.x-h);var k=new NBounds;k.minX=j,k.minY=i+g,k.maxX=j+h,k.maxY=i,this.setRectPxBounds(k),this.updateMapToRect()},isSuitableOverview:function(){var a=this._map,b=a.getExtent(),c=a.getMaxExtent(),d=new NBounds;d.minX=Math.max(b.minX,c.minX),d.minY=Math.max(b.minY,c.minY),d.maxX=Math.min(b.maxX,c.maxX),d.maxY=Math.min(b.maxY,c.maxY);if(this.ovmap.getProjection()&&a.getProjection()&&this.ovmap.getProjection().getSrsCode()!=a.getProjection().getSrsCode()){alert("不支持投影转换");return}var e=this.ovmap.getResolution()/a.getResolution();return e>this.minRatio&&e<=this.maxRatio&&this.ovmap.getExtent().contains(d)},updateOverview:function(){var a=this._map,b=a.getResolution(),c=this.ovmap.getResolution(),d=c/b;d>this.maxRatio?c=this.minRatio*b:d<=this.minRatio&&(c=this.maxRatio*b);var e=a.getCenter();this.ovmap._setView2(e,this.ovmap.getZoomByRes(c*this.resolutionFactor),!0),this.updateRectToMap()},updateRectToMap:function(){var a=this._map,b;if(this.ovmap.getProjection()&&a.getProjection()&&this.ovmap.getProjection().getSrsCode()!=a.getProjection().getSrsCode()){alert("不支持投影转换");return}b=a.getExtent();var c=this.getRectBoundsFromMapBounds(b);c&&this.setRectPxBounds(c)},updateMapToRect:function(){var a=this._map,b=this.getMapBoundsFromRectBounds(this.rectPxBounds);if(this.ovmap.getProjection()&&a.getProjection()&&this.ovmap.getProjection().getSrsCode()!=a.getProjection().getSrsCode()){alert("不支持投影转换");return}a._setView2(b.getCenter(),a.getZoom(),!0)},setRectPxBounds:function(a){var b=Math.max(a.maxY,0),c=Math.max(a.minX,0),d=Math.min(a.maxY+Math.abs(a.getHeight()),this.ovmap.getSize().y-this.hComp),e=Math.min(a.minX+a.getWidth(),this.ovmap.getSize().x-this.wComp),f=Math.max(e-c,0),g=Math.max(d-b,0);if(f<this.minRectSize||g<this.minRectSize){this.extentRectangle.className=this.displayClass+"RectReplacement";var h=c+f/2-this.minRectSize/2,i=b+g/2-this.minRectSize/2;this.extentRectangle.style.top=Math.round(i)+"px",this.extentRectangle.style.left=Math.round(h)+"px",this.extentRectangle.style.height=this.minRectSize+"px",this.extentRectangle.style.width=this.minRectSize+"px"}else this.extentRectangle.className=this.displayClass+"ExtentRectangle",this.extentRectangle.style.top=Math.round(b)+"px",this.extentRectangle.style.left=Math.round(c)+"px",this.extentRectangle.style.height=Math.round(g)+"px",this.extentRectangle.style.width=Math.round(f)+"px";this.rectPxBounds=new NBounds,this.rectPxBounds.minX=Math.round(c),this.rectPxBounds.minY=Math.round(d),this.rectPxBounds.maxX=Math.round(e),this.rectPxBounds.maxY=Math.round(b)},getRectBoundsFromMapBounds:function(a){var b=new NXY(a.minX,a.minY),c=new NXY(a.maxX,a.maxY),d=this.getOverviewPxFromLonLat(b),e=this.getOverviewPxFromLonLat(c),f=null;return d&&e&&(f=new NBounds,f.minX=d.x,f.minY=d.y,f.maxX=e.x,f.maxY=e.y),f},getMapBoundsFromRectBounds:function(a){var b=new NXY(a.minX,a.minY),c=new NXY(a.maxX,a.maxY),d=this.getLonLatFromOverviewPx(b),e=this.getLonLatFromOverviewPx(c),f=null;return d&&e&&(f=new NBounds,f.minX=d.x,f.minY=d.y,f.maxX=e.x,f.maxY=e.y),f},getOverviewPxFromLonLat:function(a){var b=this.ovmap.getResolution(),c=this.ovmap.getExtent(),d=null;return c&&(d=new NXY(Math.round(1/b*(a.x-c.minX)),Math.round(1/b*(c.maxY-a.y)))),d},getLonLatFromOverviewPx:function(a){var b=this.ovmap._size,c=this.ovmap.getResolution(),d=this.ovmap.getExtent().getCenter(),e=a.x-b.x/2,f=a.y-b.y/2;return new NXY(d.x+e*c,d.y-f*c)},_onRemove:function(){var a=this._map;a.off("moveend",this.update,this),this.ovmap.off("click",this.mapDivClick,this),this._container=null}}),NZoomDirectionControl=NClass.extend({_container:null,_trArr:null,_tlArr:null,_brArr:null,_blArr:null,_map:null,_ArrWidth:7,_startTime:-1,_minWidth:12,_maxWidth:45,_minHeight:10,_maxHeight:36,_outTag:!0,_center:null,_zoomAnimationTimer:null,initialize:function(){this._interval=Math.round(1e3/60)},_initContainer:function(){var a=this._map._panes.tmpPane;this._container=NUtil.create("div","newmap-zoomdirect-pane",a);var b=this._container;this._tlArr=NUtil.create("div","zoomdirect-tl",b),this._trArr=NUtil.create("div","zoomdirect-tr",b),this._brArr=NUtil.create("div","zoomdirect-br",b),this._blArr=NUtil.create("div","zoomdirect-bl",b)},_setMap:function(a){if(!a||!a._mapPane||a._zoomDirectionCtrl)return;this._map=a,this._initContainer(),a._zoomDirectionCtrl=this},setMode:function(a){this._outTag=a;if(!this._container)return;var b=a?"newmap-zoomdirect-pane-out":"newmap-zoomdirect-pane";NUtil.setClass(this._container,b)},enable:function(a,b){if(!this._container||!this._map||!a)return;this.disable(),this._center=a.subtract(NUtil.getPosition(this._map._mapPane));var c=b>0?!0:!1;this.setMode(c),this._runTimerAnimation(0),NUtil.removeClass(this._container,"newmap-show"),this._startTime=NUtil.getTime();var d=this;this._zoomAnimationTimer=setInterval(d._zoomStep(d),this._interval)},_runTimerAnimation:function(a){if(!this._center){this.disable();return}var b=(this._maxWidth-this._minWidth)*a;b=this._outTag?b+this._minWidth:this._maxWidth-b;var c=(this._maxHeight-this._minHeight)*a;c=this._outTag?c+this._minHeight:this._maxHeight-c;var d=Math.round(this._center.x-b-this._ArrWidth),e=Math.round(this._center.x+b),f=Math.round(this._center.y-c-this._ArrWidth),g=Math.round(this._center.y+c);NUtil.setPosition(this._tlArr,new NXY(d,f)),NUtil.setPosition(this._trArr,new NXY(e,f)),NUtil.setPosition(this._blArr,new NXY(d,g)),NUtil.setPosition(this._brArr,new NXY(e,g))},_completeZoomAnim:function(){this.disable()},_zoomStep:function(a){var b=a;return function(){var a=NUtil.getTime(),c=a-b._startTime,d=400;c<d?b._runTimerAnimation(NUtil.getBezierPos(c/d)):(b._runTimerAnimation(1),b._completeZoomAnim())}},disable:function(){if(!this._container||!this._map)return;
this._zoomAnimationTimer&&clearInterval(this._zoomAnimationTimer),this._zoomAnimationTimer=null,this._center=null,NUtil.addClass(this._container,"newmap-show")}}),NDialog=NClass.extend({includes:NEWMAP_JS_LIB.PublicParts.Events,options:{minWidth:50,maxWidth:300,maxHeight:null,autoPan:!0,closeButton:!0,pixelOffset:new NXY(0,2),autoPanPadding:new NXY(5,5),className:""},initialize:function(a,b){NUtil.setOptions(this,a),this._source=b},_setMap:function(a){this._map=a,this._container||this._initLayout(),this._updateContent(),this._container.style.opacity="0",this._map._panes.dialogPane.appendChild(this._container),this._map.on("viewreset",this._updatePosition,this),!NUtil.Browser.android&&this._map.closeDialogOnClick&&this._map.on("click",this._close,this),this._update(),this._container.style.opacity="1",this._opened=!0},_unsetMap:function(a){a=a||this._map,a._panes.dialogPane.removeChild(this._container),NUtil.falseFn(this._container.offsetWidth),a._dlgAutoPanTag=!1,a.off("moveend",this._autoPanEnd,this),a.off("viewreset",this._updatePosition,this),!NUtil.Browser.android&&this._map.closeDialogOnClick&&a.off("click",this._close,this),this._container.style.opacity="0",this._opened=!1,this._map=null},setPosition:function(a){return this._latlng=a,this._opened&&this._update(),this},setContent:function(a){return this._content=a,this._opened&&this._update(),this},hide:function(){this._container&&NUtil.addClass(this._container,"newmap_hide")},show:function(){this._container&&NUtil.removeClass(this._container,"newmap_hide")},_close:function(){var a=this._map;a&&(this._singleDlgTag?this.hide(this):this._map.closeDialog(this))},_initLayout:function(){this._container=NUtil.create("div","newmap-dialog"),this.options.closeButton&&(this._closeButton=NUtil.create("a","newmap-dialog-close-button",this._container),this._closeButton.href="#close",NEvent.addListener(this._closeButton,"click",this._onCloseButtonClick,this)),this._wrapper=NUtil.create("div","newmap-dialog-content-wrapper",this._container),NEvent.disableClickPropagation(this._wrapper),this._contentNode=NUtil.create("div","newmap-dialog-content",this._wrapper),NEvent.addListener(this._contentNode,"mousewheel",NEvent.stopPropagation),this._tipContainer=NUtil.create("div","newmap-dialog-tip-container",this._container),this._tip=NUtil.create("div","newmap-dialog-tip",this._tipContainer)},_update:function(){if(!this._map)return;this._container.style.visibility="hidden",this._updateContent(),this._updateLayout(),this._updatePosition(),this._container.style.visibility="",this._adjustPan()},_updateContent:function(){if(!this._content)return;typeof this._content=="string"?this._contentNode.innerHTML=this._content:(this._contentNode.innerHTML="",this._contentNode.appendChild(this._content)),this.fire("dialogcontentupdate")},_updateLayout:function(){var a=this._contentNode;a.style.width="",a.style.whiteSpace="nowrap";var b=a.offsetWidth;b=Math.min(b,this.options.maxWidth),b=Math.max(b,this.options.minWidth),a.style.width=b+1+"px",a.style.whiteSpace="",this._tipContainer.style.marginLeft=b/2+2+"px",a.style.height="";var c=a.offsetHeight,d=this.options.maxHeight,e=" newmap-dialog-scrolled";d&&c>d?(a.style.height=d+"px",a.className+=e):a.className=a.className.replace(e,""),this._containerWidth=this._container.offsetWidth},_updatePosition:function(){var a=this._map._pointToAbsPixel(this._latlng);this._containerBottom=-a.y-this.options.pixelOffset.y,this._containerLeft=a.x-Math.round(this._containerWidth/2)+this.options.pixelOffset.x,this._container.style.bottom=this._containerBottom+"px",this._container.style.left=this._containerLeft+"px"},_adjustPan:function(){if(!this.options.autoPan)return;var a=this._container.offsetHeight,b=new NXY(this._containerLeft,-a-this._containerBottom),c=b.add(NUtil.getPosition(this._map._mapPane)),d=new NXY(0,0),e=this.options.autoPanPadding,f=this._map.getSize();c.x<0&&(d.x=c.x-e.x),c.x+this._containerWidth>f.x&&(d.x=c.x+this._containerWidth-f.x+e.x),c.y<0&&(d.y=c.y-e.y),c.y+a>f.y&&(d.y=c.y+a-f.y+e.y);if(d.x||d.y){if(!this._map)return;this._map._dlgAutoPanTag=!0,this._map.fire("dialogautopanstart",{dialog:this}),this._map.panBy(d),this._map.on("moveend",this._autoPanEnd,this)}},_autoPanEnd:function(){this._map&&this._map._dlgAutoPanTag&&(this._map._dlgAutoPanTag=!1,this._map.fire("dialogautopanend",{dialog:this}),this._map.off("moveend",this._autoPanEnd,this))},_onCloseButtonClick:function(a){this._close(),NEvent.stop(a)}}),NDialogOptions={minWidth:50,maxWidth:800,closeButton:!0,pixelOffset:NXY(0,2),content:""},NTipDialog=NDialog.extend({options:{minWidth:50,maxWidth:800,title:"",maxHeight:null,autoPan:!0,closeButton:!0,pixelOffset:new NXY(0,2),autoPanPadding:new NXY(5,5),className:""},initialize:function(a,b){NUtil.setOptions(this,a),this._source=b},_initLayout:function(){this._container=NUtil.create("div","newmap-tipdialog"),this._wrapper=NUtil.create("div","newmap-tipdialog-content-wrapper",this._container),NEvent.addListener(this._wrapper,"click",this._onCloseButtonClick,this),NEvent.disableClickPropagation(this._wrapper),this._thBorder=NUtil.create("div","newmap-tipdialog-thborder",this._wrapper),this._mainContDiv=NUtil.create("div","newmap-tipdialog-main-cont",this._wrapper),this._titleContDiv=NUtil.create("div","newmap-tipdialog-sub-title",this._mainContDiv),this._titleSpan=NUtil.create("span","",this._titleContDiv),this._contentNode=NUtil.create("div","newmap-tipdialog-sub-content",this._mainContDiv),this._bhBorder=NUtil.create("div","newmap-tipdialog-bhborder",this._wrapper),NEvent.addListener(this._mainContDiv,"mousewheel",NEvent.stopPropagation),NEvent.addListener(this._mainContDiv,"click",NEvent.stopPropagation),this.options.closeButton&&(this._closeButton=NUtil.create("a","newmap-dialog-close-button",this._mainContDiv),this._closeButton.href="#close",NEvent.addListener(this._closeButton,"click",this._onCloseButtonClick,this)),this._tipContainer=NUtil.create("div","newmap-tipdialog-sub-tip",this._wrapper),this._initBorder(),this._initTip()},_updateContent:function(){if(!this._content)return;typeof this.options.title=="string"&&(this._titleSpan.innerHTML=this.options.title),typeof this._content=="string"?this._contentNode.innerHTML=this._content:(this._contentNode.innerHTML="",this._contentNode.appendChild(this._content)),this.fire("dialogcontentupdate")},_updateLayout:function(){var a=this._contentNode;a.style.width="",a.style.whiteSpace="nowrap";var b=260;b=Math.min(b,this.options.maxWidth),b=Math.max(b,this.options.minWidth),a.style.width=b+2+"px",a.style.whiteSpace="",a.style.height="";var c=a.offsetHeight,d=this.options.maxHeight,e=" newmap-dialog-scrolled";d&&c>d?(a.style.height=d+"px",a.className+=e):a.className=a.className.replace(e,""),this._containerWidth=parseInt(a.style.width),this._container.style.width=this._containerWidth+2+"px"},_initBorder:function(){this._thBorder.innerHTML='<b class="newmap-tipdialog-b1" style="background-color:#005CB5;border-color:#005CB5;opacity:1;"></b><b class="newmap-tipdialog-b2" style="background-color:#005CB5;border-color:#005CB5;opacity:1;"></b><b class="newmap-tipdialog-b3" style="border-color:#005CB5;opacity:1;background:#005CB5;"></b> <b class="newmap-tipdialog-b4" style="border-color:#005CB5;opacity:1;background:#005CB5;"></b>',this._bhBorder.innerHTML='<b class="newmap-tipdialog-b3 newmap-tipdialog-back" style="border-color:#005CB5;opacity:1;background:#ffffff;"></b><b class="newmap-tipdialog-b2" style="background-color:#005CB5;border-color:#005CB5;opacity:1;"></b><b class="newmap-tipdialog-b1" style="background-color:#005CB5;border-color:#005CB5;opacity:1;"></b>'},_initTip:function(){if(!this._tipContainer)return;var a=NUtil.create("div","newmap-tipdialog-arr",this._tipContainer)}}),NTipDialogOptions={minWidth:50,maxWidth:800,closeButton:!0,pixelOffset:NXY(0,2),content:"",title:""},NOverlay=NClass.extend({initialize:function(){},setVisible:function(a){}}),NElement=NClass.extend({includes:NEWMAP_JS_LIB.PublicParts.Events,options:{title:null,content:"",offset:new NXY(0,0),zIndexOffset:0,popable:!0,clickable:!0,draggable:!1},initialize:function(a,b){NUtil.setOptions(this,b),this._latlng=a},setOpacity:function(a){if(a==undefined)return;a=Math.abs(a),a=a>1?1:a,this.options.opacity=a,this._element&&NUtil.setOpacity(this._element,a)},getPosition:function(){return this._latlng},setPosition:function(a){this._latlng=a,this._update()},setVisible:function(a){this._element&&(this._element.style.visibility=a?"inherit":"hidden")},addClass:function(a){this._element&&NUtil.addClass(this._element,a)},removeClass:function(a){this._element&&NUtil.removeClass(this._element,a)},setStyle:function(a){if(a&&this._element){var b;for(b in a)a.hasOwnProperty(b)&&(this._element.style[b]=a[b])}},setTitle:function(a){this.options.title=a,this._element&&(this._element.title=a)},enableDrag:function(){return this._map?(this.options.draggable=!0,this.dragging||(this.dragging=new NElement.Drag(this)),this.dragging.enable(),this):(this.options.draggable=this.draggable=!0,this)},disableDrag:function(){return this._map?(this.options.draggable=!1,this.dragging&&this.dragging.disable(),this):(this.options.draggable=this.draggable=!1,this)},enablePop:function(){this.options.popable=!0,this.on("mouseover",this._onMouseOver,this),this.on("mouseout",this._onMouseOut,this)},disablePop:function(){this._pushToBack(),this.options.popable=!1,this.off("mouseover",this._onMouseOver),this.off("mouseout",this._onMouseOut)},bringToFront:function(){this._popToFront()},_creatElement:function(){return null},_setMap:function(a){this._map=a,this._initElement(),a.on("viewreset",this._update,this),this._update()},_unsetMap:function(a){a=a||this._map,this._removeElement(),a.off("viewreset",this._update,this),this._map=null},_initElement:function(){if(!this._element){this._element=this._creatElement();if(!this._element)return;if(this.options.offset){var a=this.options.offset;this._element.style.marginLeft=a.x+"px",this._element.style.marginTop=a.y+"px"}this.options.title&&(this._element.title=this.options.title),this.options.opacity!==undefined&&NUtil.setOpacity(this._element,this.options.opacity),this._initInteraction()}this._map._panes.markerPane.appendChild(this._element)},setOffset:function(a){a&&(this.options.offset=a),this._element&&(this._element.style.marginLeft=a.x+"px",this._element.style.marginTop=a.y+"px")},_removeElement:function(){this._map._panes.markerPane.removeChild(this._element),this._element=null},_getMoveTarget:function(){return this._element},_getDragTarget:function(){return this._element},_update:function(){var a=this._map._pointToAbsPixel(this._latlng).round();NUtil.setPosition(this._element,a),this._poped||(this._element.style.zIndex=a.y+this.options.zIndexOffset)},_initInteraction:function(){this.options.popable&&this.enablePop(),this.options.clickable&&(this._element.className+=" newmap-clickable"),NEvent.addListener(this._element,"click",this._onMouseClick,this);var a=["dblclick","mousedown","mouseover","mouseout","mouseup"];for(var b=0;b<a.length;b++)NEvent.addListener(this._element,a[b],this._fireMouseEvent,this);this.on("mouseover",this._onMouseOver,this),this.on("mouseout",this._onMouseOut,this),this.options.draggable&&this.enableDrag()},_onMouseClick:function(a){if(this.dragging&&this.dragging.moved())return;this.fire(a.type,{originalEvent:a}),NEvent.stopPropagation(a)},_popToFront:function(){this._poped=!0,this._element&&(this._element.style.zIndex=NUtil.MaxZIndex)},_pushToBack:function(){this._poped=!1;if(!this._element)return;var a=NUtil.getPosition(this._element);isNaN(this.options.zIndexOffset)?this._element.style.zIndex="auto":this._element.style.zIndex=a.y+this.options.zIndexOffset},_onDragUpdate:function(a){this._latlng=a.point},_onMouseOver:function(a){if(this.dragging&&this.dragging.moved())return;this.options.popable&&this._popToFront(),NEvent.stopPropagation(a)},_onMouseOut:function(a){if(this.dragging&&this.dragging.moved())return;this.options.popable&&this._pushToBack(),NEvent.stopPropagation(a)},_fireMouseEvent:function(a){if(!this._map||this._map.getHegemonTag())return;this.fire(a.type,{originalEvent:a})}}),NElementOptions={title:null,offset:new NXY(0,0),zIndexOffset:0,popable:!0,clickable:!0,draggable:!1},NLabel=NElement.extend({options:{content:"",offset:new NXY(0,0),zIndexOffset:0,popable:!0,clickable:!0,draggable:!1},initialize:function(a,b){this.options=NUtil.extend({content:""},NElementOptions,b),this._latlng=a},getContent:function(){return this.options.content},setContent:function(a){this.options.content=a,this._element&&(this._element.innerHTML=this.options.content)},_creatElement:function(){var a;return a=document.createElement("label"),a.className="newmap-label",a.innerHTML=this.options.content,a.unselectable="on",a.hashCode="mz_2s",a},_initElement:function(){NElement.prototype._initElement.call(this),this.options.content&&this.setContent(this.options.content)}}),NArrowLabel=NElement.extend({options:{content:"",offset:new NXY(0,0),zIndexOffset:0,popable:!0,clickable:!0,draggable:!1},initialize:function(a,b){this.options=NUtil.extend({content:""},NElementOptions,b),this._latlng=a},getContent:function(){return this.options.content},setContent:function(a){this.options.content=a,this._element&&(this._element.innerHTML=this.options.content)},_creatElement:function(){return this._container=NUtil.create("div","newmap-arrowlab"),this._wrapper=NUtil.create("div","newmap-label-content-wrapper",this._container),NEvent.disableClickPropagation(this._wrapper),this._contentNode=NUtil.create("div","newmap-label",this._wrapper),this._contentNode.innerHTML=this.options.content,NEvent.addListener(this._contentNode,"mousewheel",NEvent.stopPropagation),this._tipContainer=NUtil.create("div","newmap-label-tip-container",this._container),this._tip=NUtil.create("div","newmap-arrowlabel",this._tipContainer),this._container}}),NEditDivAnchor=NElement.extend({options:{content:"",zIndexOffset:6e4,offset:null,clickable:!0,draggable:!0},initialize:function(a,b){NUtil.setOptions(this,b),this._latlng=a},getContent:function(){return this.options.content},setContent:function(a){this.options.content=a},_creatElement:function(){var a;return a=document.createElement("div"),a.className="newmap-div-element",this.options.content&&(a.innerHTML=this.options.content),a.unselectable="on",a.hashCode="mz_2s",a}}),NContextMenu=NClass.extend({_menuItems:null,_separators:null,initialize:function(){this._container=NUtil.create("div","newmap_contextMenu")},addItem:function(a){a&&a instanceof NMenuItem&&(this._menuItems=this._menuItems||new Array,a._setContextMenu(this),this._menuItems.push(a))},addSeparator:function(){var a=NUtil.create("div","newmap_contextMenu_sepr",this._container),b=NUtil.stamp(a);a.id=b,this._separators=this._separators||new Array,this._separators.push(b)},removeSeparator:function(a){if(this._separators&&a<this._separators.length){var b=this._separators[a],c=document.getElementById(b);c&&c.parentNode&&(this._separators.splice(a,1),this._container.removeChild(c))}},getItem:function(a){return this._menuItems&&a<this._menuItems.length?this._menuItems[a]:null},removeItem:function(a){if(a&&a instanceof NMenuItem&&this._menuItems){var b,c=NUtil.stamp(a);for(var d=0;d<this._menuItems.length;d++)if(this._menuItems[d]){b=NUtil.stamp(this._menuItems[d]);if(b==c){this._menuItems.splice(d,1),this._menuItems[d]._unsetContextMenu();return}}}},show:function(a){this.posObjects=a,this._container.style.display="block",NUtil.setPosition(this._container,a.pixel)},hide:function(){this._container.style.display="none"},_setMap:function(a){this._map=a,this._map&&this._map.on("mousedown",this.hide,this),this._map&&this._map._container&&this._map._container.appendChild(this._container)},_unsetMap:function(){this.hide(),this._map&&this._map.off("mousedown",this.hide,this),this._map&&this._map._container&&this._map._container.removeChild(this._container),this._map=null}}),NMenuItem=NClass.extend({text:"",callback:null,posObjects:null,initialize:function(a,b){this.text=a,this.callback=b,this._itemDiv=NUtil.create("div","newmap_contextMenu_item"),this._itemDiv.innerHTML="<span>"+a+"</span>",NEvent.addListener(this._itemDiv,"mousedown",function(a){NEvent.stopPropagation(a)}),NEvent.addListener(this._itemDiv,"click",function(a){var b=a;return function(a){b.callback&&(b.callback(b._parent.posObjects),b._parent.hide()),NEvent.stopPropagation(a)}}(this)),NEvent.addListener(this._itemDiv,"mouseover",function(a){NUtil.addClass(this," newmap_contextMenu_item_hover"),NEvent.stopPropagation(a)}),NEvent.addListener(this._itemDiv,"mouseout",function(a){NUtil.removeClass(this," newmap_contextMenu_item_hover")})},_setContextMenu:function(a){this._parent=a,a._container.appendChild(this._itemDiv)},_unsetContextMenu:function(){this._parent._container.removeChild(this._itemDiv)}}),NFeature=NOverlay.extend({includes:NEWMAP_JS_LIB.PublicParts.Events,fid:null,geometry:null,attributes:null,_visible:!0,_isdraw:!1,_type:"NFeature",_layerFlag:!1,getType:function(){return this._type},initialize:function(a,b,c){this.geometry=a?a:null,this.attributes={},b&&(this.attributes=NUtil.extend(this.attributes,b)),this.symbol=c?c:null},setStyle:function(a){this.symbol=a,this._isdraw&&this.geometry.setStyle(a)},getStyle:function(){return this.geometry.getStyle()},_unsetMap:function(a){a=a||this._map,a._pathRoot.removeChild(this.geometry._container),this._map=null},_setMap:function(a){this._map=a,this.geometry.setVisible(this._visible),this.geometry._setMap(a),this.symbol&&this.geometry.setStyle(this.symbol),NEvent.addListener(this.geometry._container,"click",this._onMouseClick,this);var b=["dblclick","mousedown","mouseover","mouseout"];for(var c=0;c<b.length;c++)NEvent.addListener(this.geometry._container,b[c],this._fireMouseEvent,this);a.on("viewreset",this._update,this),this._update(),this._isdraw=!0},_onMouseClick:function(a){var b=this._map,c=NEvent.getMousePosition(a,b._container),d=b._pixelToAbsPixel(c),e=b.pixelToPoint(c);this.fire(a.type,{point:e,absPixel:d,pixel:c,originalEvent:a,feature:this}),NEvent.stopPropagation(a),NEvent.preventDefault(a)},_fireMouseEvent:function(a){if(!this._map||this._map.getHegemonTag())return;this.fire(a.type,{originalEvent:a}),NEvent.stopPropagation(a)},getVisible:function(){return this._visible},setVisible:function(a){a=a?!0:!1;if(this._visible===a)return;this._visible=a;var b=a?"block":"none";this.geometry._container&&this.geometry.setVisible(a)},_update:function(){}}),NMarker=NOverlay.extend({includes:NEWMAP_JS_LIB.PublicParts.Events,options:{imgUrl:NEWMAP_JS_LIB.NEWMAP_LIB_IMAGE_URL+"marker.png",shadowUrl:NEWMAP_JS_LIB.NEWMAP_LIB_IMAGE_URL+"marker-shadow.png",markerSize:new NXY(25,41),shadowSize:new NXY(41,41),labelSize:new NXY(50,50),markerAnchor:new NXY(13,41),shadowAnchor:new NXY(13,41),dialogAnchor:new NXY(0,-33),labelAnchor:new NXY(0,-33),markerTitle:"",assignId:"",visible:!0,labelable:!1,labelContent:"",popable:!0,clickable:!0,draggable:!1,zIndexOffset:0,labeClass:{backgroundColor:"#ffffe1",border:"#8c8c8c 1px solid",fontSize:"12px",fontFamily:"",color:"#4d4d4d"}},_type:"NMarker",getType:function(){return this._type},initialize:function(a,b){this.options=NUtil.extend({},NMarkerOptions,b),this._latlng=a},getPosition:function(){return this._latlng},setPosition:function(a){this._latlng=a,this._markerTarget&&(this._update(),this._dialog&&this._dialog.setPosition(this._latlng))},enableDrag:function(){return this.options.draggable=this.draggable=!0,this._map?(this.dragging||(this.dragging=new NElement.Drag(this)),this.dragging.enable(),this.on("dragend",this.bringToBack,this),this):this},disableDrag:function(){return this.options.draggable=this.draggable=!1,this._map?(this.dragging&&(this.dragging.disable(),this.off("dragend",this.bringToBack,this)),this):this},enablePop:function(){this.options.popable=!0,this.on("mouseover",this._onMouseOver,this),this.on("mouseout",this._onMouseOut,this)},disablePop:function(){this._pushToBack(),this.options.popable=!1,this.off("mouseover",this._onMouseOver),this.off("mouseout",this._onMouseOut)},bringToFront:function(){this._popToFront()},bringToBack:function(){this._pushToBack()},setTitle:function(a){this.options.markerTitle=a,this._markerTarget&&(this._markerTarget.title=this.options.markerTitle)},getVisible:function(){return this.options.visible},setVisible:function(a){a=a?!0:!1;var b=a?"":"none";if(this.options.visible==a)return;this.options.visible=a,this._dialog&&this._dialog._close(),this._markerTarget&&(this._markerTarget.style.display=b),this._shadow&&(this._shadow.style.display=b),this._label&&(this._label.style.display=b)},openDialog:function(){return this._dialog.setPosition(this._latlng),this._map.openDialog(this._dialog),this},closeDialog:function(){return this._dialog&&this._dialog._close(),this},setDialog:function(a,b,c){return c=NUtil.extend({pixelOffset:this.options.dialogAnchor},c),b=b||NDialog,this._dialog||this.on("click",this.openDialog,this),this._dialog=new b(c,this),this._dialog.setContent(a),this},unsetDialog:function(){return this._dialog&&(this._dialog=null,this.off("click",this.openDialog)),this},_popToFront:function(){this._poped=!0;var a=this._getHoverElem();if(!a)return;a.style.zIndex=NUtil.MaxZIndex},_pushToBack:function(){this._poped=!1;var a=this._getHoverElem();if(!a)return;isNaN(this.options.zIndexOffset)?a.style.zIndex="auto":a.style.zIndex=this.options.zIndexOffset},_getHoverElem:function(){return this._markerTarget},_onMouseOver:function(a){NEvent.stopPropagation(a),this.options.popable&&this._popToFront()},_onMouseOut:function(a){NEvent.stopPropagation(a),this.options.popable&&this._pushToBack()},_createImg:function(a){var b;return NUtil.Browser.ie6?(b=document.createElement("div"),b.style.filter='progid:DXImageTransform.Microsoft.AlphaImageLoader(src="'+a+'")'):(b=document.createElement("img"),b.src=a),b},_updateImg:function(){if(this._markerTarget){var a=this.options.imgUrl;NUtil.Browser.ie6?this._markerTarget.style.filter='progid:DXImageTransform.Microsoft.AlphaImageLoader(src="'+a+'")':this._markerTarget.src=a}},_updateShadowImg:function(){if(this._shadow){var a=this.options.shadowUrl;NUtil.Browser.ie6?this._shadow.style.filter='progid:DXImageTransform.Microsoft.AlphaImageLoader(src="'+a+'")':this._shadow.src=a}},_setMap:function(a){this._map=a,this._initMarker(),a.on("viewreset",this._update,this),this._update(!0)},_aviodDragDefault:function(a){var b=this._getDragTarget();if(!b)return;a?NEvent.addListener(b,NDraggable.MOVE,this._unsetDefaultDragEvent,this):NEvent.removeListener(b,NDraggable.MOVE,this._unsetDefaultDragEvent,this)},_unsetDefaultDragEvent:function(a){NEvent.stop(a)},_unsetMap:function(a){a=a||this._map,this._removeMarker(),this.closeDialog&&this.closeDialog(),a.off("viewreset",this._update,this),this._map=null},getOption:function(a){return this.options[a]},getOptions:function(){return this.options},setOption:function(a,b){a!==undefined&&b!==undefined&&(this.options[a]=b),this._updateMarker()},setImgUrl:function(a){this.setOption("imgUrl",a)},setShadowUrl:function(a){this.setOption("shadowUrl",a)},getBounds:function(){var a=null;return this._latlng?new NBounds(this._latlng.x,this._latlng.y,this._latlng.x,this._latlng.y):null},_createMarkerTarget:function(){var a=this.options.imgUrl;if(!a)return null;var b=this._createImg(a);return b.className="newmap-marker-img",b},_createShadowImg:function(){var a=this.options.shadowUrl;if(!a||!a.length)return null;var b=this._createImg(a);return b.className="newmap-marker-shadow",b},_createLabel:function(){var a=this.options.labelContent;if(a=="")return null;var b=document.createElement("div");return b.innerHTML=a,b.className="newmap-marker-label",b},_initMarker:function(){this._markerTarget||(this._markerTarget=this._createMarkerTarget()),this.options.assignId&&(this._markerTarget.id=this.options.assignId),this._shadow||(this._shadow=this._createShadowImg()),this._map._panes.markerPane.appendChild(this._markerTarget),this._shadow&&this._map._panes.shadowPane.appendChild(this._shadow),this.options.labelable&&this.options.labelContent!=""&&(this._label||(this._label=this._createLabel()),this._map._panes.labelPane.appendChild(this._label)),isNaN(this.options.zIndexOffset)||(this._markerTarget.style.zIndex=this.options.zIndexOffset),this._initInteraction()},_removeMarker:function(){this._map._panes.markerPane.removeChild(this._markerTarget),this._shadow&&this._map._panes.shadowPane.removeChild(this._shadow),this._label&&this._map._panes.labelPane.removeChild(this._label),this._markerTarget=this._shadow=null},_getMoveTarget:function(){return this._markerTarget},_getDragTarget:function(){return this._markerTarget},_onDragUpdate:function(a){this._shadow&&NUtil.setPosition(this._shadow,a.absPixel),this._label&&NUtil.setPosition(this._label,a.absPixel),this._latlng=a.point},_updateMarker:function(){var a=this.options.markerSize,b=this.options.shadowSize,c=this.options.labelSize,d=this.options.markerAnchor,e=this.options.markerTitle,f=isNaN(this.options.zIndexOffset)?0:Math.round(this.options.zIndexOffset);shadowAnchor=this.options.shadowAnchor,labelAnchor=this.options.labelAnchor,this._markerTarget&&(this._updateImg(),this._markerTarget.style.marginLeft=-d.x+"px",this._markerTarget.style.marginTop=-d.y+"px",this._markerTarget.style.width=a.x+"px",this._markerTarget.style.height=a.y+"px",this._markerTarget.style.zIndex=f,this._markerTarget.title=e?e:""),this._shadow&&(this._updateShadowImg(),shadowAnchor&&(this._shadow.style.marginLeft=-shadowAnchor.x+"px",this._shadow.style.marginTop=-shadowAnchor.y+"px"),b&&(this._shadow.style.width=b.x+"px",this._shadow.style.height=b.y+"px"));if(this._label){labelAnchor&&(this._label.style.marginLeft=-labelAnchor.x+"px",this._label.style.marginTop=-labelAnchor.y+"px"),c&&(this._label.style.width=c.x+"px",this._label.style.height=c.y+"px");if(this.options.labeClass&&this.options.labeClass instanceof Object){var g=this.options.labeClass;for(var h in g)this._label.style[h]=g[h]}}},_update:function(a){a&&this._updateMarker();var b=this._map._pointToAbsPixel(this._latlng).round();NUtil.setPosition(this._markerTarget,b),this._shadow&&NUtil.setPosition(this._shadow,b),this._label&&NUtil.setPosition(this._label,b)},_initInteraction:function(){if(this.options.clickable){this._markerTarget.className+=" newmap-clickable",NEvent.addListener(this._markerTarget,"click",this._onMouseClick,this);var a=["dblclick","mousedown","mouseover","mouseout"];for(var b=0;b<a.length;b++)NEvent.addListener(this._markerTarget,a[b],this._fireMouseEvent,this);NEvent.addListener(this._markerTarget,"contextmenu",this._showContextmenu,this)}this.options.popable&&this.enablePop(),this.options.draggable&&this.enableDrag()},_showContextmenu:function(a){if(!this._map||this._map.getHegemonTag())return;this.fire(a.type,{originalEvent:a,marker:this}),this.fire("rightclick",{originalEvent:a,marker:this}),NEvent.stopPropagation(a),NEvent.preventDefault(a)},_onMouseClick:function(a){if(this._map.getHegemonTag())return;NEvent.stopPropagation(a);if(this.dragging&&this.dragging.moved())return;this.fire(a.type,{originalEvent:a,marker:this})},_fireMouseEvent:function(a){if(!this._map||this._map.getHegemonTag())return;this.fire(a.type,a),NEvent.stopPropagation(a)}}),NMarkerOptions={imgUrl:NEWMAP_JS_LIB.NEWMAP_LIB_IMAGE_URL+"marker.png",visible:!0,shadowUrl:NEWMAP_JS_LIB.NEWMAP_LIB_IMAGE_URL+"marker-shadow.png",markerSize:new NXY(25,41),shadowSize:new NXY(41,41),labelSize:new NXY(50,50),markerAnchor:new NXY(13,41),shadowAnchor:new NXY(13,41),dialogAnchor:new NXY(0,-33),labelAnchor:new NXY(0,-33),markerTitle:"",assignId:"",popable:!0,labelable:!1,labelContent:"",clickable:!0,draggable:!1,labeClass:{backgroundColor:"#ffffe1",border:"#8c8c8c 1px solid",fontSize:"12px",fontFamily:"",color:"#4d4d4d"},zIndexOffset:0},NSpriteMarker=NMarker.extend({initialize:function(a,b){this.options=NUtil.extend({},NSpriteMarkerOptions,b),this._latlng=a},_createMarkerTarget:function(){var a=NUtil.create("div","newmap-marker-div");return a},_updateMarker:function(){var a=this.options.imgOffset,b=this.options.markerSize,c=this.options.shadowSize,d=this.options.labelSize,e=this.options.markerAnchor,f=this.options.markerTitle,g=isNaN(this.options.zIndexOffset)?0:Math.round(this.options.zIndexOffset);shadowAnchor=this.options.shadowAnchor,labelAnchor=this.options.labelAnchor,this._markerTarget&&(this._markerTarget.style.marginLeft=-e.x+"px",this._markerTarget.style.marginTop=-e.y+"px",this._markerTarget.style.width=b.x+"px",this._markerTarget.style.height=b.y+"px",this._markerTarget.style.backgroundImage="url("+this.options.imgUrl+")",a&&(this._markerTarget.style.backgroundPosition=-a.x+"px "+ -a.y+"px"),this._markerTarget.style.zIndex=g,this._markerTarget.title=this.options.markerTitle),this._shadow&&(shadowAnchor&&(this._shadow.style.marginLeft=-shadowAnchor.x+"px",this._shadow.style.marginTop=-shadowAnchor.y+"px"),c&&(this._shadow.style.width=c.x+"px",this._shadow.style.height=c.y+"px"));if(this._label){labelAnchor&&(this._label.style.marginLeft=-labelAnchor.x+"px",this._label.style.marginTop=-labelAnchor.y+"px"),d&&(this._label.style.width=d.x+"px",this._label.style.height=d.y+"px");if(this.options.labeClass&&this.options.labeClass instanceof Object){var h=this.options.labeClass;for(var i in h)this._label.style[i]=h[i]}}}}),NSpriteMarkerOptions={imgUrl:NEWMAP_JS_LIB.NEWMAP_LIB_IMAGE_URL+"spotmkrs.png",shadowUrl:"",markerSize:new NXY(26,16),shadowSize:new NXY(27,18),imgOffset:new NXY(164,61),visible:!0,markerAnchor:new NXY(13,8),shadowAnchor:new NXY(9,18),dialogAnchor:new NXY(0,-8),markerTitle:"",popable:!0,clickable:!0,draggable:!1,zIndexOffset:0},NBoundsImage=NOverlay.extend({includes:NEWMAP_JS_LIB.PublicParts.Events,initialize:function(a,b){this._url=a,this._bounds=b},getBounds:function(){return this._bounds?this._bounds:null},_setMap:function(a){this._map=a,this._image||this._initMarker(),a._panes.overlayPane.appendChild(this._image),a.on("viewreset",this._update,this),this._update()},_unsetMap:function(a){a=a||this._map,a._panes.overlayPane.removeChild(this._image),a.off("viewreset",this._update,this),this._map=null},_initMarker:function(){this._image=NUtil.create("img","newmap-bound-image"),this._image.style.visibility="hidden",NUtil.extend(this._image,{galleryimg:"no",onselectstart:NUtil.falseFn,onmousemove:NUtil.falseFn,onload:NUtil.bind(this._onImageLoad,this),src:this._url})},_update:function(){if(!this._image)return;var a=this._image,b=this._map._pointToAbsPixel(new NXY(this._bounds.minX,this._bounds.maxY)),c=this._map._pointToAbsPixel(new NXY(this._bounds.maxX,this._bounds.minY)).subtract(b);NUtil.setPosition(a,b),a.style.width=c.x+"px",a.style.height=c.y+"px"},_onImageLoad:function(){this._image.style.visibility="",this.fire("load")}}),NPath=NClass.extend({includes:NEWMAP_JS_LIB.PublicParts.Events,_type:"NPath",statics:{CLIP_PADDING:.5},_visible:!0,options:{stroke:!0,color:"#0033ff",weight:5,opacity:.5,fill:!1,fillColor:null,fillOpacity:.2,editable:!1,clickable:!0},initialize:function(a){NUtil.setOptions(this,a)},_setMap:function(a){this._map=a,this._initElements(),this._initEvents(),this.toAbsPixels(),this._updatePath(),a.on("viewreset",this.toAbsPixels,this).on("moveend",this._updatePath,this)},_unsetMap:function(a){a=a||this._map,this.disableEdit(),a._pathRoot.removeChild(this._container),a.off("viewreset",this.toAbsPixels,this).off("moveend",this._updatePath,this),this._map=null},toAbsPixels:function(){},getType:function(){return this._type},getMap:function(){return this._map||null},getVisible:function(){return this._visible},setVisible:function(a){a=a?!0:!1;if(this._visible===a)return;this._visible=a;var b=a?"block":"none";this._container&&(this._container.style.display=b),this._label&&(this._label._element.style.display=b)},getStyle:function(){var a={},b,c=this._getStyleObjects();if(!c)return null;for(b in this.options)c.hasOwnProperty(b)&&(a[b]=this.options[b]);return a},setStyle:function(a){if(!a)return;this.options=this.options||{};var b,c=this._getStyleObjects();if(!c)return this;for(b in a)c.hasOwnProperty(b)&&(this.options[b]=a[b]);return this._container&&this._updateStyle(),this},getBounds:function(){return null},redraw:function(){return this._map&&(this.toAbsPixels(),this._updatePath()),this},_getStyleObjects:function(){var a=this._getStyleOptionsClass();if(!a)return null;var b=NUtil.extend({},a),c=["editable","clickable","draggable"],d;for(var e=0,f=c.length;e<f;e++)d=c[e],b.hasOwnProperty(d)&&delete b[d];return b},_getPathContainer:function(){if(this._container)return this._container},_getStyleOptionsClass:function(){return null}}),NPath.SVG_NS="http://www.w3.org/2000/svg",NPath=NPath.extend({statics:{SVG:NUtil.Browser.svg},getPathString:function(){},_createElement
:function(a){return document.createElementNS(NPath.SVG_NS,a)},_initElements:function(){this._map._initPathRoot(),this._initPath(),this._initStyle()},_initPath:function(){this._container=this._createElement("g"),this._path=this._createElement("path"),this._container.appendChild(this._path),this._map._pathRoot.appendChild(this._container);var a=this.getVisible(),b=a?"block":"none";this._container.style.display=b},_initStyle:function(){this.options.stroke&&(this._path.setAttribute("stroke-linejoin","round"),this._path.setAttribute("stroke-linecap","round")),this.options.fill&&this._path.setAttribute("fill-rule","evenodd"),this._updateStyle()},_updateStyle:function(){this.options.stroke?(this._path.setAttribute("stroke",this.options.strokeColor),this._path.setAttribute("stroke-opacity",this.options.strokeOpacity),this._path.setAttribute("stroke-width",this.options.strokeWidth),this._path.setAttribute("stroke-dasharray",this._dashStyle(this.options,1))):this._path.setAttribute("stroke","none"),this.options.fill?(this._path.setAttribute("fill",this.options.fillColor||this.options.color),this._path.setAttribute("fill-opacity",this.options.fillOpacity)):this._path.setAttribute("fill","none")},_dashStyle:function(a,b){var c=a.strokeWidth*b,d=a.strokeStyle;switch(d){case"solid":return"none";case"dot":return[1,4*c].join();case"dash":return[4*c,4*c].join();case"dashdot":return[4*c,4*c,1,4*c].join();case"longdash":return[8*c,4*c].join();case"longdashdot":return[8*c,4*c,1,4*c].join();default:return"none"}},_updatePath:function(){var a=this.getPathString();a||(a="M0 0"),this._path.setAttribute("d",a)},_initEvents:function(){if(!this._container)return;this._path&&!NUtil.Browser.vml&&this._path.setAttribute("class","newmap-clickable"),NEvent.addListener(this._container,"click",this._onMouseClick,this);var a=["dblclick","mousedown","mouseover","mouseout","mousemove","contextmenu"];for(var b=0;b<a.length;b++)NEvent.addListener(this._container,a[b],this._fireMouseEvent,this);NEvent.addListener(this._container,"mouseover",this._onMouseOver,this),NEvent.addListener(this._container,"mouseout",this._onMouseOut,this),this._map&&this._map.on("click",this.setEditStatus,this)},setEditStatus:function(a){var b=a===!0?!0:!1;this._editHandler&&b!=this._editHandler._enabled&&(b?(this._editHandler.enable(),this.fire("selected",{feature:this})):(this._editHandler.disable(),this.fire("unselected",{feature:this})))},enableEdit:function(){var a=this._getEditClass();a&&(NUtil.setOptions(this,{editable:!0,clickable:!0}),this._initEvents(),this._editHandler||(this._editHandler=new a(this)),this.fire("editenabled",{feature:this}),this.setEditStatus(!0))},disableEdit:function(){NUtil.setOptions(this,{editable:!1});var a=this._getEditClass();a&&this.setEditStatus(!1),this.fire("editdisabled",{feature:this})},_getEditClass:function(){return null},_onMouseClick:function(a){if(this._map.checkDraging())return;this.options.editable&&this.enableEdit(),a.type==="contextmenu"&&NEvent.preventDefault(a),this._fireMouseEvent(a)},_onMouseOver:function(a){NUtil.Browser.vml&&NUtil.addClass(this._container,"newmap-top-zindex")},_onMouseOut:function(a){NUtil.Browser.vml&&NUtil.removeClass(this._container,"newmap-top-zindex")},_fireMouseEvent:function(a){if(!this._map||this._map.getHegemonTag())return;if(!this.has(a.type)){if(a.type=="click"||a.type=="mouseover")this.options.editable&&NEvent.stopPropagation(a),NEvent.preventDefault(a);return}var b=this._map,c=NEvent.getMousePosition(a,b._container),d=b._pixelToAbsPixel(c),e=b.pixelToPoint(c);this.fire(a.type,{point:e,absPixel:d,pixel:c,originalEvent:a,feature:this}),NEvent.stopPropagation(a),NEvent.preventDefault(a)}}),NPath=NUtil.Browser.svg||!NUtil.Browser.vml?NPath:NPath.extend({statics:{VML:!0,CLIP_PADDING:.02},_createElement:function(){try{return document.namespaces.add("lvml","urn:schemas-microsoft-com:vml"),function(a){return document.createElement("<lvml:"+a+' class="lvml">')}}catch(a){return function(a){return document.createElement("<"+a+' xmlns="urn:schemas-microsoft.com:vml" class="lvml">')}}}(),_initPath:function(){var a=this._container=this._createElement("shape");a.className+=" newmap-vml-shape"+(this.options.clickable?" newmap-clickable":""),a.coordsize="1 1",this._path=this._createElement("path"),a.appendChild(this._path),this._map._pathRoot.appendChild(a)},_initStyle:function(){var a=this._container,b,c;this.options.stroke&&(b=this._stroke=this._createElement("stroke"),b.endcap="round",a.appendChild(b)),this.options.fill&&(c=this._fill=this._createElement("fill"),a.appendChild(c)),this._updateStyle()},_updateStyle:function(){var a=this._stroke,b=this._fill,c=this.options,d=this._container;d.stroked=c.stroke,d.filled=c.fill,c.stroke&&(a.weight=c.strokeWidth+"px",a.color=c.strokeColor,a.opacity=c.strokeOpacity,a.dashstyle=c.strokeStyle),c.fill&&(b.color=c.fillColor||c.color,b.opacity=c.fillOpacity)},_updatePath:function(){var a=this._container.style,b=this.getVisible(),c=b?"block":"none";a.display="none",this._path.v=this.getPathString()+" ",a.display=c}}),NPath=NPath.SVG&&!window.L_PREFER_CANVAS||!NUtil.Browser.canvas?NPath:NPath.extend({statics:{CANVAS:!0,SVG:!1},redraw:function(){return this._map&&(this.toAbsPixels(),this._requestUpdate()),this},_requestUpdate:function(){this._map&&(this._map.fire("moveend"),this._fireMapMoveEndTimer&&clearTimeout(this._fireMapMoveEndTimer),this._fireMapMoveEndTimer=setTimeout(this._fireMapMoveEnd(this._map),17))},_fireMapMoveEnd:function(a){var b=a;return function(){b.fire("moveend")}},_unsetMap:function(a){a.off("viewreset",this.toAbsPixels,this).off("moveend",this._updatePath,this),this._requestUpdate(),this._map=null},_initElements:function(){this._map._initPathRoot(),this._ctx=this._map._canvasCtx},_updateStyle:function(){var a=this.options;a.stroke&&(this._ctx.lineWidth=a.strokeWidth,this._ctx.strokeStyle=a.strokeColor||a.color),a.fill&&(this._ctx.fillStyle=a.fillColor||a.color)},_drawPath:function(){var a,b,c,d,e,f;this._ctx.beginPath();for(a=0,c=this._parts.length;a<c;a++){for(b=0,d=this._parts[a].length;b<d;b++)e=this._parts[a][b],f=(b===0?"move":"line")+"To",this._ctx[f](e.x,e.y);this instanceof NPolygon&&this._ctx.closePath()}},_checkIfEmpty:function(){return!this._parts.length},_updatePath:function(){if(this._checkIfEmpty())return;var a=this._ctx,b=this.options;this._drawPath(),a.save(),this._updateStyle(),b.fill&&(b.fillOpacity<1&&(a.globalAlpha=b.fillOpacity),a.fill()),b.stroke&&(b.strokeOpacity<1&&(a.globalAlpha=b.strokeOpacity),a.stroke()),a.restore()},_initEvents:function(){this.options.clickable&&this._map&&this._map.on("click",this._onClick,this)},_onClick:function(a){this._containsPoint(a.absPixel)&&this.fire("click",{originalEvent:a,feature:this})},onRemove:function(a){a.off("viewreset",this.toAbsPixels,this).off("moveend",this._updatePath,this).fire("moveend")}}),NPath.include(NDialog?{setDialog:function(a,b,c){b=b||NDialog;if(!this._dialog||this._dialog.options!==c)this._dialog=new b(c,this);return this._dialog.setContent(a),this._openDialogAdded||(this.on("click",this._openDialog,this),this._openDialogAdded=!0),this},unsetDialog:function(){return this._dialog&&(this._dialog=null,this.off("click",this._openDialog),this._openDialogAdded=!1),this},_openDialog:function(a){this._dialog.setPosition(a.point),this._map.openDialog(this._dialog)}}:{}),NMap.include({_updatePathViewport:function(){var a=NPath.CLIP_PADDING,b=this.getSize(),c=NUtil.getPosition(this._mapPane),d=c.multiplyBy(-1)._subtract(b.multiplyBy(a)),e=d.add(b.multiplyBy(1+a*2));this._pathViewport=new NBounds(d,e)}}),NMap.include(NUtil.Browser.svg?{_initPathRoot:function(){this._pathRoot||(this._pathRoot=NPath.prototype._createElement("svg"),this._panes.overlayPane.appendChild(this._pathRoot),this.on("moveend",this._updateSvgViewport),this._updateSvgViewport())},_updateSvgViewport:function(){this._updatePathViewport();var a=this._pathViewport,b=new NXY(a.minX,a.minY),c=new NXY(a.maxX,a.maxY),d=c.x-b.x,e=c.y-b.y,f=this._pathRoot,g=this._panes.overlayPane;NUtil.Browser.webkit&&g.removeChild(f),NUtil.setPosition(f,b),f.setAttribute("width",d),f.setAttribute("height",e),f.setAttribute("viewBox",[b.x,b.y,d,e].join(" ")),NUtil.Browser.webkit&&g.appendChild(f)}}:{}),NMap.include(NUtil.Browser.svg||!NUtil.Browser.vml?{}:{_initPathRoot:function(){if(this._pathRoot)return;var a=this._pathRoot=document.createElement("div");a.className="newmap-vml-container",this._panes.overlayPane.appendChild(a),this.on("moveend",this._updatePathViewport),this._updatePathViewport()}}),NMap.include(NPath.SVG&&!window.L_PREFER_CANVAS||!NUtil.Browser.canvas?{}:{_initPathRoot:function(){var a=this._pathRoot,b;a||(a=this._pathRoot=document.createElement("canvas"),a.style.position="absolute",b=this._canvasCtx=a.getContext("2d"),b.lineCap="round",b.lineJoin="round",this._panes.overlayPane.appendChild(a),this.on("moveend",this._updateCanvasViewport),this._updateCanvasViewport())},_updateCanvasViewport:function(){this._updatePathViewport();var a=this._pathViewport,b=a.getLowerPoint(),c=a.getUpperPoint().subtract(b),d=this._pathRoot;NUtil.setPosition(d,b),d.width=c.x,d.height=c.y,d.getContext("2d").translate(-b.x,-b.y)}}),NPolyline=NPath.extend({_type:"NPolyline",options:{smoothFactor:1,noClip:!1},initialize:function(a,b){this.options=NUtil.extend({},NPolylineOptions,b),this._points=a||[]},toAbsPixels:function(){this._absPixels=[];if(this._points)for(var a=0,b=this._points.length;a<b;a++)this._absPixels[a]=this._map._pointToAbsPixel(this._points[a])},getPathString:function(){for(var a=0,b=this._parts.length,c="";a<b;a++)c+=this._getPathPartStr(this._parts[a]);return c},measureLength:function(a,b){var c=0;if(this._points.length===0)return c;var d=1,e=this._points.length,f;do f=NUtil.getDistByUnits(this._points[d-1],this._points[d],a,b),c=f+c,d++;while(d<e);return c},getPoints:function(){return this._points},setPoints:function(a){return this._points=a,this.redraw()},setPointAt:function(a,b){this._points&&this._points.length>a&&b&&b instanceof NXY&&(this._points[a]=b,this.redraw())},addPoint:function(a){return this._points.push(a),this.redraw()},removePoints:function(a,b){var c=[].splice.apply(this._points,arguments);return this.redraw(),c},closestLayerPoint:function(a){var b=Infinity,c=this._parts,d,e,f=null;for(var g=0,h=c.length;g<h;g++){var i=c[g];for(var j=1,k=i.length;j<k;j++){d=i[j-1],e=i[j];var l=NUtil.LineUtil._sqClosestPointOnSegment(a,d,e);l._sqDist<b&&(b=l._sqDist,f=l)}}return f&&(f.distance=Math.sqrt(b)),f},getBounds:function(){var a=null,b=this.getPoints();if(!b)return null;for(var c=0,d=b.length;c<d;c++)c==0&&(a=new NBounds(b[0].x,b[0].y,b[0].x,b[0].y)),a.extend(b[c]);return a},getStrokeColor:function(){return this.options.strokeColor},setStrokeColor:function(a){this.setStyle({strokeColor:a})},getStrokeOpacity:function(){return this.options.strokeOpacity},setStrokeOpacity:function(a){this.setStyle({strokeOpacity:a})},getStrokeWidth:function(){return this.options.strokeWidth},setStrokeWidth:function(a){this.setStyle({strokeWidth:a})},getStrokeStyle:function(){return this.options.strokeStyle},setStrokeStyle:function(a){this.setStyle({strokeStyle:a})},_getStyleOptionsClass:function(){return NPolylineOptions},_getEditClass:function(){return NPolyline.Edit},_initEvents:function(){NPath.prototype._initEvents.call(this)},_getPathPartStr:function(a){var b=NPath.VML;for(var c=0,d=a.length,e="",f;c<d;c++)f=a[c],b&&f._round(),e+=(c?"L":"M")+f.x+" "+f.y;return e},_clipPoints:function(){var a=this._absPixels,b=a.length,c,d,e;if(this.options.noClip){this._parts=[a];return}this._parts=[];var f=this._parts,g=this._map._pathViewport,h=NUtil.LineUtil;for(c=0,d=0;c<b-1;c++){e=h.clipSegment(a[c],a[c+1],g,c);if(!e)continue;f[d]=f[d]||[],f[d].push(e[0]);if(e[1]!==a[c+1]||c===b-2)f[d].push(e[1]),d++}},_simplifyPoints:function(){var a=this._parts,b=NUtil.LineUtil;for(var c=0,d=a.length;c<d;c++)a[c]=b.simplify(a[c],this.options.smoothFactor)},setLabel:function(a,b){this._label||(this._label=new NLabel(null,b)),this._label.setContent(a),this._updatePath()},_unsetMap:function(){this._label&&this._map&&this._map.removeOverlays(this._label),NPath.prototype._unsetMap.call(this)},_updatePath:function(){this._clipPoints(),this._simplifyPoints(),NPath.prototype._updatePath.call(this);if(this._label&&this._map){if(this._parts[0]){var a=this._parts[0].length;if(a>=2){var b=Math.floor(a/2),c=b-1,d=new NXY((this._parts[0][c].x+this._parts[0][b].x)/2,(this._parts[0][c].y+this._parts[0][b].y)/2);d._round();var e=this._map._absPixelToPoint(d);this._label._latlng=e}}this._map.hasOverlay(this._label)&&this._map.removeOverlays(this._label),this._map.addOverlays(this._label)}}}),NPolyline.include(NPath.CANVAS?{_containsPoint:function(a,b){var c,d,e,f,g,h,i,j=this.options.strokeWidth/2;NUtil.Browser.touch&&(j+=10);for(c=0,f=this._parts.length;c<f;c++){i=this._parts[c];for(d=0,g=i.length,e=g-1;d<g;e=d++){if(!b&&d===0)continue;h=NUtil.LineUtil.pointToSegmentDistance(a,i[e],i[d]);if(h<=j)return!0}}return!1}}:{}),NPolylineOptions={stroke:!0,strokeColor:"#0033ff",strokeWidth:3,strokeOpacity:.6,strokeStyle:"solid",editable:!1,clickable:!0,labelable:!1,labelAnchor:new NXY(8,0),labelContent:""},NMultiPolyline=NPath.extend({_type:"NMultiPolyline",options:{smoothFactor:1,noClip:!1},initialize:function(a,b){this.options=NUtil.extend({},NPolylineOptions,b),this._points=[];if(a&&a instanceof Array)for(var c=0;c<a.length;c++)a[c]instanceof NPolyline&&this._points.push(a[c]._points)},toAbsPixels:function(){this._absPixels=[];if(!this._points)return;for(var a=0,b=this._points.length;a<b;a++){this._absPixels[a]=[];for(var c=0,d=this._points[a].length;c<d;c++)this._absPixels[a][c]=this._map._pointToAbsPixel(this._points[a][c])}},_getPathPartStr:function(a){var b=NPath.VML;for(var c=0,d=a.length,e="",f;c<d;c++)f=a[c],b&&f._round(),e+=(c?"L":"M")+f.x+" "+f.y;return e},getPathString:function(){for(var a=0,b=this._parts.length,c="";a<b;a++)c+=this._getPathPartStr(this._parts[a]);return c},getStrokeColor:function(){return this.options.strokeColor},setStrokeColor:function(a){this.setStyle({strokeColor:a})},getStrokeOpacity:function(){return this.options.strokeOpacity},setStrokeOpacity:function(a){this.setStyle({strokeOpacity:a})},getStrokeWidth:function(){return this.options.strokeWidth},setStrokeWidth:function(a){this.setStyle({strokeWidth:a})},getStrokeStyle:function(){return this.options.strokeStyle},setStrokeStyle:function(a){this.setStyle({strokeStyle:a})},_getStyleOptionsClass:function(){return NPolylineOptions},_initEvents:function(){NPath.prototype._initEvents.call(this)},_clipPoints:function(){var a=[];this._parts=this._absPixels;if(this.options.noClip)return;for(var b=0,c=this._parts.length;b<c;b++){var d=NUtil.PolyUtil.clipPolygon(this._parts[b],this._map._pathViewport);if(!d.length)continue;a.push(d)}this._parts=a},_simplifyPoints:function(){var a=this._parts,b=NUtil.LineUtil;for(var c=0,d=a.length;c<d;c++)a[c]=b.simplify(a[c],this.options.smoothFactor)},_updatePath:function(){this._clipPoints(),this._simplifyPoints(),NPath.prototype._updatePath.call(this);if(this._label&&this._map){if(this._parts[0]){var a=this._parts[0].length;if(a>=2){var b=Math.floor(a/2),c=b-1,d=new NXY((this._parts[0][c].x+this._parts[0][b].x)/2,(this._parts[0][c].y+this._parts[0][b].y)/2);d._round();var e=this._map._absPixelToPoint(d);this._label._latlng=e}}this._map.addOverlays(this._label)}},_unsetMap:function(){this._label&&this._map&&this._map.removeOverlays(this._label),NPath.prototype._unsetMap.call(this)},measureLength:function(a,b){var c=0;if(this._points.length===0)return c;var d=this._points;for(var e=0;e<d.length;e++){var f=d[e],g=1,h=f.length,i;do i=NUtil.getDistByUnits(f[g-1],f[g],a,b),c=i+c,g++;while(g<h)}return c},getPoints:function(){return this._points},setPoints:function(a){return this._points=a,this.redraw()},getCommpentsLen:function(){var a=0;return this._points.length===0?a:(a=this._points.length,a)},getCommpentAt:function(a){if(a>this._points.length)return;var b=this._points[a],c;return this.getType().toLowerCase()=="nmultipolyline"?c=new NPolyline(b,this.options):c=new NPolygon(b,this.options),c},setCommpentAt:function(a,b){this._points[a]=b._points,this.redraw()},addCommpents:function(a){if(a&&a instanceof Array)for(var b=0;b<a.length;b++)a[b]instanceof NPolyline&&this._points.push(a[b]._points);else a&&a instanceof NPolyline&&this._points.push(a._points);return this.redraw()},removeCommpents:function(a,b){var c=[].splice.apply(this._points,arguments);return this.redraw(),c},getBounds:function(){var a=null,b=this.getPoints();if(!b)return null;for(var c=0,d=b.length;c<d;c++)for(var e=0,f=b[c].length;e<f;e++)c==0&&e==0&&(a=new NBounds(b[0][0].x,b[0][0].y,b[0][0].x,b[0][0].y)),a.extend(b[c][e]);return a},_getEditClass:function(){return NMultiPolyline.Edit}}),NPolygon=NPolyline.extend({options:{fill:!0},_type:"NPolygon",initialize:function(a,b){this.options=NUtil.extend({},NPolygonOptions,b),this._points=a||[],a&&a[0]instanceof Array&&(this._points=a[0],this._holes=a.slice(1))},toAbsPixels:function(){NPolyline.prototype.toAbsPixels.call(this),this._holePoints=[];if(!this._holes)return;for(var a=0,b=this._holes.length,c;a<b;a++){this._holePoints[a]=[];for(var d=0,e=this._holes[a].length;d<e;d++)this._holePoints[a][d]=this._map._pointToAbsPixel(this._holes[a][d])}},measureArea:function(a,b){var c=a;!a&&this._map&&(c=this._map.getUnits());var d=NUtil.getAreaByUnits(this._points,c,b);return d},getStrokeColor:function(){return this.options.strokeColor},setStrokeColor:function(a){this.setStyle({strokeColor:a})},getStrokeOpacity:function(){return this.options.strokeOpacity},setStrokeOpacity:function(a){this.setStyle({strokeOpacity:a})},getStrokeWidth:function(){return this.options.strokeWidth},setStrokeWidth:function(a){this.setStyle({strokeWidth:a})},getStrokeStyle:function(){return this.options.strokeStyle},setStrokeStyle:function(a){this.setStyle({strokeStyle:a})},getFillColor:function(){return this.options.fillColor},setFillColor:function(a){this.setStyle({fillColor:a})},getFillOpacity:function(){return this.options.fillOpacity},setFillOpacity:function(a){this.setStyle({fillOpacity:a})},_clipPoints:function(){var a=this._absPixels,b=[];this._parts=[a].concat(this._holePoints);if(this.options.noClip)return;for(var c=0,d=this._parts.length;c<d;c++){var e=NUtil.PolyUtil.clipPolygon(this._parts[c],this._map._pathViewport);if(!e.length)continue;b.push(e)}this._parts=b},_getEditClass:function(){return NPolygon.Edit},_getStyleOptionsClass:function(){return NPolygonOptions},_getPathPartStr:function(a){var b=NPolyline.prototype._getPathPartStr.call(this,a);return b+(NUtil.Browser.svg?"z":"x")}}),NPolygon.include(NPath.CANVAS?{contains:function(a){return this._containsPoint(a)},_containsPoint:function(a){var b=!1,c,d,e,f,g,h,i,j;if(NPolyline.prototype._containsPoint.call(this,a,!0))return!0;for(f=0,i=this._parts.length;f<i;f++){c=this._parts[f];for(g=0,j=c.length,h=j-1;g<j;h=g++)d=c[g],e=c[h],d.y>a.y!=e.y>a.y&&a.x<(e.x-d.x)*(a.y-d.y)/(e.y-d.y)+d.x&&(b=!b)}return b}}:{}),NPolygonOptions={stroke:!0,fill:!0,strokeColor:"#0033ff",strokeWidth:3,strokeOpacity:.6,strokeStyle:"solid",fillColor:"#0033ff",fillOpacity:.5,editable:!1,clickable:!0},NMultiPolygon=NMultiPolyline.extend({_type:"NMultiPolygon",initialize:function(a,b){NMultiPolyline.prototype.initialize.call(this,a,b),this.options=NUtil.extend({},NPolygonOptions,b)},measureArea:function(a,b){var c=a;!a&&this._map&&(c=this._map.getUnits());var d=0;for(var e=0;e<this._points.length;e++){var f=this._points[e];d+=NUtil.getAreaByUnits(f,c,b)}return d},getFillColor:function(){return this.options.fillColor},setFillColor:function(a){this.setStyle({fillColor:a})},getFillOpacity:function(){return this.options.fillOpacity},setFillOpacity:function(a){this.setStyle({fillOpacity:a})},_getStyleOptionsClass:function(){return NPolygonOptions},_getPathPartStr:function(a){var b=NPolyline.prototype._getPathPartStr.call(this,a);return b+(NUtil.Browser.svg?"z":"x")},_getEditClass:function(){return NMultiPolygon.Edit}}),NRect=NPolygon.extend({initialize:function(a,b){this._bounds=a,NPolygon.prototype.initialize.call(this,this._boundsToPoints(this._bounds),b)},setBounds:function(a){this._bounds=a,this.setPoints(this._boundsToPoints(a))},_getEditClass:function(){return NRect.Edit},_boundsToPoints:function(a){return a=a||this.getBounds(),a?[new NXY(a.minX,a.minY),new NXY(a.minX,a.maxY),new NXY(a.maxX,a.maxY),new NXY(a.maxX,a.minY)]:null}}),NCircle=NPath.extend({options:{fill:!0},_type:"NCircle",initialize:function(a,b,c){this.options=NUtil.extend({},NPolygonOptions,c),this._latlng=a,this._mRadius=b},measureArea:function(){var a=Math.PI*this._mRadius*this._mRadius;return a},getPosition:function(){return this._latlng},setPosition:function(a){return this._latlng=a,this.redraw()},getRadius:function(a){return a?this._mRadius:this._getFitRadius(a)},setRadius:function(a,b){if(!a)return;return this._mRadius=a,b&&b!=="m"&&NUtil.INCHES_PER_UNIT[b]&&(this._mRadius=this._mRadius*NUtil.INCHES_PER_UNIT[b]/NUtil.INCHES_PER_UNIT.m),this.redraw()},getStrokeColor:function(){return this.options.strokeColor},setStrokeColor:function(a){this.setStyle({strokeColor:a})},getStrokeOpacity:function(){return this.options.strokeOpacity},setStrokeOpacity:function(a){this.setStyle({strokeOpacity:a})},getStrokeWidth:function(){return this.options.strokeWidth},setStrokeWidth:function(a){this.setStyle({strokeWidth:a})},getStrokeStyle:function(){return this.options.strokeStyle},setStrokeStyle:function(a){this.setStyle({strokeStyle:a})},getFillColor:function(){return this.options.fillColor},setFillColor:function(a){this.setStyle({fillColor:a})},getFillOpacity:function(){return this.options.fillOpacity},setFillOpacity:function(a){this.setStyle({fillOpacity:a})},toAbsPixels:function(){var a=this._getFitRadius(),b=new NXY(this._latlng.x,this._latlng.y-a),c=this._map._pointToAbsPixel(b);this._point=this._map._pointToAbsPixel(this._latlng),this._radius=Math.round(Math.abs(this._point.y-c.y))},getBounds:function(){var a=this._getFitRadius();return new NBounds(this._latlng.x-a,this._latlng.y-a,this._latlng.x+a,this._latlng.y+a)},getPathString:function(){var a=this._point,b=this._radius;return this._checkIfEmpty()?"":NUtil.Browser.svg?"M"+a.x+","+(a.y-b)+"A"+b+","+b+",0,1,1,"+(a.x-.1)+","+(a.y-b)+" z":(a._round(),b=Math.round(b),"AL "+a.x+","+a.y+" "+b+","+b+" 0,"+23592600)},_getStyleOptionsClass:function(){return NPolygonOptions},_getFitRadius:function(a){if(!this._map)return this._mRadius;a=a||this._map.getUnits();var b=this._mRadius;return b*NUtil.INCHES_PER_UNIT.m/NUtil.INCHES_PER_UNIT[a]},_checkIfEmpty:function(){var a=this._map._pathViewport,b=this._radius,c=this._point;return c.x-b>a.maxX||c.y-b>a.maxY||c.x+b<a.minX||c.y+b<a.minY},_getEditClass:function(){return NCircle.Edit}}),NCircle.include(NPath.CANVAS?{_drawPath:function(){var a=this._point;this._ctx.beginPath(),this._ctx.arc(a.x,a.y,this._radius,0,Math.PI*2,!1)},_containsPoint:function(a){var b=this._point,c=this.options.stroke?this.options.strokeWidth/2:0;return a.distanceTo(b)<=this._radius+c}}:{}),NSector=NCircle.extend({options:{fill:!0},_type:"NSector",initialize:function(a,b,c,d,e){this.options=NUtil.extend({},NPolygonOptions,e),this._slatlng=a,this._passpoint=b,this._edegree=c,this._draw=d,this._sdegree=this._getangle(this._slatlng,this._passpoint),this._distance=(new NXY(this._passpoint.x,this._passpoint.y)).distanceTo(new NXY(this._slatlng.x,this._slatlng.y))},_getangle:function(a,b){var c=(new NXY(b.x,b.y)).distanceTo(new NXY(a.x,a.y)),d=b.y-a.y,e;if(a.x<b.x&&a.y<=b.y)e=180*Math.asin(d/c)/Math.PI;else if(a.x==b.x&&a.y<b.y)e=180*Math.asin(d/c)/Math.PI;else if(a.x>b.x&&a.y<b.y)e=180-180*Math.asin(d/c)/Math.PI;else if(a.x>b.x&&a.y>=b.y)e=180-180*Math.asin(d/c)/Math.PI;else if(a.x==b.x&&a.y>b.y)e=180-180*Math.asin(d/c)/Math.PI;else{if(!(a.x<b.x&&a.y>b.y))return;e=360+180*Math.asin(d/c)/Math.PI}return e},measureArea:function(){var a=this.getRadius(),b;this._draw?b=(this._sdegree-this._edegree+360)%360:b=(this._edegree-this._sdegree+360)%360;var c=Math.PI*a*a*b/360;return c},getCenterPosition:function(){return this._slatlng},setCenterPosition:function(a){this._slatlng=a;var b=new NXY(this._slatlng.x+Math.cos(this._sdegree/180*Math.PI)*this._distance,this._slatlng.y+Math.sin(this._sdegree/180*Math.PI)*this._distance);return this._passpoint=b,this.redraw()},getPassPoint:function(){return this._passpoint},setPassPoint:function(a){this._passpoint=a;var b=this._getangle(this._slatlng,this._passpoint);return this._sdegree=b,this._distance=(new NXY(this._passpoint.x,this._passpoint.y)).distanceTo(new NXY(this._slatlng.x,this._slatlng.y)),this.redraw()},getRadius:function(a){return NUtil.getDistByUnits(this._slatlng,this._passpoint,this._map.getUnits(),a)},geteDegree:function(){return this._edegree},seteDegree:function(a){return this._edegree=a,this.redraw()},getDraw:function(){return this._draw},setDraw:function(a){var a=Number(a)?1:0;return this._draw=a,this.redraw()},toAbsPixels:function(){var a,b;a=new NXY(this._slatlng.x+Math.cos(this._sdegree/180*Math.PI)*this._distance,this._slatlng.y+Math.sin(this._sdegree/180*Math.PI)*this._distance),b=new NXY(this._slatlng.x+Math.cos(this._edegree/180*Math.PI)*this._distance,this._slatlng.y+Math.sin(this._edegree/180*Math.PI)*this._distance),this._centerpoint=this._map._pointToAbsPixel(this._slatlng),this._startpoint=this._map._pointToAbsPixel(a),this._endpoint=this._map._pointToAbsPixel(b),this._radius=this._centerpoint.distanceTo(this._startpoint)},_getFitRadius:function(a){if(!this._map)return this._sRadius;a=a||this._map.getUnits();var b=this._sRadius;return b*NUtil.INCHES_PER_UNIT.m/NUtil.INCHES_PER_UNIT[a]},getPathString:function(){var a=this._centerpoint,b=this._startpoint,c=this._endpoint,d=this._radius,e,f;this._draw?((this._sdegree-this._edegree+360)%360<180?e=0:e=1,f=1):((this._edegree-this._sdegree+360)%360<180?e=0:e=1,f=0);if(NUtil.Browser.svg)return"M "+a.x+","+a.y+"L "+b.x+","+b.y+"A "+d+","+d+",0,"+e+","+f+","+c.x+","+c.y+"L "+a.x+","+a.y+" z";a._round(),b._round(),c._round(),d=Math.round(d),sd=Math.round(this._sdegree),ed=Math.round(this._edegree);if(this._draw){var g=(sd-ed+360)%360;return"M "+a.x+","+a.y+" L "+c.x+","+c.y+" AE "+a.x+","+a.y+", "+d+","+d+", "+65535*ed+","+65535*g+" M "+b.x+","+b.y+" L "+a.x+","+a.y+" e"}var g=(ed-sd+360)%360;return"M "+a.x+","+a.y+" L "+b.x+","+b.y+" AE "+a.x+","+a.y+", "+d+","+d+", "+65535*sd+","+65535*g+" M "+c.x+","+c.y+" L "+a.x+","+a.y+" e"},_getEditClass:function(){return NSector.Edit}}),NPoint=NCircle.extend({options:{radius:5,strokeWidth:2},_type:"NPoint",initialize:function(a,b){this.options=NUtil.extend(this.options,NPolygonOptions,b),this._radius=this.options.radius,NCircle.prototype.initialize.call(this,a,0,b)},toAbsPixels:function(){this._point=this._map._pointToAbsPixel(this._latlng)},getRadius:function(){return this._radius},setRadius:function(a){return this._radius=a,this.redraw()},_getEditClass:function(){return NPoint.Edit}}),NMultiPoint=NPoint.extend({_type:"NMultiPoint",initialize:function(a,b){this.options=NUtil.extend(this.options,NPolygonOptions,b),this._radius=this.options.radius,this._points=a},toAbsPixels:function(){this._pixels=[];for(var a=0;a<this._points.length;a++)this._pixels.push(this._map._pointToAbsPixel(this._points[a]))},getPathString:function(){for(var a=0,b=this._pixels.length,c="";a<b;a++)c+=this._getPathPartStr(this._pixels[a]);return c},_getPathPartStr:function(a){var b=a,c=this._radius;return this._checkIfEmpty(b)?"":NUtil.Browser.svg?"M"+b.x+","+(b.y-c)+"A"+c+","+c+",0,1,1,"+(b.x-.1)+","+(b.y-c)+" z":(b._round(),c=Math.round(c),"AL "+b.x+","+b.y+" "+c+","+c+" 0,"+23592600)},_checkIfEmpty:function(a){var b=this._map._pathViewport,c=this._radius;return a.x-c>b.maxX||a.y-c>b.maxY||a.x+c<b.minX||a.y+c<b.minY},getPoints:function(){return this._points},setPoints:function(a){return this._points=a,this.redraw()},getPointAt:function(a){if(a>this._points.length)return;var b=this._points[a],c=new NPoint(b,this.options);return c},setPointAt:function(a,b){this._points&&this._points.length>a&&b&&b instanceof NXY&&(this._points[a]=b,this.redraw())},addPoint:function(a){return this._points.push(a),this.redraw()},removePoints:function(a,b){var c=[].splice.apply(this._points,arguments);return this.redraw(),c},getBounds:function(){if(!this._map)return;var a=this._map.getUnits(),b=this._radius,c=b*NUtil.INCHES_PER_UNIT.m/NUtil.INCHES_PER_UNIT[a],d=null,e=this.getPoints();if(!e)return null;for(var f=0,g=e.length;f<g;f++)if(f==0&&!d)d=new NBounds(e[0].x-c,e[0].y-c,e[0].x+c,e[0].y+c);else{var h=new NBounds(e[f].x-c,e[f].y-c,e[f].x+c,e[f].y+c);d.extend(h)}return d},_getEditClass:function(){return NMultiPoint.Edit}}),NHotspot=NClass.extend({options:{text:"",buffer:5,minRes:null,maxRes:null,data:null},initialize:function(a,b){this._latlng=a,NUtil.setOptions(this,b,!0)},getBounds:function(){var a=null;return this._latlng?new NBounds(this._latlng.x,this._latlng.y,this._latlng.x,this._latlng.y):null},getText:function(){return this.options.text},setText:function(a){this.options.text=a},getPosition:function(){return this._latlng},checkValid:function(a,b){var c=this._getPointBounds(b);return c.contains(a)},_getPointBounds:function(a){if(typeof this.options.buffer=="number"){var b=this.buffer*a;return new NBounds(this._latlng.x-b,this._latlng.y-b,this._latlng.x+b,this._latlng.y+b)}return new NBounds(this._latlng.x-this.buffer.minX*a,this._latlng.y-this.buffer.minY*a,this._latlng.x+this.buffer.maxX*a,this._latlng.y+this.buffer.maxY*a)},_getWidth:function(a){return this.buffer.getWidth()*a},_getHeight:function(a){return this.buffer.getHeight()*a},setPosition:function(a){this._latlng=a},setData:function(a){this.data=a},getData:function(a){return this.data}}),NHandler=NClass.extend({includes:NEWMAP_JS_LIB.PublicParts.Events,initialize:function(a){this._map=a},enable:function(){if(this._enabled)return;this._enabled=!0,this.addHooks()},disable:function(){if(!this._enabled)return;this._enabled=!1,this.removeHooks()},enabled:function(){return!!this._enabled}}),NDraggable=NClass.extend({includes:NEWMAP_JS_LIB.PublicParts.Events,statics:{START:NUtil.Browser.touch?"touchstart":"mousedown",END:NUtil.Browser.touch?"touchend":"mouseup",MOVE:NUtil.Browser.touch?"touchmove":"mousemove",TAP_TOLERANCE:15},initialize:function(a,b){this._element=a,this._dragStartTarget=b||a},enable:function(){if(this._enabled)return;NEvent.addListener(this._dragStartTarget,NDraggable.START,this._onDown,this),NEvent.addListener(this._dragStartTarget,"click",this._onClick,this),this._enabled=!0},disable:function(){if(!this._enabled)return;NEvent.removeListener(this._dragStartTarget,NDraggable.START,this._onDown),NEvent.removeListener(this._dragStartTarget,"click",this._onClick,this),this._enabled=!1,this._moved=!1},_onDown:function(a){if(!NUtil.Browser.touch&&a.shiftKey||a.which!==1&&a.button!==1&&!a.touches)return;this._simulateClick=!0;if(a.touches&&a.touches.length>1){this._simulateClick=!1;return}var b=a.touches&&a.touches.length===1?a.touches[0]:a,c=b.target;NEvent.preventDefault(a),NEvent.stopPropagation(a),NUtil.Browser.touch&&c.tagName.toLowerCase()==="a"&&(c.className+=" newmap-active"),this.fire("predragstart",{pixel:NEvent.getMousePosition(a,c)}),this._moved=!1;if(this._moving)return;NUtil.Browser.touch||(NUtil.disableTextSelection(),this._setMovingCursor()),this._startPos=this._newPos=NUtil.getPosition(this._element),this._startPoint=new NXY(b.clientX,b.clientY),NEvent.addListener(document,NDraggable.MOVE,this._onMove,this),NEvent.addListener(document,NDraggable.END,this._onUp,this)},_onClick:function(a){NEvent.preventDefault(a),NEvent.stopPropagation(a)},_onMove:function(a){if(a.touches&&a.touches.length>1)return;NEvent.preventDefault(a);var b=a.touches&&a.touches.length===1?a.touches[0]:a;!this._moved&&b&&this._startPoint&&(b.clientX!=this._startPoint.x||b.clientY!=this._startPoint.y)&&(this.fire("dragstart",{pixel:NUtil.getPosition(this._element)}),this._moved=!0),this._moving=!0;var c=new NXY(b.clientX,b.clientY);this._newPos=this._startPos.add(c).subtract(this._startPoint),this._updatePosition(),NEvent.stopPropagation(a)},_updatePosition:function(){this.fire("predrag",{pixel:NUtil.getPosition(this._element)}),NUtil.setPosition(this._element,this._newPos),this.fire("drag",{pixel:this._newPos})},_onUp:function(a){if(this._simulateClick&&a.changedTouches){var b=a.changedTouches[0],c=b.target,d=this._newPos&&this._newPos.distanceTo(this._startPos)||0;c.tagName.toLowerCase()==="a"&&(c.className=c.className.replace(" newmap-active","")),d<NDraggable.TAP_TOLERANCE&&this._simulateEvent("click",b)}NUtil.Browser.touch||(NUtil.enableTextSelection(),this._restoreCursor()),NEvent.removeListener(document
,NDraggable.MOVE,this._onMove,this),NEvent.removeListener(document,NDraggable.END,this._onUp,this),this._moved&&this.fire("dragend",{pixel:NUtil.getPosition(this._element)}),this._moving=!1},_setMovingCursor:function(){document.body.className+=" newmap-dragging"},_restoreCursor:function(){document.body.className=document.body.className.replace(/ newmap-dragging/g,"")},_simulateEvent:function(a,b){var c=document.createEvent("MouseEvents");c.initMouseEvent(a,!0,!0,window,1,b.screenX,b.screenY,b.clientX,b.clientY,!1,!1,!1,!1,0,null),b.target.dispatchEvent(c)}}),NMap.Drag=NHandler.extend({_gragTag:!1,_element:null,_dragStartTarget:null,addHooks:function(){this._draggable||(this._element=this._map._mapPane,this._dragStartTarget=this._map._container,this.on("dragstart",this._onDragStart,this).on("predragstart",this._onDragStart,this).on("drag",this._onDrag,this).on("dragend",this._onDragEnd,this),this._draggable=!0);if(this._dragenabled)return;this._draggable&&(NEvent.addListener(this._dragStartTarget,NDraggable.START,this._onDown,this),NEvent.addListener(this._dragStartTarget,"click",this._onClick,this),this._dragenabled=!0)},removeHooks:function(){if(!this._dragenabled)return;NEvent.removeListener(this._dragStartTarget,NDraggable.START,this._onDown),NEvent.removeListener(this._dragStartTarget,"click",this._onClick,this),this._dragenabled=!1,this._moved=!1},_onDown:function(a){if(this._map._getAnimatingZoom()){this._gragTag=!1,NEvent.stop(a);return}if(!NUtil.Browser.touch&&a.shiftKey||a.which!==1&&a.button!==1&&!a.touches)return;this._simulateClick=!0;if(a.touches&&a.touches.length>1){this._simulateClick=!1;return}var b=a.touches&&a.touches.length===1?a.touches[0]:a,c=b.target;NEvent.preventDefault(a),NEvent.stopPropagation(a),NUtil.Browser.touch&&c.tagName.toLowerCase()==="a"&&(c.className+=" newmap-active"),this.fire("predragstart",{pixel:NEvent.getMousePosition(a,c)}),this._moved=!1;if(this._moving)return;NUtil.Browser.touch||(NUtil.disableTextSelection(),this._setMovingCursor()),this._startPos=this._newPos=NUtil.getPosition(this._element),this._startPoint=new NXY(b.clientX,b.clientY),NEvent.addListener(document,NDraggable.MOVE,this._onMove,this),NEvent.addListener(document,NDraggable.END,this._onUp,this)},_onClick:function(a){NEvent.preventDefault(a),NEvent.stopPropagation(a)},_onMove:function(a){if(a.touches&&a.touches.length>1)return;var b=a.touches&&a.touches.length===1?a.touches[0]:a;!this._moved&&b&&this._startPoint&&(b.clientX!=this._startPoint.x||b.clientY!=this._startPoint.y)&&(this.fire("dragstart",{pixel:NUtil.getPosition(this._element)}),this._moved=!0),this._moving=!0;var c=new NXY(b.clientX,b.clientY);this._newPos=this._startPos.add(c).subtract(this._startPoint),this._updatePosition(),NEvent.stopPropagation(a)},_updatePosition:function(){this.fire("predrag",{pixel:NUtil.getPosition(this._element)}),NUtil.setPosition(this._element,this._newPos),this.fire("drag",{pixel:this._newPos})},_onUp:function(a){if(this._simulateClick&&a.changedTouches){var b=a.changedTouches[0],c=b.target,d=this._newPos&&this._newPos.distanceTo(this._startPos)||0;c.tagName.toLowerCase()==="a"&&(c.className=c.className.replace(" newmap-active","")),d<NDraggable.TAP_TOLERANCE&&this._simulateEvent("click",b)}NUtil.Browser.touch||(NUtil.enableTextSelection(),this._restoreCursor()),NEvent.removeListener(document,NDraggable.MOVE,this._onMove,this),NEvent.removeListener(document,NDraggable.END,this._onUp,this),this._moved&&this.fire("dragend",{pixel:NUtil.getPosition(this._element)}),this._moving=!1},moved:function(){return this._moved},_setMovingCursor:function(){document.body.className+=" newmap-dragging"},_restoreCursor:function(){document.body.className=document.body.className.replace(/ newmap-dragging/g,"")},_simulateEvent:function(a,b){var c=document.createEvent("MouseEvents");c.initMouseEvent(a,!0,!0,window,1,b.screenX,b.screenY,b.clientX,b.clientY,!1,!1,!1,!1,0,null),b.target.dispatchEvent(c)},_onDragStart:function(){if(this._map._getAnimatingZoom()){this._gragTag=!1;return}this._gragTag=!0;var a=this._map;a.fire("movestart").fire("dragstart"),a._panTransition&&a._panTransition._onTransitionEnd(!0),a.inertia&&(this._positions=[],this._times=[])},_onDrag:function(){if(!this._gragTag)return;if(this._map.inertia){var a=this._lastTime=+(new Date),b=this._lastPos=this._newPos;this._positions=this._positions||[],this._positions.push(b),this._times.push(a),a-this._times[0]>200&&(this._positions.shift(),this._times.shift())}this._map.fire("drag"),this._map.fire("move")},_onDragEnd:function(){if(!this._gragTag)return;var a=this._map,b=a.options,c=+(new Date)-this._lastTime,d=NUtil.Browser.ie;if(d)a.fire("moveend");else{var e=this._lastPos.subtract(this._positions[0]),f=(this._lastTime+c-this._times[0])/1e3,g=e.multiplyBy(.58/f),h=g.distanceTo(new NXY(0,0)),i=Math.min(b.inertiaMaxSpeed,h),j=g.multiplyBy(i/h),k=i/b.inertiaDeceleration,l=j.multiplyBy(-k).round();f=Math.max(.5,f);var m={duration:f,easing:"ease-out"};this._map.panBy(l,m)}a.fire("dragend")}}),NMap.WheelZoom=NHandler.extend({addHooks:function(){NEvent.addListener(this._map._container,"mousewheel",this._onWheelScroll,this),this._delta=0},removeHooks:function(){NEvent.removeListener(this._map._container,"mousewheel",this._onWheelScroll)},_onWheelScroll:function(a){var b=NEvent.getWheelDelta(a);this._delta+=b,this._lastMousePos=NEvent.getMousePosition(a,this._map._container),clearTimeout(this._timer),this._timer=setTimeout(NUtil.bind(this._performZoom,this),50),NEvent.preventDefault(a)},_performZoom:function(){if(!this._map)return;if(this._map._getAnimatingZoom())return;this._iCenter=this._map._getCenter(),this._mCenter=this._map.pixelToPoint(this._lastMousePos);var a=this._map,b=Math.round(this._delta),c=a.getZoom();b=Math.max(Math.min(b,4),-4);var d=a.getZoomCount(),e=a.getZoom()+b;e=a._limitZoom(e),b=e-c,this._delta=0;if(!b)return;var f=a.getResByZoom(e)/a.getResolution(),g=this._mCenter.subtract(this._mCenter.subtract(this._iCenter).multiplyBy(f));a._zoomPos=this._lastMousePos;if(!a._zoomDirectionCtrl){var h=new NZoomDirectionControl;h._setMap(a)}a._zoomDirectionCtrl.enable(this._lastMousePos,b),a.setView(g,e)}}),NMap.DrawFeatureHandler=NHandler.extend({options:{styleOptions:{stroke:!0,strokeColor:"#ff0000",strokeWidth:2,strokeOpacity:.8,fill:!0,fillColor:"#FFFFFF",fillOpacity:1,editable:!0,clickable:!0}},_getStyleOptions:function(){this.options.styleOptions=this.options.styleOptions||{};var a=NUtil.extend({},this.options.styleOptions);return a=NUtil.extend(a,{editable:!1,clickable:!1,draggable:!1}),a},_getLineStyleOptions:function(){var a=this._getStyleOptions();return a=NUtil.extend(a,{fill:!1}),a},setHandlerOptions:function(a){this.options=this.options||{},a&&NUtil.extend(this.options,a),this.options.styleOptions=this.options.styleOptions||{},this.options.styleOptions=NUtil.extend(this.options.styleOptions,this.getStyleOptionClass(),a)},getStyleOptionClass:function(){return NUtil.extend(this._getStyleOptionClass(),{editable:!0})},_getStyleOptionClass:function(){return NUtil.extend({},NPolygonOptions)}}),NMap.DrawPoint=NMap.DrawFeatureHandler.extend({options:{styleOptions:{radius:5}},addHooks:function(){this._map.on("click",this._onMapClick,this)},removeHooks:function(){this._map.off("click",this._onMapClick)},_onMapClick:function(a){this.feature=new NPoint(a.point,this._getStyleOptions()),this._map.addOverlays(this.feature),this._map.fire("drawfeatureend",{feature:this.feature})},_getStyleOptions:function(){this.options.styleOptions=this.options.styleOptions||{};var a=NUtil.extend({},this.options.styleOptions);return a}}),NMap.DrawLine=NMap.DrawFeatureHandler.extend({options:{styleOptions:{stroke:!0,strokeColor:"#ff0000",strokeWidth:2,strokeOpacity:.8,fill:!1,fillColor:"#FFFFFF",fillOpacity:1,editable:!0,clickable:!0,labelable:!1,labelAnchor:new NXY(8,0),labelContent:""}},addHooks:function(){this._map.on("click",this._onMapClick,this),this._map.on("mousemove",this._onMouseMove,this),this._map.on("dblclick",this._onDoubleClick,this)},removeHooks:function(){this._map.off("click",this._onMapClick),this._map.off("mousemove",this._onMouseMove),this._map.off("dblclick",this._onDoubleClick),this._endDrawn(),this._drawnFeature=null},_endDrawn:function(){this._startPoint=null,delete this._startPoint,this._endPoint&&(this._endPoint=null,delete this._endPoint),this._label&&(this._label=null),this._tmpFeature&&(this._map&&this._map.removeOverlays(this._tmpFeature),this._tmpFeature=null,delete this._tmpFeature),this._drawnFeature&&(this.options.styleOptions&&this.options.styleOptions.editable&&this._drawnFeature.enableEdit(),this._map&&this._map.fire("drawfeatureend",{feature:this._drawnFeature}))},_onMapClick:function(a){this._drawnFeature?this._drawnFeature.addPoint(a.point):this._startPoint?(this._drawnFeature=new NPolyline([this._startPoint,a.point],this._getStyleOptions()),NUtil.stamp(this._drawnFeature),this._map.addOverlays(this._drawnFeature)):this._map.fire("drawfeaturestart"),this._startPoint=a.point,this.fire("addpoint",a)},_onMouseMove:function(a){if(!this._startPoint)return;if(NUtil.Browser.touch||NUtil.Browser.android)return;this._tmpFeature?this._tmpFeature.setPoints([this._startPoint,a.point]):(this._tmpFeature=new NPolyline([this._startPoint,a.point],this._getStyleOptions()),NUtil.stamp(this._tmpFeature),this._map.addOverlays(this._tmpFeature)),this.fire("movepoint",a)},_onDoubleClick:function(a){if(this._drawnFeature){var b=this._drawnFeature.getPoints();if(b){var c=b.length;c>3&&b[c-1].equals(b[c-2])&&this._drawnFeature.removePoints(c-1,1);if(this.options.styleOptions.labelable&&this.options.styleOptions.labelContent!=""&&c>=2&&!this._label){var d="newmap-label",e=Math.floor(c/2),f=e-1,g=new NXY((b[e].x+b[f].x)/2,(b[e].y+b[f].y)/2);g._round(),this._label=new NLabel(g,{offset:this.options.styleOptions.labelAnchor,content:this.options.styleOptions.labelContent,clickable:!1}),this._map.addOverlays(this._label),this._drawnFeature._label=this._label,this._label.addClass(d)}}}this._endDrawn(),this.fire("endpoint",a),this._drawnFeature=null},setLabel:function(a){if(!this._label)return;this._label.setContent(a)},_getStyleOptionClass:function(){return NUtil.extend({},NPolylineOptions)}}),NMap.DrawPolygon=NMap.DrawLine.extend({options:{styleOptions:{stroke:!0,strokeColor:"#ff0000",strokeWidth:2,strokeOpacity:.8,fill:!0,fillColor:"#F00faF",fillOpacity:.5,editable:!0,clickable:!0}},_onMapClick:function(a){!!this._drawnFeature&&this._drawnFeature instanceof NPolygon?this._drawnFeature.addPoint(a.point):this._startPoint?this._endPoint?(this._map.removeOverlays(this._drawnFeature),delete this._drawnFeature,this._drawnFeature=new NPolygon([this._startPoint,this._endPoint,a.point],this._getStyleOptions()),NUtil.stamp(this._drawnFeature),this._map.addOverlays(this._drawnFeature)):(this._drawnFeature=new NPolyline([this._startPoint,a.point],this._getLineStyleOptions()),NUtil.stamp(this._drawnFeature),this._map.addOverlays(this._drawnFeature)):this._map.fire("drawfeaturestart"),this._endPoint=this._startPoint?a.point:null,this._startPoint=this._startPoint||a.point,this.fire("addpoint",a)},_onMouseMove:function(a){if(!this._startPoint)return;if(NUtil.Browser.touch||NUtil.Browser.android)return;this._tmpFeature?this._endPoint?this._tmpFeature.setPoints([this._startPoint,a.point,this._endPoint]):this._tmpFeature.setPoints([this._startPoint,a.point]):(this._endPoint?this._tmpFeature=new NPolyline([this._startPoint,a.point,this._endPoint],this._getLineStyleOptions()):this._tmpFeature=new NPolyline([this._startPoint,a.point],this._getLineStyleOptions()),NUtil.stamp(this._tmpFeature),this._map.addOverlays(this._tmpFeature)),this.fire("movepoint",a)},_getStyleOptionClass:function(){return NUtil.extend({},NPolygonOptions)}}),NMap.DrawRect=NMap.DrawPolygon.extend({addHooks:function(){this._map.on("click",this._onMapClick,this),this._map.on("mousemove",this._onMouseMove,this)},removeHooks:function(){this._map.off("click",this._onMapClick),this._map.off("mousemove",this._onMouseMove),this._endDrawn()},_onMapClick:function(a){this._startPoint?(this._endTag=!0,this._drawnFeature?this._drawnFeature.setBounds(new NBounds(this._startPoint.x,this._startPoint.y,a.point.x,a.point.y)):(this._drawnFeature=new NRect(new NBounds(this._startPoint.x,this._startPoint.y,a.point.x,a.point.y),this._getStyleOptions()),NUtil.stamp(this._drawnFeature),this._map.addOverlays(this._drawnFeature)),this._endDrawn()):(this._endTag=!1,this._startPoint=a.point)},_endDrawn:function(){if(!this._startPoint)return;this._startPoint=null,this._drawnFeature&&(!this._endTag&&this._map?this._map.removeOverlays(this._drawnFeature):this._map&&this._map.fire("drawfeatureend",{feature:this._drawnFeature}),this.options.styleOptions&&this.options.styleOptions.editable&&this._drawnFeature.enableEdit(),this._drawnFeature=null,delete this._drawnFeature),this._endTag=!1},_onMouseMove:function(a){if(!this._startPoint)return;if(NUtil.Browser.touch||NUtil.Browser.android)return;this._drawnFeature?this._drawnFeature.setBounds(new NBounds(this._startPoint.x,this._startPoint.y,a.point.x,a.point.y)):(this._drawnFeature=new NRect(new NBounds(this._startPoint.x,this._startPoint.y,a.point.x,a.point.y),this._getStyleOptions()),NUtil.stamp(this._drawnFeature),this._map.addOverlays(this._drawnFeature))}}),NMap.DrawCircle=NMap.DrawRect.extend({addHooks:function(){this._map.on("click",this._onMapClick,this),this._map.on("mousemove",this._onMouseMove,this)},removeHooks:function(){this._map.off("click",this._onMapClick),this._map.off("mousemove",this._onMouseMove),this._endDrawn()},_onMapClick:function(a){if(!this._startPoint)this._endTag=!1,this._startPoint=a.point;else{this._endTag=!0;var b=NUtil.getFitDist(this._startPoint.distanceTo(a.point),this._map.getUnits(),"m");this._drawnFeature?this._drawnFeature.setRadius(b):(this._drawnFeature=new NCircle(this._startPoint,b,this._getStyleOptions()),NUtil.stamp(this._drawnFeature),this._map.addOverlays(this._drawnFeature)),this._endDrawn()}},_onMouseMove:function(a){if(!this._startPoint)return;if(NUtil.Browser.touch||NUtil.Browser.android)return;var b=NUtil.getFitDist(this._startPoint.distanceTo(a.point),this._map.getUnits(),"m");this._drawnFeature?this._drawnFeature.setRadius(b):(this._drawnFeature=new NCircle(this._startPoint,b,this._getStyleOptions()),NUtil.stamp(this._drawnFeature),this._map.addOverlays(this._drawnFeature))}}),NMap.DrawSector=NMap.DrawCircle.extend({addHooks:function(){this._map.on("click",this._onMapClick,this),this._map.on("mousemove",this._onMouseMove,this)},removeHooks:function(){this._map.off("click",this._onMapClick),this._map.off("mousemove",this._onMouseMove),this._endDrawn()},_onMapClick:function(a){if(!this._drawnFeature||!(this._drawnFeature instanceof NSector))if(!this._startPoint)this._endTag=!1,this._startPoint=this._startPoint||a.point;else if(!this._endPoint)this._endTag=!1,this._passPoint=a.point,this._endPoint=this._startPoint?a.point:null,this._drawnFeature=new NPolyline([this._startPoint,a.point],this._getLineStyleOptions()),NUtil.stamp(this._drawnFeature),this._map.addOverlays(this._drawnFeature);else{this._endTag=!0,this._map.removeOverlays(this._drawnFeature),delete this._drawnFeature,this._endPoint=this._startPoint?a.point:null;var b=(new NXY(this._endPoint.x,this._endPoint.y)).distanceTo(new NXY(this._startPoint.x,this._startPoint.y)),c=this._endPoint.y-this._startPoint.y,d;if(this._startPoint.x<this._endPoint.x&&this._startPoint.y<=this._endPoint.y)d=180*Math.asin(c/b)/Math.PI;else if(this._startPoint.x==this._endPoint.x&&this._startPoint.y<this._endPoint.y)d=180*Math.asin(c/b)/Math.PI;else if(this._startPoint.x>this._endPoint.x&&this._startPoint.y<this._endPoint.y)d=180-180*Math.asin(c/b)/Math.PI;else if(this._startPoint.x>this._endPoint.x&&this._startPoint.y>=this._endPoint.y)d=180-180*Math.asin(c/b)/Math.PI;else if(this._startPoint.x==this._endPoint.x&&this._startPoint.y>this._endPoint.y)d=180-180*Math.asin(c/b)/Math.PI;else{if(!(this._startPoint.x<this._endPoint.x&&this._startPoint.y>this._endPoint.y))return;d=360+180*Math.asin(c/b)/Math.PI}this._drawnFeature=new NSector(this._startPoint,this._passPoint,d,this._draw,this._getStyleOptions()),NUtil.stamp(this._drawnFeature),this._map.addOverlays(this._drawnFeature),this._endDrawn()}},_endDrawn:function(){if(!this._startPoint)return;this._startPoint=null,this._endPoint&&(this._endPoint=null,delete this._endPoint),this._tmpFeature&&(this._map&&this._map.removeOverlays(this._tmpFeature),this._tmpFeature=null,delete this._tmpFeature),this._movePoint&&(this._movePoint=null,delete this._movePoint),this._drawnFeature&&(!this._endTag&&this._map?this._map.removeOverlays(this._drawnFeature):this._map&&this._map.fire("drawfeatureend",{feature:this._drawnFeature}),this._drawnFeature=null,delete this._drawnFeature),this._endTag=!1,this._flag=1},_onMouseMove:function(a){if(!this._startPoint)return;if(NUtil.Browser.touch||NUtil.Browser.android)return;if(!this._tmpFeature)this._endPoint||(this._tmpFeature=new NPolyline([this._startPoint,a.point],this._getLineStyleOptions())),NUtil.stamp(this._tmpFeature),this._map.addOverlays(this._tmpFeature);else if(!this._endPoint)this._tmpFeature.setPoints([this._startPoint,a.point]);else{if(!this._movePoint)this._movePoint=a.point,this._flag=1;else{this._flag=this._flag+1;var b=(new NXY(this._startPoint.x,this._startPoint.y)).distanceTo(new NXY(this._passPoint.x,this._passPoint.y)),c=a.point.x-this._startPoint.x,d=a.point.y-this._startPoint.y,e=Math.sqrt(c*c+d*d),f=new NXY(c/e*b+this._startPoint.x,d/e*b+this._startPoint.y);if(this._flag==2){var g,h=this._passPoint.y-this._startPoint.y;this._startPoint.x<this._passPoint.x&&this._startPoint.y<=this._passPoint.y?g=180*Math.asin(h/b)/Math.PI:this._startPoint.x==this._passPoint.x&&this._startPoint.y<this._passPoint.y?g=180*Math.asin(h/b)/Math.PI:this._startPoint.x>this._passPoint.x&&this._startPoint.y<this._passPoint.y?g=180-180*Math.asin(h/b)/Math.PI:this._startPoint.x>this._passPoint.x&&this._startPoint.y>=this._passPoint.y?g=180-180*Math.asin(h/b)/Math.PI:this._startPoint.x==this._passPoint.x&&this._startPoint.y>this._passPoint.y?g=180-180*Math.asin(h/b)/Math.PI:this._startPoint.x<this._passPoint.x&&this._startPoint.y>this._passPoint.y&&(g=360+180*Math.asin(h/b)/Math.PI);var i;Math.abs(f.x-this._passPoint.x)>Math.abs(f.y-this._passPoint.y)?i=Math.abs(f.x-this._passPoint.x):i=Math.abs(f.y-this._passPoint.y);var j,k;g>=0&&g<90?(j=new NXY(i,-i),k=new NXY(-i,i)):g>=90&&g<180?(j=new NXY(i,i),k=new NXY(-i,-i)):g>=180&&g<270?(j=new NXY(-i,i),k=new NXY(i,-i)):(j=new NXY(-i,-i),k=new NXY(i,i));var l=new NXY(f.x-this._passPoint.x,f.y-this._passPoint.y);j.x*l.x+j.y*l.y>0&&k.x*l.x+k.y*l.y<0?this._draw=1:j.x*l.x+j.y*l.y<0&&k.x*l.x+k.y*l.y>0&&(this._draw=0)}}this._tmpFeature.setPoints([this._startPoint,a.point,this._passPoint])}}}),NMap.ZoomBoxHandler=NMap.DrawFeatureHandler.extend({options:{styleOptions:{stroke:!0,strokeColor:"#ff0000",strokeWidth:2,strokeOpacity:.8,fill:!0,fillColor:"#ff0000",fillOpacity:.2,editable:!1,clickable:!1},_zoomInTag:!1},getStyleOptionClass:function(){return this.options.styleOptions},addHooks:function(){this._map.on("mousedown",this._onMouseDown,this),this._map.on("mousemove",this._onMouseMove,this),this._map.on("mouseup",this._onMouseUp,this)},removeHooks:function(){this._map.off("mousedown",this._onMouseDown,this),this._map.off("mousemove",this._onMouseMove,this),this._map.off("mouseup",this._onMouseUp,this),this._drawnFeature&&this._map.removeOverlay(this._drawnFeature),this._drawnFeature=null,this._startPoint=null},_onMouseDown:function(a){if(!this._map)return;this._startPoint=null;if(this._map._getAnimatingZoom())return;a.point&&(this._startPoint=a.point)},_onMouseUp:function(a){if(!this._map)return;if(a.point&&this._startPoint&&this._drawnFeature){var b=new NBounds(this._startPoint.x,this._startPoint.y,a.point.x,a.point.y);this.options._zoomInTag?this._map.zoomToExtent(b):this._map.moveTo(b.getCenter(),this._map.getZoom()-1)}this._drawnFeature&&this._map.removeOverlays(this._drawnFeature),this._drawnFeature=null,this._startPoint=null},_onMouseMove:function(a){if(!this._map)return;if(!this._startPoint)return;this._drawnFeature?this._drawnFeature.setBounds(new NBounds(this._startPoint.x,this._startPoint.y,a.point.x,a.point.y)):(this._drawnFeature=new NRect(new NBounds(this._startPoint.x,this._startPoint.y,a.point.x,a.point.y),this.options.styleOptions),NUtil.stamp(this._drawnFeature),this._map.addOverlays(this._drawnFeature))}}),NMap.DrawMarker=NMap.DrawPoint.extend({options:{styleOptions:{markerClassName:"NMarker"}},setHandlerOptions:function(a){this.options=this.options||{},this.options.styleOptions=this.options.styleOptions||{},a&&a.markerClassName&&a.markerClassName.toLowerCase()=="nspritemarker"?this.options.styleOptions.markerClassName="NSpriteMarker":this.options.styleOptions.markerClassName="NMarker",this.options.styleOptions=NUtil.extend(this.options.styleOptions,this.getStyleOptionClass(),a)},_getStyleOptionClass:function(){return this.options.styleOptions.markerClassName=="NSpriteMarker"?NUtil.extend({},NSpriteMarkerOptions):NUtil.extend({},NMarkerOptions)},_onMapClick:function(a){this.options.styleOptions.markerClassName=="NSpriteMarker"?this.marker=new NSpriteMarker(a.point,this._getStyleOptions()):this.marker=new NMarker(a.point,this._getStyleOptions()),this._map.addOverlays(this.marker),this._map.fire("drawmarkerend",{marker:this.marker})}}),NMap.DoubleClickZoom=NHandler.extend({addHooks:function(){this._map.on("dblclick",this._onDoubleClick)},removeHooks:function(){this._map.off("dblclick",this._onDoubleClick)},_onDoubleClick:function(a){NEvent.stopPropagation(a),NEvent.preventDefault(a)}}),NMap.TouchZoom=NHandler.extend({addHooks:function(){NEvent.addListener(this._map._container,"touchstart",this._onTouchStart,this)},removeHooks:function(){NEvent.removeListener(this._map._container,"touchstart",this._onTouchStart,this)},_onTouchStart:function(a){var b=this._map;if(!a.touches||a.touches.length!==2||b._animatingZoom||this._zooming)return;var c=b._pixelToAbsPixel(NEvent.getMousePosition(a.touches[0],b._container)),d=b._pixelToAbsPixel(NEvent.getMousePosition(a.touches[1],b._container)),e=b._pixelToAbsPixel(b.getSize().divideBy(2));this._startCenter=c.add(d).divideBy(2,!0),this._startDist=c.distanceTo(d),this._moved=!1,this._zooming=!0,this._centerOffset=e.subtract(this._startCenter),NEvent.addListener(this._map._container,"touchmove",this._onTouchMove,this).addListener(this._map._container,"touchend",this._onTouchEnd,this),NEvent.preventDefault(a),NEvent.stopPropagation(a)},_onTouchMove:function(a){if(!a.touches||a.touches.length!==2)return;var b=this._map,c=b._pixelToAbsPixel(NEvent.getMousePosition(a.touches[0],b._container)),d=b._pixelToAbsPixel(NEvent.getMousePosition(a.touches[1],b._container)),e=b._pixelToAbsPixel(b.getSize().divideBy(2)),f=c.distanceTo(d);this._startCenter=c.add(d).divideBy(2,!0),this._scale=f/this._startDist,this._moved||(this._moved=!0),this._startCenter=c.add(d).divideBy(2,!0),this._centerOffset=e.subtract(this._startCenter);var g=b.pixelToPoint(NEvent.getMousePosition(a.touches[0],b._container)),h=b.pixelToPoint(NEvent.getMousePosition(a.touches[1],b._container));this._newCenter=h.add(g).divideBy(2),NEvent.preventDefault(a)},_onTouchEnd:function(a){if(!this._moved||!this._zooming)return;this._moved=!1,this._zooming=!1;var b=this._map.getCenter(),c=this._scale>1?this._map.getZoom()+1:this._map.getZoom()-1,d=this._map.getResByZoom(c);this._centerOffset&&this._newCenter&&(this._newCenter=this._newCenter.add(new NXY(this._centerOffset.x*d,-this._centerOffset.y*d))),d!=this._map.getResolution()&&this._map.setView(this._newCenter,c);return}}),NMap.MeasureLength=NMap.DrawLine.extend({_indexTag:0,_totalFixed:5,getStyleOptionClass:function(){return NUtil.extend(this._getStyleOptionClass(),{editable:!1,strokeColor:"#ff0000",strokeWidth:1,strokeOpacity:1})},addHooks:function(){NUtil.extend(this.options.styleOptions,{editable:!1,clickable:!1,draggable:!1}),NMap.DrawLine.prototype.addHooks.call(this),this._map.on("mousemove",this._onMouseMove2,this),this.on("addpoint",this._onPointAdd,this),this.on("movepoint",this._onPointMove,this),this.on("endpoint",this._onDrawEnd,this),this._map.on("drawfeatureend",this._onDrawFeatureEnd,this)},removeHooks:function(){if(this._drawnFeature){var a=this._drawnFeature.getPoints();if(a&&a.length>1){var b=a[a.length-1];this._onDoubleClick({point:b})}}this._map.off("mousemove",this._onMouseMove2,this),NMap.DrawLine.prototype.removeHooks.call(this),this.off("addpoint",this._onPointAdd),this.off("movepoint",this._onPointMove),this.off("endpoint",this._onDrawEnd),this._map.off("drawfeatureend",this._onDrawFeatureEnd),this._infoLabel&&this._map.removeOverlays(this._infoLabel),this._infoLabel=null},_onDrawFeatureEnd:function(a){this._addOverlay(a.feature,!0)},_onDoubleClick:function(a){this._endDrawn(),this.fire("endpoint",a),this._drawnFeature=null},_onPointAdd:function(a){if(a.point&&this._map){var b="",c="";if(!this._preMPoint)this._indexTag++,this._preMPoint=a.point,this._totalLen=0,b=" 起点 ",c=" newmap_measure_label";else{var d=this._getLen(this._preMPoint,a.point,this._map.getUnits());this._totalLen+=d,this._preMPoint=a.point,b=this.getFitLenStr(this._totalLen,2)}var e=new NPoint(a.point,{radius:4,strokeWidth:1,stroke:!0,strokeColor:"#ff0000",strokeOpacity:1,fill:!0,fillColor:"#ffffff",fillOpacity:1,editable:!1,clickable:!0}),f=new NLabel(a.point,{offset:new NXY(8,0),content:b,clickable:!1});this._addOverlay(e),this._addOverlay(f),f.addClass(c)}},_addOverlay:function(a,b){var c="measure_group_"+this._indexTag;this._overlays=this._overlays||{},this._overlays[c]=this._overlays[c]||{};var d=NUtil.stamp(a);return this._overlays[c][d]=a,this._map&&!b&&this._map.addOverlays(a),this},_getLen:function(a,b,c){return NUtil.getDistByUnits(a,b,c)},getFitLenStr:function(a,b,c){var d="米";return a>1e3&&(d="千米",a/=1e3),b!==undefined&&(a=a.toFixed(b)),c?{len:a,units:d}:a+d},_onPointMove:function(a){if(a.point&&this._map&&this._infoLabel){var b="",c=this._getLen(this._preMPoint,a.point,this._map.getUnits()),d=this._totalLen+c,e=this.getFitLenStr(d,this._totalFixed,!0);b='<span>总长：<span class="newmap_measure_dis">'+e.len+"</span>"+e.units+"</span>",b+="<br>",b+='<span class="newmap_measure_opinfo">单击确定地点，双击结束</span>',this._infoLabel.setContent(b)}},_onDrawEnd:function(a){if(a.point&&this._map){var b="";if(!this._preMPoint)b="总长： 0 米";else{var c=this._getLen(this._preMPoint,a.point,this._map.getUnits());this._totalLen+=c;var d=this.getFitLenStr(this._totalLen,this._totalFixed,!0);b='<span>总长：<span class="newmap_measure_dis">'+d.len+"</span>"+d.units+"</span>"}var e=new NMarker(a.point,{markerAnchor:new NXY(-8,6),clickable:!0,shadowUrl:null,markerSize:new NXY(14,14),imgUrl:NEWMAP_JS_LIB.NEWMAP_LIB_IMAGE_URL+"close.gif",zIndexOffset:900,draggable:!1}),f=new NLabel(a.point,{offset:new NXY(0,8),content:b,clickable:!1,zIndexOffset:9999});this._addOverlay(e),this._addOverlay(f),e.on("click",this._clearOverlays,this),e.setTitle("单击删除此线路"),e._measureId=this._indexTag,f.addClass(" newmap_measure_label"),this._infoLabel&&this._infoLabel.setVisible(!1),this._map.fire("measureend")}this._preMPoint=null},_clearOverlays:function(a){if(!a||!a.target)return;var b=a.target;groupId="measure_group_"+b._measureId;if(this._overlays&&this._overlays[groupId])for(var c in this._overlays[groupId])this._overlays[groupId].hasOwnProperty(c)&&(this._map.removeOverlays(this._overlays[groupId][c]),this._overlays[groupId][c]=null,delete this._overlays[groupId][c])},_onMouseMove2:function(a){this._infoLabel?this._infoLabel.setPosition(a.point):(this._infoLabel=new NLabel(a.point,{offset:new NXY(18,18),zIndexOffset:9998}),this._map.addOverlays(this._infoLabel),this._infoLabel.addClass(" newmap_measure_label"),this._infoLabel.setContent("单击确定起点")),this._infoLabel&&this._infoLabel.setVisible(!0)}}),NMap.MeasureArea=NMap.DrawPolygon.extend({_indexTag:0,_totalFixed:5,getStyleOptionClass:function(){return NUtil.extend(this._getStyleOptionClass(),{editable:!1,strokeColor:"#ff0000",strokeWidth:1,strokeOpacity:1,fillColor:"#dddddd"})},addHooks:function(){NUtil.extend(this.options.styleOptions,{editable:!1,clickable:!1,draggable:!1}),NMap.DrawPolygon.prototype.addHooks.call(this),this._map.on("mousemove",this._onMouseMove2,this),this.on("addpoint",this._onPointAdd,this),this.on("movepoint",this._onPointMove,this),this.on("endpoint",this._onDrawEnd,this),this._map.on("drawfeatureend",this._onDrawFeatureEnd,this)},removeHooks:function(){if(this._drawnFeature){var a=this._drawnFeature.getPoints();if(a&&a.length>1){var b=a[a.length-1];this._onDoubleClick({point:b})}}this._map.off("mousemove",this._onMouseMove2,this),NMap.DrawPolygon.prototype.removeHooks.call(this),this.off("addpoint",this._onPointAdd),this.off("movepoint",this._onPointMove),this.off("endpoint",this._onDrawEnd),this._map.off("drawfeatureend",this._onDrawFeatureEnd),this._infoLabel&&this._map.removeOverlays(this._infoLabel),this._infoLabel=null},_onDoubleClick:function(a){this._endDrawn(),this.fire("endpoint",a),this._drawnFeature=null},_onDrawFeatureEnd:function(a){this._addOverlay(a.feature,!0)},_getArea:function(a){var b=0;if(a&&a.length>2){var c=a[0],d=a[1],e=0,f=a[a.length-1],g=a.length;b=c.y*(f.x-d.x);for(var h=1;h<g;h++)e=(h+1)%g,b+=a[h].y*(a[h-1].x-a[e].x);b/=2}return b<0&&(b*=-1),b},_getFitArea:function(a){var b=0;a&&(b=this._getArea(a));var c=this._map.getUnits().toLowerCase();if(c!="km"){var d=NUtil.INCHES_PER_UNIT[c];b*=Math.pow(d/NUtil.INCHES_PER_UNIT.km,2),c="km"}b<.001&&(b*=Math.pow(NUtil.INCHES_PER_UNIT.km/NUtil.INCHES_PER_UNIT.m,2),c="m"),b=b.toFixed(5);var e={len:Math.abs(b),units:c};return e},_getAreaBylonlat:function(a){var b=6378137,c=Math.PI/180,d=0;if(a&&a.length>2){var e=a.length;for(var f=0;f<e;f++){var g=a[f].x,h=a[f].y,i=a[(f+1)%e].x,j=a[(f+1)%e].y;d+=(i-g)*c*(2+Math.sin(h*c)+Math.sin(j*c))}d=d*b*b/2}d<0&&(d*=-1);var k="m";d>1e3&&(d*=Math.pow(NUtil.INCHES_PER_UNIT.m/NUtil.INCHES_PER_UNIT.km,2),k="km"),d=d.toFixed(5);var l={len:Math.abs(d),units:k};return l},_onPointAdd:function(a){if(a.point&&this._map){!this._drawnFeature&&this._startPoint&&!this._endPoint&&this._indexTag++;if(this._drawnFeature){var b="",c="",d=this._drawnFeature.getPoints(),e,f=this._map.getUnits().toLowerCase();f=="dd"||f=="degrees"?e=this._getAreaBylonlat(d):e=this._getFitArea(d),b='<span>总面积：<span class="newmap_measure_dis">'+e.len+"</span>"+e.units+"<sup>2</sup></span>",b+="<br>",b+='<span class="newmap_measure_opinfo">单击确定地点，双击结束</span>',this._infoLabel?(this._infoLabel.setContent(b),this._infoLabel.setPosition(a.point)):(this._infoLabel=new NLabel(a.point,{offset:new NXY(8,0),content:b,clickable:!1,zIndexOffset:9998}),this._addOverlay(this._infoLabel))}var g=new NPoint(a.point,{radius:4,strokeWidth:1,stroke:!0,strokeColor:"#ff0000",strokeOpacity:1,fill:!0,fillColor:"#ffffff",fillOpacity:1,editable:!1,clickable:!0});this._addOverlay(g)}},_addOverlay:function(a,b){var c="measure_group_"+this._indexTag;this._overlays=this._overlays||{},this._overlays[c]=this._overlays[c]||{};var d=NUtil.stamp(a);return this._overlays[c][d]=a,this._map&&!b&&this._map.addOverlays(a),this},_onPointMove:function(a){if(a.point&&this._map&&this._infoLabel){var b=null;if(this._drawnFeature){b=[];var c=this._drawnFeature.getPoints();for(var d=0;d<c.length;d++)b.push(c[d]);a.point&&b.push(a.point)}else{if(!this._startPoint||!this._endPoint)return;b=[this._startPoint,this._endPoint,a.point]}var e,f=this._map.getUnits().toLowerCase();f=="dd"||f=="degrees"?e=this._getAreaBylonlat(b):e=this._getFitArea(b),content='<span>总面积：<span class="newmap_measure_dis">'+e.len+"</span>"+e.units+"<sup>2</sup></span>",content+="<br>",content+='<span class="newmap_measure_opinfo">单击确定地点，双击结束</span>',this._infoLabel.setContent(content)}},_onDrawEnd:function(a){if(a.point&&this._map){var b="";if(!this._drawnFeature)b="总面积： 0 米<sup>2</sup>";else{var c=this._drawnFeature.getPoints(),d,e=this._map.getUnits().toLowerCase();e=="dd"||e=="degrees"?d=this._getAreaBylonlat(c):d=this._getFitArea(c),b='<span>总面积：<span class="newmap_measure_dis">'+d.len+"</span>"+d.units+"<sup>2</sup></span>"}var f=new NMarker(a.point,{markerAnchor:new NXY(-8,6),clickable:!0,shadowUrl:null,markerSize:new NXY(14,14),imgUrl:NEWMAP_JS_LIB.NEWMAP_LIB_IMAGE_URL+"close.gif",draggable:!1,zIndexOffset:9999}),g=new NLabel(a.point,{offset:new NXY(0,8),content:b,clickable:!1,zIndexOffset:9999});this._addOverlay(f),this._addOverlay(g),f.on("click",this._clearOverlays,this),f.setTitle("单击删除此线路"),f._measureId=this._indexTag,g.addClass(" newmap_measure_label"),this._infoLabel&&this._infoLabel.setVisible(!1),this._map.fire("measureend")}this._preMPoint=null},_clearOverlays:function(
a){if(!a||!a.target)return;var b=a.target;groupId="measure_group_"+b._measureId;if(this._overlays&&this._overlays[groupId])for(var c in this._overlays[groupId])this._overlays[groupId].hasOwnProperty(c)&&(this._map.removeOverlays(this._overlays[groupId][c]),this._overlays[groupId][c]=null,delete this._overlays[groupId][c])},_onMouseMove2:function(a){this._infoLabel?this._infoLabel.setPosition(a.point):(this._infoLabel=new NLabel(a.point,{offset:new NXY(18,18)}),this._map.addOverlays(this._infoLabel),this._infoLabel.addClass(" newmap_measure_label"),this._infoLabel.setContent("单击确定地点")),this._infoLabel&&this._infoLabel.setVisible(!0)}}),NHandlerHash={drag:NMap.Drag,doubleclickzoom:NMap.DoubleClickZoom,scrollwheelzoom:NMap.WheelZoom,drawpoint:NMap.DrawPoint,drawline:NMap.DrawLine,drawpolygon:NMap.DrawPolygon,drawrect:NMap.DrawRect,drawcircle:NMap.DrawCircle,drawsector:NMap.DrawSector,drawmarker:NMap.DrawMarker,zoomboxin:NMap.ZoomBoxHandler,zoomboxout:NMap.ZoomBoxHandler,touchzoom:NMap.TouchZoom,measurelength:NMap.MeasureLength,measurearea:NMap.MeasureArea},NElement.Drag=NHandler.extend({initialize:function(a){this._element=a},addHooks:function(){var a=this._element._getMoveTarget(),b=this._element._getDragTarget();this._draggable||(this._draggable=new NDraggable(b,a)),this._draggable.on("dragstart",this._onDragStart,this).on("drag",this._onDrag,this).on("dragend",this._onDragEnd,this),this._draggable.enable()},removeHooks:function(){this._draggable.off("dragstart",this._onDragStart,this).off("drag",this._onDrag,this).off("dragend",this._onDragEnd,this),this._draggable.disable()},moved:function(){return this._draggable&&this._draggable._moved},_onDragStart:function(a){this._element._dialog&&this._element.closeDialog(),this._element.fire("movestart").fire("dragstart")},_onDrag:function(a){var b=NUtil.getPosition(this._element._getDragTarget()),c=this._element._map._absPixelToPoint(b);this._element._onDragUpdate&&this._element._onDragUpdate({absPixel:b,point:c}),this._element.fire("move").fire("drag")},_onDragEnd:function(){this._element.fire("moveend").fire("dragend")}}),NPolygon.Edit=NHandler.extend({options:{},initialize:function(a,b){this._feature=a,NUtil.setOptions(this,b)},addHooks:function(){this._feature._map&&(this._markerGroup||this._initDivAnchors(),this._feature._map.addLayer(this._markerGroup))},removeHooks:function(){this._feature._map&&(this._feature._map.removeLayer(this._markerGroup),delete this._markerGroup,delete this._markers)},_updateDivAnchors:function(){this._markerGroup.clearOverlays(),this._initDivAnchors()},_initDivAnchors:function(){this._markerGroup=new NOverlayLayer,this._markers=[];var a=this._feature._points,b,c,d,e;for(b=0,d=a.length;b<d;b++)e=this._createDivAnchor(a[b],b),e.on("click",this._onMarkerClick,this),this._markers.push(e);var f,g;for(b=0,c=d-1;b<d;c=b++){if(b===0&&!(NPolygon&&this._feature instanceof NPolygon))continue;f=this._markers[c],g=this._markers[b],this._createMiddleDivAnchor(f,g),this._updatePrevNext(f,g)}},_createDivAnchor:function(a,b){var c="拖动改变位置，点击删除节点";b==-2&&(c="拖动增加节点",delete b);var d=new NEditDivAnchor(a,{draggable:!0,title:c});return d._featurePos=a,d._index=b,d.on("drag",this._onMarkerDrag,this),d.on("dragend",this._fireEdit,this),this._markerGroup||(this._markerGroup=new NOverlayLayer),this._markerGroup.addOverlay(d),d},_fireEdit:function(){this._feature.fire("edit",{feature:this._feature})},_onMarkerDrag:function(a){var b=a.target;NUtil.extend(b._featurePos,b._latlng),b._middleLeft&&b._middleLeft.setPosition(this._getMiddleLatLng(b._prev,b)),b._middleRight&&b._middleRight.setPosition(this._getMiddleLatLng(b,b._next)),this._feature.redraw()},_onMarkerClick:function(a){if(this._feature._points.length<=3)return;var b=a.target,c=b._index;b._prev&&b._next&&(this._createMiddleDivAnchor(b._prev,b._next),this._updatePrevNext(b._prev,b._next)),this._markerGroup.removeOverlay(b),b._middleLeft&&this._markerGroup.removeOverlay(b._middleLeft),b._middleRight&&this._markerGroup.removeOverlay(b._middleRight),this._feature.removePoints(c,1),this._updateIndexes(c,-1),this._feature.fire("edit",{feature:this._feature})},_updateIndexes:function(a,b){this._markerGroup._iterateLayers(function(c){c._index>a&&(c._index+=b)})},_createMiddleDivAnchor:function(a,b){var c=this._getMiddleLatLng(a,b),d=this._createDivAnchor(c,-2),e,f,g;d.setOpacity(.6),a._middleRight=b._middleLeft=d,f=function(){var f=b._index;d._index=f,d.off("click",e).on("click",this._onMarkerClick,this),this._feature.removePoints(f,0,c),this._markers.splice(f,0,d),d.setOpacity(1),this._updateIndexes(f,1),b._index++,this._updatePrevNext(a,d),this._updatePrevNext(d,b)},g=function(){d.off("dragstart",f,this),d.off("dragend",g,this),this._createMiddleDivAnchor(a,d),this._createMiddleDivAnchor(d,b)},e=function(){f.call(this),g.call(this),this._feature.fire("edit",{feature:this._feature})},d.on("click",e,this).on("dragstart",f,this).on("dragend",g,this),this._markerGroup.addOverlay(d)},_updatePrevNext:function(a,b){a._next=b,b._prev=a},_getMiddleLatLng:function(a,b){var c=this._feature._map,d=c._pointToAbsPixel(a.getPosition()),e=c._pointToAbsPixel(b.getPosition());return c._absPixelToPoint(d._add(e).divideBy(2))}}),NPolyline.Edit=NPolygon.Edit.extend({_updatePrevNext:function(a,b){a&&(a._next=b?b:null),b&&(b._prev=a?a:null)},_onMarkerClick:function(a){if(this._feature._points.length<=2)return;var b=a.target,c=b._index;b._prev&&b._next?this._createMiddleDivAnchor(b._prev,b._next):b._prev?b._prev._middleRight=null:b._next&&(b._next._middleLeft=null),this._updatePrevNext(b._prev,b._next),b._middleLeft&&this._markerGroup.removeOverlay(b._middleLeft),b._middleRight&&this._markerGroup.removeOverlay(b._middleRight),this._markerGroup.removeOverlay(b),this._feature.removePoints(c,1),this._updateIndexes(c,-1),this._feature.fire("edit",{feature:this._feature})},_initDivAnchors:function(){this._markerGroup=new NOverlayLayer,this._markers=[];var a=this._feature._points,b,c,d,e;for(b=0,d=a.length;b<d;b++)e=this._createDivAnchor(a[b],b),e.on("click",this._onMarkerClick,this),this._markers.push(e);var f,g;for(b=1,c=0;b<d;c=b++){if(b===0&&!(NPolyline&&this._feature instanceof NPolyline))continue;f=this._markers[c],g=this._markers[b],this._createMiddleDivAnchor(f,g),this._updatePrevNext(f,g)}}}),NMultiPolyline.Edit=NPolyline.Edit.extend({_createDivAnchor:function(a,b,c){var d="拖动改变位置，点击删除节点";b==-2&&(d="拖动增加节点",delete b);var e=new NEditDivAnchor(a,{draggable:!0,title:d});return e._featurePos=a,e._index=b,e._commplent=c,e.on("drag",this._onMarkerDrag,this),e.on("dragend",this._fireEdit,this),this._markerGroup||(this._markerGroup=new NOverlayLayer),this._markerGroup.addOverlay(e),e},_onMarkerClick:function(a){var b=0;if(this._feature.getType().toLowerCase()=="nmultipolyline"){if(this._feature._points.length==1&&this._feature._points[0].length<=2)return;b=1}else{if(this._feature._points.length==1&&this._feature._points[0].length<=3)return;b=4}var c=a.target,d=c._index,e=c._commplent;c._prev&&c._next?this._createMiddleDivAnchor(c._prev,c._next):c._prev?c._prev._middleRight=null:c._next&&(c._next._middleLeft=null),this._updatePrevNext(c._prev,c._next),c._middleLeft&&this._markerGroup.removeOverlay(c._middleLeft),c._middleRight&&this._markerGroup.removeOverlay(c._middleRight),this._markerGroup.removeOverlay(c),(new NPolyline(this._feature._points[e])).removePoints(d,1);var f=new Array,g=!1,h=this._markerGroup._overlays;for(var i in h){var j=h[i];j._commplent==e&&f.push(j);if(f.length>b)break}if(f.length<b+1){for(var k=0;k<f.length;k++)this._markerGroup.removeOverlay(f[k]);this._feature._points.splice(e,1),this._updateCommplent(e),g=!0}g||this._updateIndexes(d,e,-1),this._feature.fire("edit",{feature:this._feature}),this._feature.redraw()},_updateIndexes:function(a,b,c){this._markerGroup._iterateLayers(function(d){d._commplent==b&&d._index>a&&(d._index+=c)})},_updateCommplent:function(a){var b=this._markerGroup._overlays;for(var c in b)if(b.hasOwnProperty(c)){var d=b[c];d._commplent>a&&(d._commplent+=-1)}},_initDivAnchors:function(){this._markerGroup=new NOverlayLayer,this._markers=[];var a=this._feature._points,b,c,d,e,f,g;for(var e=0,f=a.length;e<f;e++){var h=a[e];for(b=0,d=h.length;b<d;b++)g=this._createDivAnchor(h[b],b,e),g.on("click",this._onMarkerClick,this),this._markers.push(g)}var i,j,k=0;for(e=0;e<f;e++){d=a[e].length,e>0&&(k+=a[e-1].length);for(b=1,c=0;b<d;c=b++){if(b===0&&!(NPolyline&&this._feature instanceof NPolyline))continue;i=this._markers[c+k],j=this._markers[b+k],this._createMiddleDivAnchor(i,j),this._updatePrevNext(i,j)}}},_createMiddleDivAnchor:function(a,b){var c=this._getMiddleLatLng(a,b),d=this._createDivAnchor(c,-2,a._commplent),e,f,g;d.setOpacity(.6),a._middleRight=b._middleLeft=d,f=function(){var f=b._index,g=b._commplent;d._index=f,d._commplent=g,d.off("click",e).on("click",this._onMarkerClick,this),(new NPolyline(this._feature._points[g])).removePoints(f,0,c),this._markers.splice(f,0,d),d.setOpacity(1),this._updateIndexes(f,g,1),b._index++,this._updatePrevNext(a,d),this._updatePrevNext(d,b)},g=function(){d.off("dragstart",f,this),d.off("dragend",g,this),this._createMiddleDivAnchor(a,d),this._createMiddleDivAnchor(d,b)},e=function(){f.call(this),g.call(this),this._feature.fire("edit",{feature:this._feature})},d.on("click",e,this).on("dragstart",f,this).on("dragend",g,this),this._markerGroup.addOverlay(d)}}),NMultiPolygon.Edit=NMultiPolyline.Edit.extend({_initDivAnchors:function(){this._markerGroup=new NOverlayLayer,this._markers=[];var a=this._feature._points,b,c,d,e,f,g;for(var e=0,f=a.length;e<f;e++){var h=a[e];for(b=0,d=h.length;b<d;b++)g=this._createDivAnchor(h[b],b,e),g.on("click",this._onMarkerClick,this),this._markers.push(g)}var i,j,k=0;for(e=0;e<f;e++){d=a[e].length,e>0&&(k+=a[e-1].length);for(b=0,c=d-1;b<d;c=b++){if(b===0&&!(NMultiPolygon&&this._feature instanceof NMultiPolygon))continue;i=this._markers[c+k],j=this._markers[b+k],this._createMiddleDivAnchor(i,j),this._updatePrevNext(i,j)}}}}),NRect.Edit=NPolygon.Edit.extend({_initDivAnchors:function(){this._markerGroup=new NOverlayLayer,this._markers=[];var a=this._feature._points,b,c,d,e;for(b=0,d=a.length;b<d;b++)e=this._createDivAnchor(a[b],b),this._markers.push(e)},_createDivAnchor:function(a,b){var c=new NEditDivAnchor(a,{draggable:!0});return c._featurePos=a,c._index=b,c.on("drag",this._onMarkerDrag,this),c.on("dragend",this._fireEdit,this),this._markerGroup.addOverlay(c),c},_fireEdit:function(){this._feature.fire("edit",{feature:this._feature})},_onMarkerDrag:function(a){var b=a.target,c=b._index;c===0||c===1?(this._updateVertics(0,b,"x"),this._updateVertics(1,b,"x")):(this._updateVertics(2,b,"x"),this._updateVertics(3,b,"x")),c===0||c===3?(this._updateVertics(0,b,"y"),this._updateVertics(3,b,"y")):(this._updateVertics(1,b,"y"),this._updateVertics(2,b,"y")),this._feature.redraw()},_updateVertics:function(a,b,c){if(!this._markers)return;this._markers[a]._latlng[c]=b._latlng[c],this._markers[a]._update(),this._markers[a]._featurePos[c]=b._latlng[c]}}),NCircle.Edit=NPolygon.Edit.extend({_initDivAnchors:function(){this._markerGroup=new NOverlayLayer,this._markers=[];var a=this._feature.getPosition(),b=this._feature._getFitRadius(),c=this._createDivAnchor(a,0);this._markers.push(c);var d=this._createDivAnchor(new NXY(a.x+b,a.y),1);this._markers.push(d)},_createDivAnchor:function(a,b){var c=new NEditDivAnchor(a,{draggable:!0});return c._featurePos=a,c._index=b,c.on("drag",this._onMarkerDrag,this),c.on("dragend",this._fireEdit,this),this._markerGroup.addOverlay(c),c},_fireEdit:function(){this._feature.fire("edit",{feature:this._feature})},_onMarkerDrag:function(a){var b,c=a.target,d=c._index,e=this._feature._getFitRadius();if(d===0)b=c._latlng,this._feature.setPosition(b),this._markers[1].setPosition(new NXY(b.x+e,b.y));else if(d===1){var e=this._markers[0]._latlng.distanceTo(c._latlng);this._feature.setRadius(e,this._feature._map.getUnits())}this._feature.redraw()},_updateVertics:function(a,b,c){if(!this._markers)return;this._markers[a]._latlng[c]=b._latlng[c],this._markers[a]._update(),this._markers[a]._featurePos[c]=b._latlng[c]}}),NSector.Edit=NCircle.Edit.extend({_initDivAnchors:function(){this._markerGroup=new NOverlayLayer,this._markers=[];var a=this._feature.getCenterPosition(),b=this._feature.getPassPoint(),c=this._feature.geteDegree(),d=(new NXY(b.x,b.y)).distanceTo(new NXY(a.x,a.y)),e=new NXY(a.x+Math.cos(c/180*Math.PI)*d,a.y+Math.sin(c/180*Math.PI)*d),f=this._createDivAnchor(a,0);this._markers.push(f);var g=this._createDivAnchor(b,1);this._markers.push(g);var h=this._createDivAnchor(e,2);this._markers.push(h)},_onMarkerDrag:function(a){var b=a.target,c=b._index;if(c===0){var d=this._feature.getCenterPosition(),e=this._markers[1]._latlng.distanceTo(d),f=b._latlng;this._feature.setCenterPosition(f);var g=this._feature._sdegree,h=this._feature.geteDegree(),i=new NXY(f.x+Math.cos(g/180*Math.PI)*e,f.y+Math.sin(g/180*Math.PI)*e),j=new NXY(f.x+Math.cos(h/180*Math.PI)*e,f.y+Math.sin(h/180*Math.PI)*e);this._markers[1].setPosition(i),this._markers[2].setPosition(j),this._feature._passpoint=i}else if(c===1||c===2){var k,i,l=this._markers[0]._latlng,m=b._latlng,e=l.distanceTo(m),n=this._feature._getangle(l,m);this._feature._distance=e,c===1?(this._feature._sdegree=n,k=this._markers[2]._latlng,i=m):(this._feature.seteDegree(n),k=this._markers[1]._latlng,i=new NXY(l.x+Math.cos(this._feature._sdegree/180*Math.PI)*e,l.y+Math.sin(this._feature._sdegree/180*Math.PI)*e)),this._feature._passpoint=i;var o=k.x-this._markers[0]._latlng.x,p=k.y-this._markers[0]._latlng.y,q=Math.sqrt(o*o+p*p),j=new NXY(o/q*e+this._markers[0]._latlng.x,p/q*e+this._markers[0]._latlng.y);c===1?this._markers[2].setPosition(j):this._markers[1].setPosition(j)}this._feature.redraw()}}),NPoint.Edit=NCircle.Edit.extend({_initDivAnchors:function(){this._markerGroup=new NOverlayLayer,this._markers=[];var a=this._feature.getPosition(),b=this._feature._getFitRadius(),c=this._createDivAnchor(a,0);this._markers.push(c)}}),NMultiPoint.Edit=NPolygon.Edit.extend({_initDivAnchors:function(){this._markerGroup=new NOverlayLayer,this._markers=[];var a=this._feature._points,b,c,d,e;for(b=0,d=a.length;b<d;b++)e=this._createDivAnchor(a[b],b),e.on("click",this._onMarkerClick,this),this._markers.push(e)},_onMarkerDrag:function(a){var b,c=a.target,d=c._index,b=c._latlng;this._feature.setPointAt(d,b)},_onMarkerClick:function(a){if(this._feature._points.length<2)return;var b=a.target,c=b._index;this._markerGroup.removeOverlay(b),this._feature.removePoints(c,1),this._feature.fire("edit",{feature:this._feature})}}),NGroupOverlay=NSpriteMarker.extend({initialize:function(a,b,c){this.options=NUtil.extend({},NGroupOverlayOptions,c),this._latlng=a,this._num=b},_initMarker:function(){this._markerTarget||(this._markerTarget=NUtil.create("div","newmap-marker-span")),this._markerDiv||(this._markerDiv=NUtil.create("div","newmap-marker-div",this._markerTarget)),this._markerText||(this._markerText=NUtil.create("div","newmap-group-text",this._markerDiv),this._markerText.innerHTML=this._num),this._img||(this._img=this._createMarkerImg(),this._markerDiv.appendChild(this._img),this._initInteraction()),this._map._panes.markerPane.appendChild(this._markerTarget)},_createMarkerImg:function(){this.options.autoStyle===!0&&(this._num<9?(this.options.imgUrl=NEWMAP_JS_LIB.NEWMAP_LIB_IMAGE_URL+"m1.png",this.options.markerSize=new NXY(53,53),this.options.textOffset=new NXY(0,18),this.options.markerAnchor=new NXY(26,26)):this._num<99?(this.options.imgUrl=NEWMAP_JS_LIB.NEWMAP_LIB_IMAGE_URL+"m2.png",this.options.markerSize=new NXY(56,56),this.options.textOffset=new NXY(2,19),this.options.markerAnchor=new NXY(28,28)):this._num<999?(this.options.imgUrl=NEWMAP_JS_LIB.NEWMAP_LIB_IMAGE_URL+"m3.png",this.options.markerSize=new NXY(66,66),this.options.textOffset=new NXY(6,24),this.options.markerAnchor=new NXY(33,33)):this._num<9999?(this.options.imgUrl=NEWMAP_JS_LIB.NEWMAP_LIB_IMAGE_URL+"m4.png",this.options.markerSize=new NXY(78,78),this.options.textOffset=new NXY(13,30),this.options.markerAnchor=new NXY(39,39)):(this.options.imgUrl=NEWMAP_JS_LIB.NEWMAP_LIB_IMAGE_URL+"m5.png",this.options.markerSize=new NXY(90,90),this.options.textOffset=new NXY(18,36),this.options.markerAnchor=new NXY(45,45)));var a=this.options.imgUrl;if(!a)return null;var b=this._createImg(a);return b.className="newmap-marker-img",this.options.title&&(b.title=this.options.title),b},_updateMarker:function(){var a=this.options.imgOffset,b=this.options.markerSize,c=this.options.markerAnchor,d=this.options.markerTitle,e=this.options.textOffset;this._markerDiv&&(this._markerDiv.style.marginLeft=-c.x+"px",this._markerDiv.style.marginTop=-c.y+"px",this._markerDiv.style.width=b.x+"px",this._markerDiv.style.height=b.y+"px"),this._markerText&&(this._markerText.style.left=e.x+"px",this._markerText.style.top=e.y+"px"),this._img&&(a&&(this._img.style.left=-a.x+"px",this._img.style.top=-a.y+"px"),this._img.title=d?d:"")},_initInteraction:function(){this.options.clickable&&(this._img.className+=" newmap-clickable",NEvent.addListener(this._img,"click",this._onMouseClick,this),NEvent.addListener(this._markerText,"click",this._onMouseClick,this))},_removeMarker:function(){this._markerDiv.removeChild(this._img),this._markerDiv.removeChild(this._markerText),this._markerTarget.removeChild(this._markerDiv),this._map._panes.markerPane.removeChild(this._markerTarget),this._markerTarget=this._markerDiv=this._markerText=this._img=null}}),NGroupOverlayOptions={imgUrl:NEWMAP_JS_LIB.NEWMAP_LIB_IMAGE_URL+"m1.png",markerSize:new NXY(53,53),imgOffset:new NXY(0,0),textOffset:new NXY(0,0),markerAnchor:new NXY(26,26),markerTitle:"",autoStyle:!0,popable:!0,clickable:!0,visible:!0,zIndexOffset:0},NGroup=NClass.extend({includes:NEWMAP_JS_LIB.PublicParts.Events,initialize:function(a){this._markerGroup=a,this._map=a.getMap(),this._minGroupSize=a.getMinGroupSize(),this._isAverageCenter=a.isAverageCenter(),this._groupMarker=null,this._center=null,this._markers=[],this._gridBounds=null,this._isReal=!1},_addMarker:function(a){if(!this._center)this._center=a.getPosition(),this._updateGridBounds();else if(this._isAverageCenter){var b=this._markers.length+1,c=(this._center.y*(b-1)+a.getPosition().y)/b,d=(this._center.x*(b-1)+a.getPosition().x)/b;this._center=new NXY(d,c),this._updateGridBounds()}a.isInGroup=!0,this._markers.push(a);var e=this._markers.length;if(e>=this._minGroupSize){if(!(this._map.getZoom()<this._markerGroup.getMaxZoom())){this._map.removeOverlays(this._groupMarker),this._map.addOverlays(this._markers);return}this._map.removeOverlays(this._markers),this._groupMarker instanceof NGroupOverlay&&this._map.removeOverlays(this._groupMarker),this._groupMarker=new NGroupOverlay(this._center,e,this._markerGroup.getStyle()),this._map.addOverlays(this._groupMarker),this._isReal=!0;var f=this._map,g=new NBounds(this._center.x,this._center.y,this._center.x,this._center.y);for(var h=this._markers.length-1;h>=0;h--)g.extend(this._markers[h].getPosition());this._groupMarker.on("click",function(){f.zoomToExtent(g)})}else this._map.addOverlays(a)},_updateGridBounds:function(){var a=new NBounds(this._center.x,this._center.y,this._center.x,this._center.y);this._gridBounds=this._markerGroup._getExtendedBounds(this._map,a,this._markerGroup.getGridSize())},_isMarkerInGroupBounds:function(a){return this._gridBounds.contains(a.getPosition())},_remove:function(){this._map.removeOverlays(this._groupMarker),this._markers.length=0},_getCenter:function(){return this._center},_isReal:function(){return this._isReal}}),NMarkerGroup=NClass.extend({includes:NEWMAP_JS_LIB.PublicParts.Events,initialize:function(a,b){this._map=a,this.options=NUtil.extend({},NMarkerGroupOptions,b),this._markers=[],this._groups=[];if(this._isArray(this.options.markers))for(var c=this.options.markers.length-1;c>=0;c--)this._pushMarkerTo(this.options.markers[c]);else this._pushMarkerTo(this.options.markers);this._redraw(),this._map.on("zoomend",this._redraw,this),this._map.on("moveend",this._redraw,this)},_isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)},_indexOf:function(a,b){var c=-1;if(b.indexOf)c=b.indexOf(a);else for(var d=0,e;e=b[d];d++)if(e===a){c=d;break}return c},_getExtendedBounds:function(a,b,c){var d=a.getMaxExtent(),e,f;if(!d.contains(b)){var g=Math.max(b.getLowerPoint().x,d.getLowerPoint().x),h=Math.max(b.getLowerPoint().y,d.getLowerPoint().y),i=Math.min(b.getUpperPoint().x,d.getUpperPoint().x),j=Math.min(b.getUpperPoint().y,d.getUpperPoint().y);b=new NBounds(g,h,i,j)}e=a.pointToPixel(b.getLowerPoint()),f=a.pointToPixel(b.getUpperPoint()),e.x-=c,e.y+=c,f.x+=c,f.y-=c;var k=a.pixelToPoint(e),l=a.pixelToPoint(f);return new NBounds(k.x,k.y,l.x,l.y)},_pushMarkerTo:function(a){var b=this._indexOf(a,this._markers);b===-1&&(a.isInGroup=!1,this._markers.push(a))},_redraw:function(){if(this._groups.length!==0||this._markers.length!==0){for(var a=this._groups.length-1;a>=0;a--)this._groups[a]._remove();this._groups.length=0;for(var b=this._markers.length-1;b>=0;b--)this._markers[b].isInGroup=!1}var c=this._map.getExtent(),d=this._getExtendedBounds(this._map,c,this.options.gridSize),e,f,g,h,i;for(var j=this._markers.length-1;j>=0;j--){e=null,e=this._markers[j].getPosition();if(!this._markers[j].isInGroup&&d.contains(e)){f=4e6,g=null;for(var k=this._groups.length-1;k>=0;k--)h=null,h=this._groups[k]._getCenter(),h&&(i=h.distanceTo(e),i<f&&(f=i,g=this._groups[k]));if(g&&g._isMarkerInGroupBounds(this._markers[j]))g._addMarker(this._markers[j]);else{var l=new NGroup(this);l._addMarker(this._markers[j]),this._groups.push(l)}}}},addMarker:function(a){this._pushMarkerTo(a),this._redraw()},addMarkers:function(a){for(var b=a.length-1;b>=0;b--)this._pushMarkerTo(a[b]);this._redraw()},_removeMarker:function(a){var b=this._indexOf(a,this._markers);return b===-1?!1:(this._markers.splice(b,1),!0)},removeMarker:function(a){var b=this._removeMarker(a);return b&&this._redraw(),b},removeMarkers:function(a){var b=!1;while(a.length){var c=this._removeMarker(a[0]);a.splice(0,1),b=b||c}return b&&this._redraw(),b},getGridSize:function(){return this.options.gridSize},setGridSize:function(a){this.options.gridSize=a,this._redraw()},getMaxZoom:function(){return this.options.maxZoom},setMaxZoom:function(a){this.options.maxZoom=a,this._redraw()},getMinGroupSize:function(){return this.options.minGroupSize},setMinGroupSize:function(a){this.options.minGroupSize=a,this._redraw()},getMap:function(){return this._map},isAverageCenter:function(){return this.options.AverageCenter},getMarkers:function(){return this.options.markers},getStyle:function(){return this.options.style},setStyle:function(a){this.options.style=a,this._redraw()},getGroupCount:function(){var a=0;for(var b=0,c=this._groups.length;b<c;b++)this._groups[b]._isReal()&&(a+=1);return a}}),NMarkerGroupOptions={markers:[],gridSize:60,maxZoom:16,minGroupSize:2,AverageCenter:!1,style:{autoStyle:!0}},NRichMarker=NOverlay.extend({includes:NEWMAP_JS_LIB.PublicParts.Events,options:{visible:!0,popable:!0,clickable:!0,draggable:!1,zIndexOffset:0},initialize:function(a,b,c){this.options=NUtil.extend({},NRichMarkerOptions,c),this._latlng=a,this._content=b,this._container=NUtil.create("div","newmap-marker-span")},getPosition:function(){return this._latlng},setPosition:function(a){this._latlng=a,this._content&&this._draw()},getContent:function(){return this._content},setContent:function(a){this._content=a,this._appendContent()},getMarkerSize:function(){return this.options.markerSize},setMarkerSize:function(a){this.options.markerSize=a,this._update()},getAnchor:function(){return this.options.markerAnchor},setAnchor:function(a){this.options.markerAnchor=a,this._update()},getBackground:function(){return this.options.background},setBackground:function(a){this.options.background=a,this._update()},getVisible:function(){return this.options.visible},setVisible:function(a){a=a?!0:!1;var b=a?"block":"none";if(this.options.visible===a)return;this.options.visible=a,this._container&&(this._container.style.display=b)},enableDrag:function(){return this._map?(NElement.Drag&&(this.options.draggable=this.draggable=!0,this.dragging||(this.dragging=new NElement.Drag(this)),this.dragging.enable()),this):(this.options.draggable=this.draggable=!0,this)},disableDrag:function(){return this._map?(this.options.draggable=this.draggable=!1,this.dragging&&this.dragging.disable(),this):(this.options.draggable=this.draggable=!1,this)},enablePop:function(){this.options.popable=!0,this.on("mouseover",this._onMouseOver,this),this.on("mouseout",this._onMouseOut,this)},disablePop:function(){this._pushToBack(),this.options.popable=!1,this.off("mouseover",this._onMouseOver),this.off("mouseout",this._onMouseOut)},bringToFront:function(){this._popToFront()},_initMarker:function(){this._appendContent(),this._initInteraction(),this._map._panes.markerPane.appendChild(this._container),this._draw(),this._update()},_appendContent:function(){var a=this._content;if(typeof a=="string"){var b=NUtil.create("div");b.innerHTML=a;if(b.childNodes.length===1)a=b.removeChild(b.firstChild);else{var c=document.createDocumentFragment();while(b.firstChild)c.appendChild(b.firstChild);a=c}}NUtil.clearAllNode(this._container),this._container.appendChild(a)},_draw:function(){var a=this._map._pointToAbsPixel(this._latlng).round();NUtil.setPosition(this._container,a)},_update:function(){var a=this.options.markerSize,b=this.options.markerAnchor;this._container&&(this._container.style.marginLeft=-b.x+"px",this._container.style.marginTop=-b.y+"px",this._container.style.width=a.x+"px",this._container.style.height=a.y+"px",this._container.style.background=this.options.background)},_setMap:function(a){this._map=a,this._initMarker(),a.on("viewreset",this._draw,this)},_unsetMap:function(a){a=a||this._map,this._removeMarker(),a.off("viewreset",this._draw,this),this._map=null},_removeMarker:function(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container)},_getDragTarget:function(){return this._container},_onDragUpdate:function(a){this._latlng=a.point},_getMoveTarget:function(){return this._container},_onMouseOver:function(a){NEvent.stopPropagation(a);if(this.dragging&&this.dragging.moved())return;this.options.popable&&this._popToFront()},_onMouseOut:function(a){NEvent.stopPropagation(a);if(this.dragging&&this.dragging.moved())return;this.options.popable&&this._pushToBack()},_popToFront:function(){this._poped=!0;var a=this._container;if(!a)return;a.style.zIndex=NUtil.MaxZIndex},_pushToBack:function(){this._poped=!1;var a=this._container;if(!a)return;isNaN(this.options.zIndexOffset)?a.style.zIndex="auto":a.style.zIndex=this.options.zIndexOffset},_initInteraction:function(){if(this.options.clickable){this._container.className+=" newmap-clickable",NEvent.addListener(this._container,"click",this._onMouseClick,this);var a=["dblclick","mousedown","mouseover","mouseout"];for(var b=0;b<a.length;b++)NEvent.addListener(this._container,a[b],this._fireMouseEvent,this)}this.options.popable&&this.enablePop(),this.options.draggable&&this.enableDrag()},_onMouseClick:function(a){if(this._map.getHegemonTag())return;NEvent.stopPropagation(a);if(this.dragging&&this.dragging.moved())return;this.fire(a.type,{originalEvent:a})},_fireMouseEvent:function(a){if(!this._map||this._map.getHegemonTag())return;this.fire(a.type,{originalEvent:a}),NEvent.stopPropagation(a)}}),NRichMarkerOptions={markerSize:new NXY(0,0),markerAnchor:new NXY(0,0),background:"",visible:!0,popable:!0,clickable:!0,draggable:!1},NParser.GML=NParser.XML.extend({_featurens:"http://mapserver.gis.umn.edu/mapserver",featurePrefix:"feature",featureName:"featureMember",layerName:"features",geometryName:"geometry",collectionName:"FeatureCollection",gmlns:"http://www.opengis.net/gml",getAttributes:!0,xy:!0,initialize:function(a){this.regExes={trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},NParser.XML.prototype.initialize.apply(this,[a]);for(key in a)a.hasOwnProperty(key)&&key=="getAttributes"&&(this.getAttributes=a[key])},read:function(a){typeof a=="string"&&(a=NParser.XML.prototype.read.apply(this,[a]));var b=this.getElementsByTagNameNS(a.documentElement,this.gmlns,this.featureName),c=[];for(var d=0;d<b.length;d++){var e=this.parseFeature(b[d]);e&&c.push(e)}return c},parseFeature:function(a){var b=["MultiPolygon","Polygon","MultiLineString","LineString","MultiPoint","Point"],c,d,e,f;for(var g=0;g<b.length;++g){c=b[g],d=this.getElementsByTagNameNS(a,this.gmlns,c);if(d.length>0){var f=this.parseGeometry[c.toLowerCase()];f?(e=f.apply(this,[d[0]]),!this.internalProjection||!this.externalProjection):NLog.error(NMGISLG("unsupportedGeometryType",{geomType:c}));break}}var h;this.getAttributes&&(h=this.parseAttributes(a));var i=new NFeature(e,h);i._layerFlag=!0,i.gml={featureType:a.firstChild.nodeName.split(":")[1],_featurens:a.firstChild.namespaceURI,featureNSPrefix:a.firstChild.prefix};var j=a.firstChild,k;while(j){if(j.nodeType==1){k=j.getAttribute("fid")||j.getAttribute("id");if(k)break}j=j.nextSibling}return i.fid=k,i},parseGeometry:{point:function(a){var b,c,d=[],b=this.getElementsByTagNameNS(a,this.gmlns,"pos");b.length>0&&(c=b[0].firstChild.nodeValue,c=c.replace(this.regExes.trimSpace,""),d=c.split(this.regExes.splitSpace)),d.length==0&&(b=this.getElementsByTagNameNS(a,this.gmlns,"coordinates"),b.length>0&&(c=b[0].firstChild.nodeValue,c=c.replace(this.regExes.removeSpace,""),d=c.split(",")));if(d.length==0){b=this.getElementsByTagNameNS(a,this.gmlns,"coord");if(b.length>0){var e=this.getElementsByTagNameNS(b[0],this.gmlns,"X"),f=this.getElementsByTagNameNS(b[0],this.gmlns,"Y");e.length>0&&f.length>0&&(d=[e[0].firstChild.nodeValue,f[0].firstChild.nodeValue])}}return d.length==2&&(d[2]=null),this.xy?new NPoint(new NXY(d[0],d[1])):new NPoint(new NXY(d[1],d[0]))},multipoint:function(a){var b=this.getElementsByTagNameNS(a,this.gmlns,"Point"),c=[];if(b.length>0){var d;for(var e=0;e<b.length;++e)d=this.parseGeometry.point.apply(this,[b[e]]),d&&c.push(d._latlng)}return new NMultiPoint(c)},linestring:function(a,b){var c,d,e=[],f=[];c=this.getElementsByTagNameNS(a,this.gmlns,"posList");if(c.length>0){d=this.concatChildValues(c[0]),d=d.replace(this.regExes.trimSpace,""),e=d.split(this.regExes.splitSpace);var g=c[0].getAttribute("dimension");if(g==null||g==undefined)g=c[0].getAttribute("srsDimension");var h=parseInt(g),i,j,k,l;for(var m=0;m<e.length/h;++m)i=m*h,j=e[i],k=e[i+1],l=h==2?null:e[i+2],this.xy?f.push(new NXY(j,k)):f.push(new NXY(k,j))}if(e.length==0){c=this.getElementsByTagNameNS(a,this.gmlns,"coordinates");if(c.length>0){d=this.concatChildValues(c[0]),d=d.replace(this.regExes.trimSpace,""),d=d.replace(this.regExes.trimComma,",");var n=d.split(this.regExes.splitSpace);for(var m=0;m<n.length;++m)e=n[m].split(","),e.length==2&&(e[2]=null),this.xy?f.push(new NXY(e[0],e[1])):f.push(new NXY(e[1],e[0]))}}var o=null;return f.length!=0&&(b?o=new NPolyline(f):o=new NPolyline(f)),o},multilinestring:function(a){var b=this.getElementsByTagNameNS(a,this.gmlns,"LineString"),c=[];if(b.length>0){var d;for(var e=0;e<b.length;++e)d=this.parseGeometry.linestring.apply(this,[b[e]]),d&&c.push(d)}return new NMultiPolyline(c)},polygon:function(a){var b=this.getElementsByTagNameNS(a,this.gmlns,"LinearRing"),c=[];if(b.length>0){var d;for(var e=0;e<b.length;++e){d=this.parseGeometry.linestring.apply(this,[b[e],!0]);if(d)return new NPolygon(d._points)}}return new NPolygon(c)},multipolygon:function(a){var b=this.getElementsByTagNameNS(a,this.gmlns,"Polygon"),c=[];if(b.length>0){var d;for(var e=0;e<b.length;++e)d=this.parseGeometry.polygon.apply(this,[b[e]]),d&&c.push(d)}return new NMultiPolygon(c)}},parseAttributes:function(a){var b={},c=a.firstChild,d,e,f,g,h,i,j;while(c){if(c.nodeType==1){d=c.childNodes;for(e=0;e<d.length;++e){f=d[e];if(f.nodeType==1){g=f.childNodes;if(g.length==1){h=g[0];if(h.nodeType==3||h.nodeType==4)i=f.prefix?f.nodeName.split(":")[1]:f.nodeName,j=h.nodeValue.replace(this.regExes.trimSpace,""),b[i]=j}}}break}c=c.nextSibling}return b}});